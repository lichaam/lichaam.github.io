    <!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>EPhone</title>
<script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* ===== è‡ªå®šä¹‰å­—ä½“å®šä¹‰ ===== */
@font-face { 
font-family: 'bulangni'; 
src: url('https://files.catbx.moe/yzfk0h.ttf') format('truetype'); 
font-weight: normal; 
font-style: normal; 
font-display: swap; 
}

/* ===== CSSå˜é‡å®šä¹‰ ===== */
:root { 
--screen-width: 350px;
--screen-height: 740px;
--secondary-bg: #ffffff;
--border-color: #e0e0e0;
--text-primary: #1f1f1f;
--text-secondary: #8a8a8a;
--accent-color: #007bff;
}

/* ===== åŸºç¡€HTMLå’ŒBodyæ ·å¼ ===== */
html { 
height: 100%; 
overflow: hidden;
}
body { 
height: 100%; 
overflow: hidden; 
margin: 0; 
padding: 20px; 
font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
font-weight: normal; 
background-color: #dcdcdc;
display: flex; 
justify-content: center; 
align-items: center; 
box-sizing: border-box; 
}

/* ===== æ‰‹æœºå¤–æ¡†æ ·å¼ ===== */
#phone-frame { 
padding: 12px; 
background-color: #fff;
border-radius: 50px;
box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1);
position: relative; 
}       

/* ===== æ‰‹æœºé¡¶éƒ¨åˆ˜æµ·å±æ ·å¼ ===== */
.notch { 
position: absolute; 
top: 12px; 
left: 50%; 
transform: translateX(-50%); 
width: 130px; 
height: 28px; 
background-color: #1f1f1f;
border-radius: 0 0 15px 15px;
z-index: 20; 
}

/* ===== æ‰‹æœºå±å¹•ä¸»ä½“æ ·å¼ ===== */
#phone-screen { 
width: var(--screen-width); 
height: var(--screen-height); 
background-color: #000;
border-radius: 40px; 
position: relative; 
overflow: hidden; 
display: flex; 
flex-direction: column; 
border: 2px solid #333;
}

/* ===== çŠ¶æ€æ æ ·å¼ ===== */
#status-bar { 
position: absolute; 
top: 0; 
left: 0; 
width: 100%; 
padding: 12px 20px; 
display: flex; 
justify-content: space-between; 
align-items: center; 
color: white;
z-index: 10; 
font-size: 14px; 
box-sizing: border-box; 
pointer-events: none; 
}
#status-bar-time { 
font-weight: 600; 
}

/* ===== ç”µæ± å›¾æ ‡å’Œå……ç”µåŠ¨ç”»æ ·å¼ ===== */
.battery-container { 
display: flex; 
align-items: center; 
gap: 5px; 
}
.battery-icon { 
width: 25px; 
height: 12px; 
border: 1px solid white;
border-radius: 3px; 
position: relative; 
padding: 1px; 
}
.battery-icon::after {
content: ''; 
position: absolute; 
right: -3px; 
top: 2px; 
width: 2px; 
height: 6px; 
background-color: white;
border-radius: 0 1px 1px 0; 
}
.battery-level { 
height: 100%; 
background-color: white;
border-radius: 1px; 
transition: width 0.5s ease; 
}
.battery-container.charging .battery-level { 
background-color: #4cd964;
animation: charge-breath 2s infinite; 
}
.battery-container.charging .battery-text { 
color: #4cd964;
}
@keyframes charge-breath {
0%, 100% { opacity: 1; } 
50% { opacity: 0.7; } 
}

/* ===== å±å¹•é¡µé¢åˆ‡æ¢åŸºç¡€æ ·å¼ ===== */
.screen { 
width: 100%; 
height: 100%; 
position: absolute; 
top: 0; 
left: 0; 
display: flex; 
flex-direction: column; 
overflow: hidden; 
opacity: 0; 
visibility: hidden; 
transition: opacity 0.3s, visibility 0.3s; 
}
.screen.active { 
opacity: 1; 
visibility: visible; 
z-index: 1; 
}

/* ===== é¡µé¢é¡¶éƒ¨æ ‡é¢˜æ æ ·å¼ ===== */
.header { 
position: relative; 
z-index: 15; 
flex-shrink: 0; 
padding: 15px 20px; 
padding-top: 45px;
background-color: rgba(247, 247, 247, 0.8);
backdrop-filter: blur(10px); 
-webkit-backdrop-filter: blur(10px); 
border-bottom: 1px solid var(--border-color);
display: flex; 
justify-content: space-between; 
align-items: center; 
font-size: 18px; 
font-weight: 600; 
}
.header .header-actions { 
display: flex; 
align-items: center; 
gap: 15px; 
}
.header .header-actions .default-controls { 
display: flex; 
align-items: center; 
gap: 0px; 
}
.header .back-btn, .header .action-btn { 
font-size: 24px; 
cursor: pointer; 
width: 30px; 
text-align: center; 
color: var(--accent-color);
display: flex; 
align-items: center; 
justify-content: center; 
}
.header .action-btn img { 
height: 26px; 
}
.header .save-btn { 
font-size: 16px; 
color: var(--accent-color);
font-weight: 600; 
cursor: pointer; 
}

/* ===== ä¸»å±å¹•æ ·å¼ ===== */
#home-screen { 
display: flex; 
flex-direction: column; 
justify-content: flex-start; 
align-items: center; 
padding: 20px; 
padding-top: 80px;
padding-bottom: 50px; 
box-sizing: border-box; 
background-size: cover; 
background-position: center; 
}

/* ===== ä¸»å±å¹•æ—¶é’Ÿæ˜¾ç¤ºæ ·å¼ ===== */
#clock-container { 
text-align: center; 
color: white;
text-shadow: 0 3px 8px rgba(0,0,0,0.4);
margin-bottom: 20px; 
flex-shrink: 0; 
}
#main-time { 
font-size: 80px; 
font-weight: 200; 
}
#main-date { 
font-size: 18px; 
font-weight: 500; 
}

/* ===== åº”ç”¨å›¾æ ‡ç½‘æ ¼å¸ƒå±€æ ·å¼ ===== */
#app-grid { 
margin-top: auto; 
display: flex; 
flex-direction: column; 
align-items: center; 
gap: 20px; 
width: 100%; 
padding: 20px; 
}
.app-row { 
display: flex; 
justify-content: center; 
gap: 25px; 
width: 100%; 
}

/* ===== å•ä¸ªåº”ç”¨å›¾æ ‡æ ·å¼ ===== */
.app-icon { 
display: flex; 
flex-direction: column; 
align-items: center; 
cursor: pointer; 
color: white;
text-shadow: 0 1px 3px rgba(0,0,0,0.5); 
font-size: 14px; 
font-weight: 500; 
text-align: center; 
}
.app-icon .icon-bg { 
width: 65px; 
height: 65px; 
border-radius: 18px; 
background-color: var(--secondary-bg);
display: flex; 
justify-content: center; 
align-items: center; 
font-size: 32px; 
margin-bottom: 8px; 
box-shadow: 0 4px 8px rgba(0,0,0,0.15); 
transition: transform 0.2s ease; 
overflow: hidden; 
}
.app-icon:active .icon-bg { 
transform: scale(0.9);
}
.app-icon .icon-bg img { 
width: 100%; 
height: 100%; 
object-fit: cover; 
}
.app-icon .label { 
color: white;
}

/* ===== è¡¨å•å®¹å™¨å’Œåˆ—è¡¨å®¹å™¨é€šç”¨æ ·å¼ ===== */
.form-container, .list-container { 
padding: 20px; 
overflow-y: auto; 
flex-grow: 1; 
display:flex; 
flex-direction: column; 
}

/* ===== è¡¨å•ç»„ä»¶æ ·å¼ ===== */
.form-group { 
margin-bottom: 20px; 
}
.form-group label { 
display: block; 
margin-bottom: 8px; 
font-weight: 500; 
color: var(--text-secondary);
}
.form-group input, .form-group select, .form-group textarea { 
width: 100%; 
padding: 12px; 
border: 1px solid var(--border-color);
border-radius: 8px; 
font-size: 16px; 
box-sizing: border-box; 
}
.form-group textarea { 
min-height: 80px; 
resize: vertical; 
}
#world-book-content-input { 
height: calc(100% - 120px); 
}

/* ===== è¡¨å•æŒ‰é’®æ ·å¼ ===== */
.form-button { 
width: 100%; 
padding: 15px; 
background-color: var(--accent-color);
color: white;
border: none; 
border-radius: 8px; 
font-size: 16px; 
font-weight: 600; 
cursor: pointer; 
margin-top: 10px; 
}
.form-button-secondary { 
background-color: #f0f0f0;
color: var(--text-primary);
border: 1px solid var(--border-color); 
}

/* ===== å£çº¸è®¾ç½®é¡µé¢æ ·å¼ ===== */
#wallpaper-screen .form-container { 
align-items: center; 
}
#wallpaper-preview { 
width: 180px; 
height: 320px; 
border: 2px dashed var(--border-color);
background-color: #f0f2f5;
margin-bottom: 20px; 
background-size: cover; 
background-position: center; 
border-radius: 10px; 
display: flex; 
justify-content: center; 
align-items: center; 
color: var(--text-secondary);
}
#wallpaper-upload-input { 
display: none; 
}

/* ===== èŠå¤©åˆ—è¡¨å’Œä¸–ç•Œä¹¦åˆ—è¡¨æ ·å¼ ===== */
#chat-list, #world-book-list { 
flex-grow: 1; 
overflow-y: auto; 
background-color: var(--secondary-bg);
padding-top: 80px; 
margin-top: -80px; 
}

/* ===== é€šç”¨åˆ—è¡¨é¡¹æ ·å¼ ===== */
.list-item { 
display: flex; 
flex-direction: column; 
padding: 12px 20px; 
cursor: pointer; 
border-bottom: 1px solid var(--border-color);
}
.list-item:hover { 
background-color: #f5f5f5;
}
.list-item .item-title { 
font-weight: 500; 
font-size: 16px; 
margin-bottom: 5px; 
}
.list-item .item-content { 
font-size: 14px; 
color: var(--text-secondary);
white-space: nowrap; 
overflow: hidden; 
text-overflow: ellipsis; 
}

/* ===== èŠå¤©åˆ—è¡¨é¡¹æ ·å¼ ===== */
.chat-list-item { 
display: flex; 
align-items: center; 
padding: 10px 15px; 
cursor: pointer; 
border-bottom: 1px solid var(--border-color); 
position: relative; 
}
.chat-list-item:hover { 
background-color: #f5f5f5;
}
.chat-list-item .avatar { 
width: 45px; 
height: 45px; 
border-radius: 50%; 
margin-right: 12px; 
object-fit: cover; 
background-color: #ccc;
}
.chat-list-item .info { 
flex-grow: 1; 
overflow: hidden; 
}
.chat-list-item .name-line { 
display: flex; 
align-items: center; 
gap: 6px; 
margin-bottom: 2px; 
}
.chat-list-item .name { 
font-weight: 500; 
color: var(--text-primary);
}
.chat-list-item .group-tag { 
font-size: 10px; 
color: var(--accent-color);
background-color: #e7f3ff;
padding: 2px 6px; 
border-radius: 4px; 
font-weight: bold; 
flex-shrink: 0; 
}
.chat-list-item .last-msg { 
font-size: 13px; 
color: var(--text-secondary);
white-space: nowrap; 
overflow: hidden; 
text-overflow: ellipsis; 
max-width: 180px; 
}

/* ===== èŠå¤©ç•Œé¢æ ·å¼ ===== */
#chat-interface-screen { 
background-size: cover; 
background-position: center; 
position: relative; 
}

/* ===== èŠå¤©ç•Œé¢é€‰æ‹©æ¨¡å¼æ§åˆ¶ ===== */
#chat-interface-screen .header .default-controls, 
#chat-interface-screen .header .selection-controls { 
display: contents; 
}
#chat-interface-screen.selection-mode .default-controls { 
display: none; 
}
#chat-interface-screen:not(.selection-mode) .selection-controls { 
display: none; 
}
#selection-cancel-btn, #selection-delete-btn { 
font-size: 16px; 
color: var(--accent-color);
cursor: pointer; 
padding: 5px; 
}
#selection-delete-btn { 
color: #ff3b30;
}

/* ===== èŠå¤©æ¶ˆæ¯åŒºåŸŸæ ·å¼ ===== */
#chat-messages {
flex-grow: 1;
overflow-y: auto;
padding: 10px;
padding-top: 110px;
margin-top: -80px;
display: flex;
flex-direction: column;
gap: 30px; 
}

/* ===== åŠ è½½æ›´å¤šæŒ‰é’®æ ·å¼ ===== */
#load-more-btn { 
text-align: center; 
padding: 10px; 
color: var(--accent-color);
font-size: 14px; 
cursor: pointer; 
background-color: transparent; 
border: none; 
width: 100%; 
}
#load-more-btn:hover { 
text-decoration: underline; 
}
#show-more-btn:hover { 
text-decoration: underline; 
}

/* ===== å¿«é€Ÿå›åˆ°åº•éƒ¨æŒ‰é’®æ ·å¼ ===== */
#scroll-to-bottom-btn {
position: absolute;
bottom: 80px;
right: 15px;
width: 40px;
height: 40px;
border-radius: 50%;
background-color: var(--accent-color);
color: white;
border: none;
font-size: 16px;
cursor: pointer;
box-shadow: 0 2px 8px rgba(0,0,0,0.2);
z-index: 10;
opacity: 0;
visibility: hidden;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
}

#scroll-to-bottom-btn.visible {
opacity: 1;
visibility: visible;
}

#scroll-to-bottom-btn:hover {
background-color: #0056b3;
transform: scale(1.1);
}

#scroll-to-bottom-btn:active {
transform: scale(0.95);
}

/* ===== éšè—æ‰€æœ‰æ»šåŠ¨æ¡ ===== */
* {
scrollbar-width: none;
-ms-overflow-style: none;
}

*::-webkit-scrollbar {
display: none;
}

#chat-messages::-webkit-scrollbar,
#chat-list::-webkit-scrollbar,
#world-book-list::-webkit-scrollbar,
.form-container::-webkit-scrollbar,
.list-container::-webkit-scrollbar,
.modal-body::-webkit-scrollbar,
.checkboxes-container::-webkit-scrollbar,
.playlist-body::-webkit-scrollbar,
.frame-content::-webkit-scrollbar {
display: none;
}

#chat-messages,
#chat-list,
#world-book-list,
.form-container,
.list-container,
.modal-body,
.checkboxes-container,
.playlist-body,
.frame-content {
scrollbar-width: none;
-ms-overflow-style: none;
}

/* ===== æ¶ˆæ¯æ°”æ³¡åŒ…è£…å™¨æ ·å¼ ===== */
.message-wrapper { 
display: flex; 
flex-direction: column; 
max-width: 85%; 
}
.message-wrapper.user {
align-self: flex-end;
align-items: flex-end;
margin-right: 1px; 
}
.message-wrapper.ai { 
align-self: flex-start;
align-items: flex-start; 
}

/* ===== å‘é€è€…åç§°æ ·å¼ ===== */
.sender-name { 
font-size: 11px; 
color: #666;
margin-bottom: 3px; 
}
.message-wrapper.ai .sender-name { 
margin-left: 60px; 
}

/* ===== æ¶ˆæ¯æ°”æ³¡ä¸»ä½“æ ·å¼ ===== */
.message-bubble { 
display: flex; 
align-items: flex-start; 
gap: 19px; 
position: relative; 
width: -webkit-fit-content; 
width: -moz-fit-content; 
width: fit-content; 
max-width: 100%; 
}

/* ===== æ¶ˆæ¯è¢«é€‰ä¸­æ—¶çš„å‹¾é€‰æ ‡è®° ===== */
.message-bubble.selected::after { 
content: 'âœ”'; 
position: absolute; 
left: -10px; 
top: 50%; 
transform: translateY(-50%); 
background-color: var(--accent-color);
color: white;
width: 20px; 
height: 20px; 
border-radius: 50%; 
display: flex; 
align-items: center; 
justify-content: center; 
font-size: 12px; 
}

/* ===== ä¸–ç•Œä¹¦é€‰æ‹©æ¨¡å¼æ ·å¼ ===== */
#world-book-screen.selection-mode .default-controls { 
display: none; 
}
#world-book-screen:not(.selection-mode) .selection-controls { 
display: none !important; 
}
#world-book-screen.selection-mode .selection-controls { 
display: contents !important; 
}

/* ===== ä¸–ç•Œä¹¦æ–‡ä»¶å¤¹æ ·å¼ ===== */
.world-book-folder { 
background-color: #f8f9fa;
border-left: 3px solid var(--accent-color);
margin-bottom: 10px; 
}
.world-book-folder .folder-header { 
padding: 15px 20px; 
font-weight: 600; 
display: flex; 
justify-content: space-between; 
align-items: center; 
cursor: pointer; 
border-bottom: 1px solid var(--border-color); 
}
.world-book-folder .folder-toggle { 
font-size: 12px; 
transition: transform 0.2s; 
}
.world-book-folder.collapsed .folder-toggle { 
transform: rotate(-90deg); 
}
.world-book-folder .folder-items { 
display: block; 
}
.world-book-folder.collapsed .folder-items { 
display: none; 
}

/* ===== åˆ—è¡¨é¡¹é€‰ä¸­çŠ¶æ€æ ·å¼ ===== */
.list-item.selected { 
background-color: rgba(0, 123, 255, 0.1);
border-left: 3px solid var(--accent-color);
}
.list-item.selected::after { 
content: 'âœ”'; 
position: absolute; 
right: 15px; 
top: 50%; 
transform: translateY(-50%); 
background-color: var(--accent-color);
color: white; 
width: 20px; 
height: 20px; 
border-radius: 50%; 
display: flex; 
align-items: center; 
justify-content: center; 
font-size: 12px; 
}

/* ===== ç”¨æˆ·æ¶ˆæ¯æ°”æ³¡é€‰ä¸­æ ‡è®°ä½ç½®è°ƒæ•´ ===== */
.message-bubble.user.selected::after { 
left: auto; 
right: -10px; 
}

/* ===== æ¶ˆæ¯ä¸­çš„å¤´åƒç»„æ ·å¼ ===== */
.avatar-group { 
display: flex; 
flex-direction: column; 
align-items: center; 
gap: 5px; 
flex-shrink: 0; 
width: 35px;
margin-top: -10px; 
}
.message-bubble .avatar { 
width: 34px; 
height: 34px; 
border-radius: 50%; 
object-fit: cover; 
}

/* ===== æ¶ˆæ¯æ—¶é—´æˆ³æ ·å¼ ===== */
.timestamp { 
font-size: 9px; 
color: #b0b0b0;
white-space: nowrap; 
margin-bottom: 5px;
}

/* ===== æ°”æ³¡å’Œæ—¶é—´æˆ³å®¹å™¨æ ·å¼ ===== */
.bubble-and-time-container {
display: flex;
align-items: flex-end; 
gap: 8px; 
max-width: 100%; 
}

.message-wrapper.user .bubble-and-time-container {
flex-direction: row-reverse;
}

/* ===== æ¶ˆæ¯å†…å®¹æ ·å¼ ===== */
.message-bubble .content { 
padding: 6px 10px; 
word-break: break-word; 
line-height: 1.3; 
font-size: 13px; 
position: relative; 
backdrop-filter: blur(5px); 
-webkit-backdrop-filter: blur(5px); 
box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0), 0 3px 6px rgba(0,0,0,0); 
border: 0px solid rgba(255, 255, 255, 0.2); 
transition: background-color 0.3s, color 0.3s; 
}
.message-bubble.user { 
flex-direction: row-reverse; 
}

/* ===== æ­£åœ¨è¾“å…¥æç¤ºæ ·å¼ ===== */
#typing-indicator { 
align-self: flex-start; 
display: none; 
margin: 0 10px 10px; 
color: var(--text-secondary);
}

/* ===== èŠå¤©è¾“å…¥åŒºåŸŸæ ·å¼ ===== */
#chat-input-area { 
flex-shrink: 0; 
padding: 8px; 
background-color: rgba(247, 247, 247, 0.8);
backdrop-filter: blur(10px); 
-webkit-backdrop-filter: blur(10px); 
border-top: 1px solid var(--border-color);
display: flex; 
flex-direction: column; 
gap: 5px; 
}
#chat-input-main-row { 
display: flex; 
align-items: flex-end; 
gap: 8px; 
width: 100%; 
}
#chat-input { 
flex-grow: 1; 
border: none; 
padding: 10px 15px; 
border-radius: 20px; 
background-color: var(--secondary-bg);
font-size: 16px; 
max-height: 100px; 
resize: none; 
}

/* ===== èŠå¤©æ“ä½œæŒ‰é’®æ ·å¼ ===== */
.action-button { 
border: none; 
color: white; 
border-radius: 20px; 
cursor: pointer; 
font-weight: 600; 
font-size: 14px; 
flex-shrink: 0; 
}
#send-btn { 
background-color: var(--accent-color);
height: 40px; 
padding: 0 15px;
}

/* ===== æ¨¡æ€æ¡†é€šç”¨æ ·å¼ ===== */
.modal { 
position: absolute; 
top: 0; 
left: 0; 
width: 100%; 
height: 100%; 
background-color: rgba(0,0,0,0.4);
display: none; 
justify-content: center; 
align-items: center; 
z-index: 100; 
}
.modal.visible { 
display: flex; 
}
.modal-content { 
width: 90%; 
max-height: 90%; 
background-color: white;
border-radius: 15px; 
display: flex; 
flex-direction: column; 
}
.modal-header { 
padding: 15px; 
font-weight: 600; 
border-bottom: 1px solid var(--border-color); 
text-align: center; 
display: flex; 
justify-content: space-between; 
align-items: center; 
}
.modal-body { 
padding: 15px; 
overflow-y: auto; 
}
.modal-footer { 
padding: 15px; 
border-top: 1px solid var(--border-color); 
display: flex; 
justify-content: space-around; 
}
.modal-footer button { 
width: 45%; 
padding: 12px; 
border-radius: 8px; 
border: 1px solid var(--accent-color); 
cursor: pointer; 
font-size: 16px; 
}
.modal-footer .save { 
background-color: var(--accent-color);
color: white; 
}
.modal-footer .cancel { 
background-color: white; 
color: var(--accent-color);
}

/* ===== å¤´åƒä¸Šä¼ ç»„ä»¶æ ·å¼ ===== */
.avatar-upload { 
display: flex; 
align-items: center; 
gap: 15px; 
}
.avatar-upload img { 
width: 60px; 
height: 60px; 
border-radius: 50%; 
object-fit: cover; 
background-color: #eee;
}
.avatar-upload button { 
padding: 8px 12px; 
border: 1px solid #ccc;
background-color: #f0f0f0;
border-radius: 5px; 
cursor: pointer; 
}
#open-persona-library-btn { 
font-size: 14px; 
padding: 6px 10px; 
margin-left: auto; 
}
.avatar-upload input[type="file"] { 
display: none; 
}

/* ===== ä¸»é¢˜é€‰æ‹©å™¨æ ·å¼ ===== */
.theme-selector label { 
display: inline-flex; 
align-items: center; 
margin-right: 15px; 
margin-bottom: 5px; 
cursor: pointer; 
}
#reset-theme-btn { 
background: none; 
border: 1px solid #ccc; 
color: #555;
font-size: 12px; 
padding: 2px 8px; 
border-radius: 5px; 
cursor: pointer; 
margin-left: 10px; 
}

/* ===== ç¾¤æˆå‘˜è®¾ç½®æ ·å¼ ===== */
#group-members-settings { 
display: flex; 
overflow-x: auto; 
padding-bottom: 10px; 
gap: 15px; 
}
.member-editor { 
text-align: center; 
cursor: pointer; 
}
.member-editor img { 
width: 50px; 
height: 50px; 
border-radius: 50%; 
object-fit: cover; 
background-color: #eee; 
margin-bottom: 5px; 
}
.member-editor .member-name { 
font-size: 12px; 
}

/* ===== é€šçŸ¥æ æ ·å¼ ===== */
#notification-bar { 
position: absolute; 
top: 40px; 
left: 5%; 
width: 90%; 
z-index: 500; 
background-color: rgba(250, 250, 250, 0.9);
backdrop-filter: blur(10px); 
-webkit-backdrop-filter: blur(10px); 
border-radius: 16px; 
padding: 10px; 
box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
display: flex; 
align-items: center; 
gap: 12px; 
cursor: pointer; 
transform: translateY(-150%); 
transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
visibility: hidden; 
}
#notification-bar.visible { 
transform: translateY(0); 
visibility: visible; 
}
#notification-avatar { 
width: 30px; 
height: 30px; 
border-radius: 50%; 
object-fit: cover; 
}
#notification-content .name { 
font-weight: 600; 
font-size: 15px; 
color: #000;
}
#notification-content .message { 
font-size: 14px; 
color: #555;
white-space: nowrap; 
overflow: hidden; 
text-overflow: ellipsis; 
max-width: 200px; 
}

/* ===== è¡¨æƒ…è´´çº¸å’Œç‰¹æ®Šæ¶ˆæ¯æ ·å¼ ===== */
.sticker-image { 
max-width: 100px; 
max-height: 100px; 
display: block; 
object-fit: contain; 
}
.message-bubble.is-sticker .content, 
.message-bubble.is-voice-message .content { 
padding: 0; 
background-color: transparent; 
box-shadow: none; 
border: none; 
backdrop-filter: none; 
-webkit-backdrop-filter: none; 
}

/* ===== èŠå¤©è¾“å…¥åŒºé¡¶éƒ¨æ“ä½œæŒ‰é’® ===== */
#chat-input-actions-top { 
display: flex; 
gap: 8px; 
padding: 0 5px; 
}
.chat-action-icon-btn { 
font-size: 24px; 
padding: 0; 
width: 38px; 
height: 38px; 
line-height: 38px; 
text-align: center; 
border-radius: 50%; 
background-color: rgba(255, 255, 255, 0.5);
color: var(--text-primary); 
backdrop-filter: blur(5px); 
-webkit-backdrop-filter: blur(5px); 
border: 1px solid rgba(0,0,0,0.05); 
cursor: pointer; 
display:flex; 
justify-content:center; 
align-items:center; 
}

/* ===== è¡¨æƒ…é¢æ¿æ ·å¼ ===== */
#sticker-panel { 
position: absolute; 
bottom: 0; 
left: 0; 
width: 100%; 
height: 50%; 
background-color: rgba(242, 242, 247, 0.85);
backdrop-filter: blur(15px); 
-webkit-backdrop-filter: blur(15px); 
border-top: 1px solid var(--border-color); 
border-radius: 20px 20px 0 0; 
z-index: 200; 
display: flex; 
flex-direction: column; 
transform: translateY(100%); 
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
visibility: hidden; 
}
#sticker-panel.visible { 
transform: translateY(0); 
visibility: visible; 
}
#sticker-panel-header { 
padding: 10px 20px; 
display: flex; 
justify-content: space-between; 
align-items: center; 
flex-shrink: 0; 
border-bottom: 1px solid var(--border-color); 
}
#sticker-panel-header .default-controls { 
display: flex; 
justify-content: space-between; 
align-items: center; 
width: 100%; 
}
#sticker-panel-header .selection-controls { 
display: flex; 
justify-content: space-between; 
align-items: center; 
width: 100%; 
gap: 10px; 
}
#sticker-panel-header .title { 
font-weight: 600; 
flex: 1; 
text-align: center; 
}
#sticker-panel-header .panel-btn { 
font-size: 16px; 
cursor: pointer; 
color: var(--accent-color);
}
#sticker-grid { 
flex-grow: 1; 
overflow-y: auto; 
padding: 15px; 
display: grid; 
grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
gap: 15px; 
}
.sticker-item { 
position: relative; 
aspect-ratio: 1 / 1; 
background-color: white;
border-radius: 10px; 
background-size: contain; 
background-repeat: no-repeat; 
background-position: center; 
cursor: pointer; 
box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
}
.sticker-item .delete-btn { 
display: none; 
position: absolute; 
top: -5px; 
right: -5px; 
width: 20px; 
height: 20px; 
background-color: #ff3b30;
color: white; 
border-radius: 50%; 
text-align: center; 
line-height: 20px; 
font-size: 14px; 
cursor: pointer; 
border: 2px solid white; 
}
.sticker-item.selected { 
border: 3px solid var(--accent-color);
transform: scale(0.95); 
}
.sticker-item.selected::after { 
content: 'âœ”'; 
position: absolute; 
top: -5px; 
right: -5px; 
background-color: var(--accent-color); 
color: white; 
width: 20px; 
height: 20px; 
border-radius: 50%; 
display: flex; 
align-items: center; 
justify-content: center; 
font-size: 12px; 
font-weight: bold; 
border: 2px solid white; 
}

/* ===== è¾“å…¥åŒºæ“ä½œæŒ‰é’®åŒ…è£…å™¨ ===== */
#input-actions-wrapper { 
position: static; 
display: flex; 
align-items: flex-end; 
gap: 8px; 
flex-shrink: 0; 
}
#wait-reply-btn { 
position: static; 
bottom: auto; 
right: auto; 
width: auto; 
height: 40px; 
padding: 0 10px; 
border-radius: 20px; 
display: flex; 
align-items: center; 
justify-content: center; 
background-color: rgba(255, 255, 255, 0.6); 
backdrop-filter: blur(5px); 
-webkit-backdrop-filter: blur(5px); 
border: 1px solid rgba(0,0,0,0.08); 
box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
transition: opacity 0.2s, transform 0.1s; 
cursor: pointer;
}
#wait-reply-btn:hover { 
opacity: 0.8; 
}
#wait-reply-btn:active { 
transform: scale(0.9); 
}
#wait-reply-btn img { 
height: 22px; 
display: block; 
margin: auto; 
}

/* ===== èŠå¤©å›¾ç‰‡æ ·å¼ ===== */
.chat-image { 
max-width: 100%; 
border-radius: 10px; 
display: block; 
}
.message-bubble.has-image .content { 
padding: 5px; 
}

/* ===== è‡ªå®šä¹‰æ¨¡æ€æ¡†æ ·å¼ ===== */
#custom-modal-overlay { 
position: fixed; 
top: 0; 
left: 0; 
width: 100%; 
height: 100%; 
background-color: rgba(0, 0, 0, 0.5);
display: none; 
align-items: center; 
justify-content: center; 
z-index: 1000; 
opacity: 0; 
transition: opacity 0.2s ease-in-out; 
}
#custom-modal-overlay.visible { 
display: flex; 
opacity: 1; 
}
#custom-modal { 
background-color: #fff; 
width: 280px; 
border-radius: 14px; 
box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
display: flex; 
flex-direction: column; 
transform: scale(0.95); 
transition: transform 0.2s ease-in-out; 
}
#custom-modal-overlay.visible #custom-modal { 
transform: scale(1); 
}
.custom-modal-header { 
padding: 16px; 
font-size: 17px; 
font-weight: 600; 
text-align: center; 
}
.custom-modal-body { 
padding: 0 16px 16px; 
text-align: center; 
font-size: 14px; 
color: #333;
line-height: 1.5; 
}
.custom-modal-body p { 
margin: 0; 
margin-bottom: 12px; 
}
.custom-modal-body input { 
width: 100%; 
padding: 8px; 
border-radius: 6px; 
border: 1px solid #ccc; 
font-size: 14px; 
box-sizing: border-box; 
}
.custom-modal-footer { 
border-top: 1px solid #dbdbdb; 
display: flex; 
}
.custom-modal-footer button { 
flex: 1; 
background: none; 
border: none; 
padding: 12px; 
font-size: 17px; 
cursor: pointer; 
color: var(--accent-color);
}
.custom-modal-footer button:first-child { 
border-right: 1px solid #dbdbdb; 
}
.custom-modal-footer .confirm-btn { 
font-weight: 600; 
}
.custom-modal-footer .confirm-btn.btn-danger { 
color: #ff3b30;
}

/* ===== é¢„è®¾æ“ä½œæ¨¡æ€æ¡†æ ·å¼ ===== */
#preset-actions-modal .custom-modal-footer { 
flex-direction: column; 
}
#preset-actions-modal .custom-modal-footer button { 
width: 100%; 
border: none; 
border-bottom: 1px solid #dbdbdb; 
padding: 14px; 
font-size: 18px; 
}
#preset-actions-modal .custom-modal-footer button:last-child { 
border-bottom: none; 
}

/* ===== è‡ªå®šä¹‰å¤šé€‰æ¡†æ ·å¼ ===== */
.custom-multiselect { 
position: relative; 
user-select: none; 
}
.select-box { 
display: flex; 
align-items: center; 
width: 100%; 
padding: 12px; 
border: 1px solid var(--border-color); 
border-radius: 8px; 
font-size: 16px; 
box-sizing: border-box; 
background-color: #fff; 
cursor: pointer; 
}
.select-box .selected-options-text { 
flex-grow: 1; 
white-space: nowrap; 
overflow: hidden; 
text-overflow: ellipsis; 
color: var(--text-primary); 
}
.select-box .arrow-down { 
margin-left: auto; 
font-size: 10px; 
color: var(--text-secondary); 
transition: transform 0.2s; 
}
.select-box.expanded .arrow-down { 
transform: rotate(180deg); 
}
.checkboxes-container { 
display: none; 
position: absolute; 
top: 105%; 
left: 0; 
right: 0; 
max-height: 150px; 
overflow-y: auto; 
background-color: #fff; 
border: 1px solid var(--border-color); 
border-radius: 8px; 
z-index: 101; 
box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
}
.checkboxes-container.visible { 
display: block; 
}
.checkboxes-container label { 
display: block; 
padding: 10px 12px; 
cursor: pointer; 
font-weight: normal; 
color: var(--text-primary); 
}
.checkboxes-container label:hover { 
background-color: #f5f5f5;
}
.checkboxes-container input { 
margin-right: 10px; 
vertical-align: middle; 
}

/* ===== èƒŒæ™¯å›¾ç‰‡ä¸Šä¼ ç»„ä»¶æ ·å¼ ===== */
.bg-upload-container { 
display: flex; 
align-items: center; 
gap: 10px; 
margin-top: 8px; 
flex-wrap: wrap; 
}
.bg-preview-img { 
max-width: 120px; 
max-height: 80px; 
border-radius: 8px; 
border: 1px solid var(--border-color); 
object-fit: cover; 
display: none; 
}
#remove-bg-btn { 
padding: 8px 12px; 
border: 1px solid #ff3b30;
color: #ff3b30;
background-color: #fff; 
border-radius: 5px; 
cursor: pointer; 
font-size: 14px; 
display: none; 
}

/* ===== AIç”Ÿæˆå›¾ç‰‡æ¶ˆæ¯æ ·å¼ ===== */
.message-bubble.is-ai-image .content { 
padding: 5px; 
background: transparent; 
box-shadow: none; 
border: none; 
backdrop-filter: none; 
-webkit-backdrop-filter: none; 
}
.ai-generated-image { 
max-width: 180px; 
border-radius: 12px; 
display: block; 
cursor: pointer; 
transition: transform 0.2s, box-shadow 0.2s; 
}
.ai-generated-image:hover { 
transform: scale(1.05); 
box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
}

/* ===== è¯­éŸ³æ¶ˆæ¯æ ·å¼ ===== */
.voice-message-body { 
display: flex; 
align-items: center; 
cursor: pointer; 
padding: 8px 12px; 
min-width: 80px; 
max-width: 200px; 
}
.message-bubble.user .voice-message-body { 
color: #1a3d00;
flex-direction: row-reverse; 
}
.message-bubble.ai .voice-message-body { 
color: var(--text-primary); 
}
.voice-waveform { 
display: flex; 
align-items: center; 
height: 20px; 
gap: 2px; 
flex-grow: 1; 
margin: 0 10px; 
}
.voice-waveform div { 
width: 3px; 
background-color: currentColor; 
border-radius: 2px; 
animation: wave-quiet 1.5s ease-in-out infinite; 
}
@keyframes wave-quiet { 
0%, 100% { height: 2px; } 
50% { height: 10px; } 
}
.voice-waveform div:nth-child(2) { animation-delay: 0.2s; } 
.voice-waveform div:nth-child(3) { animation-delay: 0.4s; } 
.voice-waveform div:nth-child(4) { animation-delay: 0.6s; } 
.voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration { 
font-size: 13px; 
font-weight: 500; 
color: var(--text-secondary); 
}
.message-bubble.user .voice-duration { 
color: #3e6224;
}

/* ===== æ°”æ³¡ä¸»é¢˜é»˜è®¤æ ·å¼ ===== */
.message-bubble.user .content { 
background-color: rgba(255, 255, 255, 0.75);
color: #585858;
border-radius: 8px 2px 8px 8px; 
}
.message-bubble.ai .content { 
background-color: rgba(255, 255, 255, 0.7);
color: #585858;
border-radius: 2px 8px 8px 8px; 
}

/* ===== æ¶ˆæ¯æ°”æ³¡å°¾å·´è£…é¥° ===== */
.message-bubble::after {
content: "";
position: absolute;
width: 20px;  
height: 20px; 
background-size: contain;
background-repeat: no-repeat;
opacity: 1; 
z-index: 1;
}

.message-bubble.user .avatar-group {
margin-right: 22px; 
}

/* ===== å„ç§èŠå¤©æ°”æ³¡ä¸»é¢˜é¢œè‰²å®šä¹‰ ===== */
#chat-messages[data-theme="pink_blue"] .message-bubble.user .content { 
background-color: #fff0f6;
color: #432531;
}
#chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { 
background-color: #eff7ff;
color: #263a4e;
}

#chat-messages[data-theme="blue_white"] .message-bubble.user .content { 
background-color: #eff7ff;
color: #263a4e; 
}
#chat-messages[data-theme="blue_white"] .message-bubble.ai .content { 
background-color: #f8f9fa;
color: #383d41; 
}

#chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { 
background-color: #faf7ff;
color: #827693; 
}
#chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { 
background-color: #fffde4;
color: #5C4033; 
}

#chat-messages[data-theme="black_white"] .message-bubble.user .content { 
background-color: #343a40;
color: #f8f9fa; 
}
#chat-messages[data-theme="black_white"] .message-bubble.ai .content { 
background-color: #f8f9fa;
color: #343a40; 
}

#chat-messages[data-theme="yellow_white"] .message-bubble.user .content { 
background-color: #FFEB3B;
color: #5D4037; 
}
#chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { 
background-color: #f8f9fa; 
color: #383d41; 
}

#chat-messages[data-theme="red_black"] .message-bubble.user .content { 
background-color: #C62828;
color: #FFFFFF; 
}
#chat-messages[data-theme="red_black"] .message-bubble.ai .content { 
background-color: #212121;
color: #FFFFFF; 
}

#chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { 
background-color: #A0D2EB;
color: #153243; 
}
#chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { 
background-color: #FEF9E7;
color: #5D4037; 
}

#chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { 
background-color: #fff0f6;
color: #432531; 
}
#chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { 
background-color: #FEF9E7;
color: #5D4037; 
}

#chat-messages[data-theme="pink_purple"] .message-bubble.user .content { 
background-color: #fff0f6;
color: #a78396; 
}
#chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { 
background-color: #faf7ff;
color: #827693; 
}

#chat-messages[data-theme="gray_white"] .message-bubble.user .content { 
background-color: #e9ecef;
color: #495057; 
}
#chat-messages[data-theme="gray_white"] .message-bubble.ai .content { 
background-color: #f8f9fa;
color: #383d41; 
}

#chat-messages[data-theme="blue_green"] .message-bubble.user .content { 
background-color: #d1ecf1;
color: #0c5460; 
}
#chat-messages[data-theme="blue_green"] .message-bubble.ai .content { 
background-color: #d4edda;
color: #155724; 
}

#chat-messages[data-theme="pink_white"] .message-bubble.user .content { 
background-color: #fff0f6;
color: #a78396; 
}
#chat-messages[data-theme="pink_white"] .message-bubble.ai .content { 
background-color: #f8f9fa;
color: #383d41; 
}

#chat-messages[data-theme="pink_black"] .message-bubble.user .content { 
background-color: #F8BBD0;
color: #5B2C6F; 
}
#chat-messages[data-theme="pink_black"] .message-bubble.ai .content { 
background-color: #343a40;
color: #f8f9fa; 
}

#chat-messages[data-theme="pink_green"] .message-bubble.user .content { 
background-color: #F8BBD0;
color: #5B2C6F; 
}
#chat-messages[data-theme="pink_green"] .message-bubble.ai .content { 
background-color: #C8E6C9;
color: #1B5E20; 
}

#chat-messages[data-theme="green_black"] .message-bubble.user .content { 
background-color: #d4edda;
color: #155724; 
}
#chat-messages[data-theme="green_black"] .message-bubble.ai .content { 
background-color: #343a40;
color: #f8f9fa; 
}

/* ===== è½¬è´¦åŠŸèƒ½æ ·å¼ ===== */
#transfer-btn { 
font-weight: bold; 
}
#transfer-modal { 
position: fixed; 
top: 0; 
left: 0; 
width: 100%; 
height: 100%; 
background-color: rgba(0,0,0,0.5); 
display: none; 
align-items: center; 
justify-content: center; 
z-index: 1001; 
}
#transfer-modal.visible { 
display: flex; 
}
.transfer-content { 
background-color: #fff0f5;
border-radius: 20px; 
width: 290px; 
padding: 20px; 
box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); 
text-align: center; 
background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); 
background-repeat: no-repeat; 
background-position: top right; 
background-size: 80px; 
}
.transfer-header { 
font-size: 20px; 
font-weight: bold; 
color: #a35c7b;
margin-bottom: 20px; 
}
.transfer-input-group { 
margin-bottom: 15px; 
text-align: left; 
}
.transfer-input-group label { 
display: block; 
font-size: 14px; 
color: #ff85b3;
margin-bottom: 5px; 
font-weight: 500; 
}
.transfer-input-group input { 
width: 100%; 
padding: 12px; 
border-radius: 10px; 
border: 2px solid #ffcce0;
background-color: #fff; 
font-size: 16px; 
box-sizing: border-box; 
}
.transfer-input-group input:focus { 
border-color: #ff85b3;
outline: none; 
}
.transfer-actions { 
display: flex; 
justify-content: space-between; 
gap: 10px; 
}
.transfer-actions button { 
flex: 1; 
padding: 12px; 
border: none; 
border-radius: 10px; 
font-size: 16px; 
font-weight: bold; 
cursor: pointer; 
transition: transform 0.2s; 
}
.transfer-actions button:active { 
transform: scale(0.95); 
}
#transfer-cancel-btn { 
background-color: #ffdde9;
color: #a35c7b; 
}
#transfer-confirm-btn { 
background-color: #ff85b3;
color: white; 
}

/* ===== è½¬è´¦æ¶ˆæ¯å¡ç‰‡æ ·å¼ ===== */
.message-bubble.is-transfer .content { 
padding: 0; 
background: transparent; 
box-shadow: none; 
border: none; 
backdrop-filter: none; 
-webkit-backdrop-filter: none; 
cursor: pointer; 
}
.transfer-card { 
width: 200px; 
border-radius: 12px; 
padding: 12px; 
color: white; 
position: relative; 
overflow: hidden; 
}
.transfer-card::before { 
content: 'ğŸ¾'; 
position: absolute; 
right: 10px; 
top: 5px; 
font-size: 30px; 
opacity: 0.2; 
transform: rotate(15deg); 
}
.message-bubble.user .transfer-card { 
background: radial-gradient(circle at top left, #ffc5d5, #ff85b3);
}
.message-bubble.ai .transfer-card { 
background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb);
}
.transfer-title { 
font-size: 16px; 
font-weight: 600; 
display: flex; 
align-items: center; 
gap: 6px; 
margin-bottom: 8px; 
}
.transfer-amount { 
font-size: 28px; 
font-weight: bold; 
margin-bottom: 4px; 
}
.transfer-note { 
font-size: 13px; 
opacity: 0.9; 
border-top: 1px solid rgba(255,255,255,0.3); 
padding-top: 8px; 
margin-top: 8px; 
word-break: break-all; 
}

/* ===== éŸ³ä¹æ’­æ”¾å™¨åŠ¨ç”» ===== */
@keyframes spin { 
from { transform: rotate(0deg); } 
to { transform: rotate(360deg); } 
}
#listen-together-btn img.rotating { 
animation: spin 2s linear infinite; 
}
#listen-together-btn img.paused { 
animation-play-state: paused; 
}

/* ===== éŸ³ä¹æ’­æ”¾å™¨é®ç½©å±‚ ===== */
#music-player-overlay { 
position: absolute; 
top: 0; 
left: 0; 
width: 100%; 
height: 100%; 
z-index: 50; 
display: none; 
justify-content: center; 
align-items: center; 
background-color: rgba(0,0,0,0.3);
}
#music-player-overlay.visible { 
display: flex; 
}

/* ===== éŸ³ä¹æ’­æ”¾å™¨çª—å£ ===== */
.music-player-window { 
width: 85%; 
max-width: 320px; 
height: 30vh; 
max-height: 500px;
background-color: rgba(255, 255, 255, 0.9);
backdrop-filter: blur(20px); 
-webkit-backdrop-filter: blur(20px); 
border-radius: 20px; 
box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
border: 1px solid rgba(255, 255, 255, 0.18); 
padding: 20px; 
display: flex; 
flex-direction: column; 
align-items: center; 
color: #1f1f1f; 
position: relative; 
overflow: hidden;
}
#music-time-counter { 
font-size: 15px; 
color: #555;
margin-bottom: 15px; 
text-align: center;
}

/* ===== éŸ³ä¹æ’­æ”¾å™¨ä¸»æ’­æ”¾åŒºåŸŸå¸ƒå±€ ===== */
.music-player-main { 
display: flex; 
align-items: center; 
gap: 15px; 
width: 100%; 
margin-bottom: 20px; 
}

/* ===== ä¸“è¾‘å°é¢åŒºåŸŸ ===== */
.album-cover-container { 
flex-shrink: 0; 
position: absolute; 
top: 60px; 
left: 15px; 
}

#album-cover { 
width: 137px;
height: 137px; 
border-radius: 10px; 
overflow: hidden; 
color: #000; 
position: absolute;
border: 3px solid #000;
}

#album-cover-img {
width: 100%;
height: 100%;
object-fit: contain;
}

/* ===== å³ä¾§æ§åˆ¶åŒºåŸŸ ===== */
.music-control-area { 
flex: 1; 
display: flex; 
flex-direction: column; 
gap: 8px; 
}

/* ===== æ­Œæ›²ä¿¡æ¯åŒºåŸŸ ===== */
.song-info { 
display: flex; 
align-items: center; 
justify-content: space-between; 
width: 100%; 
}
.song-text { 
flex: 1; 
}

#music-player-song-title {
font-size: 11px;
font-weight: 600;
color: #333;
margin: 0;
line-height: 1.2;
position: relative;
width: 110px;
height: 1.2em;
overflow: hidden;
white-space: nowrap;
  top: 15px;  /* å‘ä¸Šç§»åŠ¨20px */
  left: 155px; /* å‘å³ç§»åŠ¨25px */
}

#music-player-song-title span {
display: inline-block;
padding-left: 100%;
animation: scroll-text 15s linear infinite;
}

#music-player-song-title .scroll-wrapper {
width: 100%;
overflow: hidden;
white-space: nowrap;
}

#music-player-song-title .scroll-wrapper {
display: block;
width: 100%;
overflow: hidden;
white-space: nowrap;
}
@keyframes scroll-text {
0%, 25% { transform: translateX(0); }
100% { transform: translateX(calc(-100% + 110px)); }
}

#music-player-artist { 
font-size: 8px; 
color: #666;
margin: 0; 
line-height: 1.2; 
position: absolute;
top: 80px;
left: 175px;
}

/* ===== æ”¶è—æŒ‰é’®æ ·å¼ ===== */
.favorite-btn { 
position: absolute;
top: 65px;
right: 20px;
width: 30px;
background: none; 
border: none; 
font-size: 18px; 
color: #000;
cursor: pointer; 
transition: all 0.2s ease; 
flex-shrink: 0; 
height: 30px; 
display: flex; 
align-items: center; 
justify-content: center; 
}
.favorite-btn:hover { 
color: #ff4757;
transform: scale(1.0); 
}
.favorite-btn.active {
color: #ff4757;
}

.favorite-btn.active i {
color: #ff4757;
}

/* ===== éŸ³ä¹è¿›åº¦æ¡æ ·å¼ ===== */
.progress-container { 
position: absolute;
top: 90px;
left: 165px;
width: 150px;
}

.progress-slider { 
width: 100%; 
height: 2px;
border-radius: 1px; 
background: #000;
outline: none; 
-webkit-appearance: none; 
cursor: pointer; 
}

.progress-slider::-webkit-slider-thumb { 
-webkit-appearance: none; 
appearance: none; 
width: 8px;
height: 8px; 
border-radius: 50%; 
background: #333;
cursor: pointer; 
}

.progress-slider::-moz-range-thumb { 
width: 20px; 
height: 20px; 
border-radius: 50%; 
background: #333; 
cursor: pointer; 
border: none; 
box-shadow: 0 2px 8px rgba(0,0,0,0.3); 
}

/* ===== éŸ³é¢‘å¯è§†åŒ–æ³¢å½¢ ===== */
.audio-visualizer { 
position: absolute;
top: 110px;
left: 167px;
width: 150px;
height: 45px; 
display: flex; 
align-items: center; 
justify-content: center; 
gap: 2px; 
}

/* ===== æ³¢å½¢æ¡æ ·å¼ ===== */
.visualizer-bar {
width: 2px;
height: 2px;
background-color: #000;
border-radius: 2px;
transition: height 0.1s ease;
}

/* ===== æ— éŸ³ä¹æ—¶éšè— ===== */
.audio-visualizer.hidden {
display: none;
}

/* ===== æ’­æ”¾æ§åˆ¶æŒ‰é’®å®¹å™¨ ===== */
.music-controls { 
position: absolute;
top: 160px;
left: 165px;
width: 150px;
height: 60px;
}

/* ===== éšæœºæ’­æ”¾æŒ‰é’® ===== */
#music-shuffle-btn {
position: absolute;
left: 0px;
top: 12px;
width: 25px;
height: 25px;
background: none; 
border: none; 
font-size: 14px; 
color: #000;
cursor: pointer; 
display: flex; 
justify-content: center; 
align-items: center; 
border-radius: 50%; 
transition: all 0.2s ease;
}

/* ===== ä¸Šä¸€é¦–æŒ‰é’® ===== */
#music-prev-btn {
position: absolute;
left: 30px;
top: 12px;
width: 25px;
height: 25px;
background: none; 
border: none; 
font-size: 14px; 
color: #000; 
cursor: pointer; 
display: flex; 
justify-content: center; 
align-items: center; 
border-radius: 50%; 
transition: all 0.2s ease;
}

/* ===== æ’­æ”¾/æš‚åœæŒ‰é’® ===== */
#music-play-pause-btn {
position: absolute;
left: 50px;
top: 0px;
width: 50px;
height: 50px;
font-size: 24px; 
background: none;
color: #000; 
border: none; 
cursor: pointer; 
display: flex; 
justify-content: center; 
align-items: center; 
transition: all 0.2s ease;
}

/* ===== ä¸‹ä¸€é¦–æŒ‰é’® ===== */
#music-next-btn {
position: absolute;
right: 30px;
top: 12px;
width: 25px;
height: 25px;
background: none; 
border: none; 
font-size: 14px; 
color: #000; 
cursor: pointer; 
display: flex; 
justify-content: center; 
align-items: center; 
border-radius: 50%; 
transition: all 0.2s ease;
}

/* ===== å¾ªç¯æ’­æ”¾æŒ‰é’® ===== */
#music-repeat-btn {
position: absolute;
right: 0px;
top: 12px;
width: 25px;
height: 25px;
background: none; 
border: none; 
font-size: 14px; 
color: #000; 
cursor: pointer; 
display: flex; 
justify-content: center; 
align-items: center; 
border-radius: 50%; 
transition: all 0.2s ease;
}

/* ===== éŸ³ä¹æ’­æ”¾å™¨åº•éƒ¨æŒ‰é’® ===== */
.music-bottom-actions {
display: flex;
justify-content: space-between;
gap: 8px;
margin-top: auto;
padding-top: 15px;
width: 100%;
max-width: 280px;
}

.music-bottom-actions button {
flex: 1;
padding: 12px 0;
border: none;
border-radius: 12px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s ease;
box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#music-exit-btn { 
background-color: rgba(255, 100, 100, 0.8);
color: white; 
}

#music-return-btn { 
background-color: rgba(0, 123, 255, 0.8);
color: white; 
}

/* ===== éŸ³ä¹æ’­æ”¾åˆ—è¡¨é¢æ¿ ===== */
#music-playlist-panel { 
position: absolute; 
bottom: 0; 
left: 0; 
width: 100%; 
height: 70%; 
background-color: rgba(242, 242, 247, 0.9);
backdrop-filter: blur(15px); 
-webkit-backdrop-filter: blur(15px); 
border-top: 1px solid var(--border-color); 
border-radius: 20px 20px 0 0; 
z-index: 210; 
display: flex; 
flex-direction: column; 
transform: translateY(100%); 
transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
visibility: hidden; 
}
#music-playlist-panel.visible { 
transform: translateY(0); 
visibility: visible; 
}
.playlist-header { 
padding: 15px 20px; 
display: flex; 
justify-content: space-between; 
align-items: center; 
flex-shrink: 0; 
border-bottom: 1px solid var(--border-color); 
font-weight: 600; 
}
.playlist-header .panel-btn { 
font-size: 16px; 
cursor: pointer; 
color: var(--accent-color);
}
.playlist-body { 
flex-grow: 1; 
overflow-y: auto; 
padding: 10px 0; 
}
.playlist-item { 
padding: 10px 20px; 
display: flex; 
justify-content: space-between; 
align-items: center; 
cursor: pointer; 
border-bottom: 1px solid #eee; 
}
.playlist-item.playing { 
background-color: rgba(0, 123, 255, 0.1);
}
.playlist-item-info .title { 
font-weight: 500; 
font-size: 15px; 
}
.playlist-item-info .artist { 
font-size: 12px; 
color: #666;
}
.playlist-item .delete-track-btn { 
color: #ff3b30;
font-size: 20px; 
padding: 5px; 
}

/* ===== äººè®¾åº“æ ·å¼ ===== */
#persona-library-grid { 
display: grid; 
grid-template-columns: repeat(4, 1fr); 
gap: 15px; 
padding: 10px; 
}
.persona-preset-item { 
aspect-ratio: 1 / 1; 
border-radius: 12px; 
background-size: cover; 
background-position: center; 
cursor: pointer; 
transition: transform 0.2s, box-shadow 0.2s; 
border: 1px solid rgba(0,0,0,0.1); 
}
.persona-preset-item:hover { 
transform: scale(1.08); 
box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
}
.modal-header .action-button { 
font-size: 16px; 
color: var(--accent-color); 
font-weight: 600; 
cursor: pointer; 
background: none; 
border: none; 
padding: 5px; 
}
#persona-library-modal.selection-mode .default-controls { 
display: none !important; 
}
#persona-library-modal:not(.selection-mode) .selection-controls { 
display: none !important; 
}
#persona-library-modal.selection-mode .selection-controls { 
display: flex !important; 
}
.persona-preset-item.selected { 
border: 3px solid var(--accent-color);
transform: scale(0.95); 
}
.persona-preset-item.selected::after { 
content: 'âœ”'; 
position: absolute; 
top: 5px; 
right: 5px; 
background-color: var(--accent-color); 
color: white; 
width: 20px; 
height: 20px; 
border-radius: 50%; 
display: flex; 
align-items: center; 
justify-content: center; 
font-size: 12px; 
font-weight: bold; 
}

.persona-preset-name {
position: absolute;
bottom: 0;
left: 0;
right: 0;
background: linear-gradient(transparent, rgba(0,0,0,0.7));
color: white;
font-size: 11px;
font-weight: 500;
text-align: center;
padding: 8px 4px 4px 4px;
border-radius: 0 0 12px 12px;
text-shadow: 0 1px 2px rgba(0,0,0,0.8);
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}

/* ===== ç”µæ± æé†’æ¨¡æ€æ¡†æ ·å¼ ===== */
#battery-alert-modal { 
position: fixed; 
top: 0; 
left: 0; 
width: 100%; 
height: 100%; 
background-color: rgba(0, 0, 0, 0.4); 
display: none; 
justify-content: center; 
align-items: center; 
z-index: 2000; 
opacity: 0; 
transition: opacity 0.3s ease; 
}
#battery-alert-modal.visible { 
display: flex; 
opacity: 1; 
}
.battery-alert-content { 
background-color: rgba(255, 255, 255, 0.9); 
backdrop-filter: blur(10px); 
-webkit-backdrop-filter: blur(10px); 
width: 280px; 
border-radius: 15px; 
box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
text-align: center; 
padding: 20px; 
cursor: pointer; 
transform: scale(0.9); 
transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
}
#battery-alert-modal.visible .battery-alert-content { 
transform: scale(1); 
}
#battery-alert-image { 
max-width: 100px; 
max-height: 100px; 
margin-bottom: 15px; 
}
#battery-alert-text { 
font-size: 16px; 
font-weight: 500; 
color: #333;
margin: 0; 
line-height: 1.4; 
}

/* ===== å¤´åƒæ¡†ç›¸å…³æ ·å¼ ===== */
.avatar-with-frame {
position: relative;
width: 30px;
height: 30px;
flex-shrink: 0;
}

.avatar-with-frame .avatar-img,
.avatar-with-frame .avatar-frame {
position: absolute;
top: 0;
left: 0;
width: 150%;
height: 150%;
}

.avatar-with-frame .avatar-img {
border-radius: 50%;
object-fit: cover;
z-index: 1;
}

.avatar-with-frame .avatar-frame {
z-index: 2;
pointer-events: none;
}

.message-bubble .avatar {
width: 34px;
height: 34px;
border-radius: 20%;
object-fit: cover;
}

/* ===== å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡†æ ·å¼ ===== */
.change-frame-btn {
padding: 6px 10px;
border: 1px solid #ccc;
background-color: #f0f0f0;
border-radius: 5px;
cursor: pointer;
font-size: 13px;
margin-left: 10px;
}

#avatar-frame-modal .modal-content {
height: 70%;
}

#avatar-frame-modal .modal-body {
padding: 0;
display: flex;
flex-direction: column;
}

.avatar-with-frame .avatar-frame {
position: absolute;
width: 52px;
height: 52px;
top: -7px;
left: -4px;
}

/* ===== å¤´åƒæ¡†é€‰æ‹©æ ‡ç­¾é¡µ ===== */
.frame-tabs {
display: flex;
border-bottom: 1px solid var(--border-color);
flex-shrink: 0;
}

.frame-tab {
flex: 1;
padding: 12px;
text-align: center;
font-weight: 500;
cursor: pointer;
color: var(--text-secondary);
border-bottom: 2px solid transparent;
}

.frame-tab.active {
color: var(--accent-color);
border-bottom-color: var(--accent-color);
}

.frame-content {
flex-grow: 1;
overflow-y: auto;
padding: 15px;
}

.frame-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
gap: 15px;
}

.frame-item {
aspect-ratio: 1 / 1;
border: 2px solid transparent;
border-radius: 10px;
cursor: pointer;
background-color: #f0f0f0;
background-size: cover;
background-position: center;
padding: 5px;
transition: all 0.2s ease;
position: relative;
}

.frame-item.selected {
border-color: var(--accent-color);
transform: scale(1.05);
}

.frame-item .preview-avatar {
width: 100%;
height: 100%;
border-radius: 50%;
object-fit: cover;
}

.frame-item .preview-frame {
position: absolute;
top: -7px;
left: 0;
width: 100%;
height: 100%;
}

/* ===== å­—ä½“é¢„è§ˆæ ·å¼ ===== */
#font-preview {
transition: font-family 0.3s ease;
}

/* ===== å¤´åƒç¼–è¾‘å™¨æ ·å¼ ===== */
#avatar-editor-modal .modal-content {
width: 90%;
max-width: 400px;
}

#avatar-crop-image {
max-width: none;
max-height: none;
transform-origin: center center;
transition: transform 0.1s ease;
}

#avatar-scale-slider {
-webkit-appearance: none;
appearance: none;
height: 4px;
border-radius: 2px;
background: #ddd;
outline: none;
}

#avatar-scale-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
border-radius: 50%;
background: #007bff;
cursor: pointer;
border: 2px solid white;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

#avatar-scale-slider::-moz-range-thumb {
width: 20px;
height: 20px;
border-radius: 50%;
background: #007bff;
cursor: pointer;
border: 2px solid white;
box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.avatar-clickable {
cursor: pointer;
transition: opacity 0.2s ease;
}

.avatar-clickable:hover {
opacity: 0.8;
}

/* ===== Font Awesome å›¾æ ‡æ ·å¼ ===== */
.action-btn i {
font-size: 18px;
display: block;
}

.action-btn#add-world-book-btn i {
color: #007bff;
}

/* ===== å¯¼å…¥äººè®¾æŒ‰é’®æ ·å¼ ===== */
#import-persona-json-btn {
padding: 6px 10px;
border: 1px solid #ccc;
background-color: #f0f0f0;
border-radius: 5px;
cursor: pointer;
font-size: 13px;
margin-left: 10px;
color: #007bff;
}

#import-persona-json-btn:hover {
background-color: #e0e0e0;
}

/* ===== ä¸–ç•Œä¹¦é€‰æ‹©å™¨æ ·å¼ ===== */
.world-book-selector-summary {
display: flex;
flex-direction: column;
gap: 10px;
}
#linked-world-books-display {
padding: 12px;
border: 1px solid var(--border-color);
border-radius: 8px;
background-color: #f9f9f9;
min-height: 60px;
font-size: 14px;
color: var(--text-secondary);
}
.wb-selector-toolbar {
display: flex;
gap: 10px;
align-items: center;
margin-bottom: 20px;
padding-bottom: 10px;
border-bottom: 1px solid var(--border-color);
}
.wb-selector-toolbar button {
padding: 8px 12px;
font-size: 14px;
margin: 0;
}
#wb-selection-summary {
margin-left: auto;
font-weight: 600;
color: var(--accent-color);
}
.wb-folder-item {
margin-bottom: 15px;
border: 1px solid var(--border-color);
border-radius: 8px;
}
.wb-folder-header {
padding: 12px 15px;
background-color: #f8f9fa;
border-bottom: 1px solid var(--border-color);
display: flex;
justify-content: space-between;
align-items: center;
cursor: pointer;
font-weight: 600;
}
.wb-folder-header:hover {
background-color: #e9ecef;
}
.wb-folder-header.selected {
background-color: rgba(0, 123, 255, 0.1);
color: var(--accent-color);
}
.wb-folder-toggle {
font-size: 12px;
transition: transform 0.2s;
}
.wb-folder-item.collapsed .wb-folder-toggle {
transform: rotate(-90deg);
}
.wb-folder-checkbox {
margin-right: 8px;
}
.wb-book-list {
padding: 10px;
}
.wb-folder-item.collapsed .wb-book-list {
display: none;
}
.wb-book-item {
display: flex;
align-items: center;
padding: 8px 12px;
margin: 2px 0;
border-radius: 6px;
cursor: pointer;
}
.wb-book-item:hover {
background-color: #f5f5f5;
}
.wb-book-item.selected {
background-color: rgba(0, 123, 255, 0.1);
}
.wb-book-checkbox {
margin-right: 10px;
}
.wb-book-name {
flex-grow: 1;
font-size: 14px;
}
.wb-book-preview {
font-size: 12px;
color: var(--text-secondary);
margin-left: 10px;
max-width: 100px;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}

/* ===== éŸ³ä¹æœç´¢ç›¸å…³æ ·å¼ ===== */
.modal-close-btn {
font-size: 24px;
cursor: pointer;
color: #666;
line-height: 1;
}

.modal-close-btn:hover {
color: #333;
}

.music-search-result-item {
padding: 12px;
border: 1px solid var(--border-color);
border-radius: 8px;
margin-bottom: 10px;
cursor: pointer;
transition: background-color 0.2s ease;
}

.music-search-result-item:hover {
background-color: #f5f5f5;
}

.music-result-title {
font-weight: 600;
font-size: 15px;
margin-bottom: 4px;
color: var(--text-primary);
}

.music-result-artist {
font-size: 13px;
color: var(--text-secondary);
margin-bottom: 8px;
}

.music-result-actions {
display: flex;
gap: 8px;
}

.music-result-btn {
padding: 6px 12px;
border: 1px solid var(--accent-color);
background-color: white;
color: var(--accent-color);
border-radius: 4px;
cursor: pointer;
font-size: 12px;
transition: all 0.2s ease;
}

.music-result-btn:hover {
background-color: var(--accent-color);
color: white;
}

.music-result-btn.primary {
background-color: var(--accent-color);
color: white;
}

.music-result-btn.primary:hover {
background-color: #0056b3;
}

.search-loading {
text-align: center;
padding: 20px;
color: var(--text-secondary);
}

.search-no-results {
text-align: center;
padding: 20px;
color: var(--text-secondary);
}

.music-player-window {
position: relative;
}

#music-playlist-btn {
position: absolute;
top: 15px;
right: 15px;
font-size: 20px;
cursor: pointer;
color: #333;
padding: 5px;
line-height: 1;
z-index: 10;
}

#music-playlist-btn:hover {
opacity: 0.7;
}

#music-time-counter {
text-align: center;
margin-bottom: 15px;
}

</style>
</head>
<body>

<!-- ===== è¿·ä½ æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ ===== -->
<div id="mini-lyrics-display" style="position: fixed; top: 120px; left: 0; right: 0; background: rgba(0,0,0,0.6); color: #ff6b6b; text-align: center; padding: 8px 15px; display: none; z-index: 9999; font-size: 14px; line-height: 1.4; pointer-events: none;">
<div id="mini-lyrics-text">æ— æ³•è·å–æ­Œè¯</div>
<div id="mini-lyrics-translation" style="font-size: 12px; opacity: 0.8; margin-top: 3px; display: none;"></div>
</div>

<!-- ===== æ‰‹æœºæ¡†æ¶ä¸»å®¹å™¨ ===== -->
<div id="phone-frame">
<div class="notch"></div>
<div id="phone-screen">

<!-- ===== çŠ¶æ€æ  ===== -->
<div id="status-bar">
<span id="status-bar-time">12:00</span>
<div id="status-bar-battery" class="battery-container">
<span class="battery-text">--%</span>
<div class="battery-icon">
<div class="battery-level"></div>
</div>
</div>
</div>

<!-- ===== é€šçŸ¥æ  ===== -->
<div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>

<!-- ===== ä¸»å±å¹• ===== -->
<div id="home-screen" class="screen active">
<div id="clock-container"><div id="main-time">12:00</div><div id="main-date">æ˜ŸæœŸä¸€, 1æœˆ1æ—¥</div></div>
<div id="app-grid">
<div class="app-row">
<div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="ä¸–ç•Œä¹¦"></div><span class="label">ä¸–ç•Œä¹¦</span></div>
<div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ"></div><span class="label">QQ</span></div>
</div>
<div class="app-row">
<div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="APIè®¾ç½®"></div><span class="label">APIè®¾ç½®</span></div>
<div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="å£çº¸"></div><span class="label">å£çº¸</span></div>
<div class="app-icon" onclick="showScreen('font-settings-screen')">
<div class="icon-bg"><img src="https://files.catbox.moe/j1kn1a.jpeg" alt="å­—ä½“"></div>
<span class="label">å­—ä½“</span>
</div>
</div>
</div>
</div>

<!-- ===== ä¸–ç•Œä¹¦é¡µé¢ ===== -->
<div id="world-book-screen" class="screen">
<div class="header">
<span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
<span>ä¸–ç•Œä¹¦</span>
<div class="header-actions">
<div class="default-controls">
<span class="action-btn" id="download-world-book-btn" title="ä¸‹è½½ä¸–ç•Œä¹¦">
<i class="fa-solid fa-download"></i>
</span>
<span class="action-btn" id="import-world-book-btn" title="ä¸Šä¼ ä¸–ç•Œä¹¦">
<i class="fa-solid fa-file-import"></i>
</span>
<span class="action-btn" id="add-folder-btn" title="åˆ›å»ºä¸–ç•Œä¹¦ç»„">
<i class="fa-solid fa-folder"></i>
</span>
<span class="action-btn" id="add-world-book-btn" title="åˆ›å»ºä¸–ç•Œä¹¦">
<i class="fa-solid fa-plus"></i>
</span>
</div>
<div class="selection-controls" style="display: none;">
<span id="wb-select-all-btn" style="color: #007bff;">å…¨é€‰</span>
<span id="wb-selection-cancel-btn">å–æ¶ˆ</span>
<span id="wb-selection-count"></span>
<span id="wb-selection-download-btn" style="color: #007bff;">ä¸‹è½½</span>
<span id="wb-selection-delete-btn" style="color: #ff3b30;">åˆ é™¤</span>
</div>
</div>
</div>
<div id="world-book-list"></div>
</div>

<!-- ===== ä¸–ç•Œä¹¦ç¼–è¾‘é¡µé¢ ===== -->
<div id="world-book-editor-screen" class="screen">
<div class="header">
<span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
<span id="world-book-editor-title">ç¼–è¾‘ä¸–ç•Œä¹¦</span>
<span class="save-btn" id="save-world-book-btn">ä¿å­˜</span>
</div>
<div class="form-container">
<div class="form-group">
<label for="world-book-name-input">ä¹¦å</label>
<input type="text" id="world-book-name-input" placeholder="è¯·è¾“å…¥ä¸–ç•Œä¹¦çš„åç§°...">
</div>
<div class="form-group" style="height: 100%;">
<label for="world-book-content-input">å†…å®¹</label>
<textarea id="world-book-content-input" placeholder="åœ¨æ­¤å¤„è¾“å…¥è¯¦ç»†çš„ä¸–ç•Œè§‚è®¾å®š..."></textarea>
</div>
</div>
</div>

<!-- ===== APIè®¾ç½®é¡µé¢ ===== -->
<div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">æç¤º: è‹¥è¦ä½¿ç”¨"å‘é€å›¾ç‰‡"åŠŸèƒ½, è¯·åŠ¡å¿…é€‰æ‹©æ”¯æŒVision(è§†è§‰)çš„æ¨¡å‹, å¦‚<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>æˆ–<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>ã€‚</p><div class="form-group"><label for="proxy-url">åä»£åœ°å€ (ä¸éœ€è¦æ·»åŠ /v1å™¢~)</label><input type="text" id="proxy-url" placeholder="ä¾‹å¦‚: https://api.openai.com"></div><div class="form-group"><label for="api-key">å¯†é’¥ (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">æ¨¡å‹</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">æ‹‰å–æ¨¡å‹</button><button class="form-button" id="save-api-settings-btn">ä¿å­˜è®¾ç½®</button></div></div>

<!-- ===== èŠå¤©åˆ—è¡¨é¡µé¢ ===== -->
<div id="chat-list-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>æ¶ˆæ¯</span><div class="header-actions"><span class="action-btn" id="import-character-btn" title="å¯¼å…¥è§’è‰²å¡"><i class="fa-solid fa-heart"></i></span><span class="action-btn" id="add-group-chat-btn" title="åˆ›å»ºç¾¤èŠ"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="action-btn" id="add-chat-btn">+</span></div></div><div id="chat-list"></div></div>

<!-- ===== èŠå¤©ç•Œé¢é¡µé¢ ===== -->
<div id="chat-interface-screen" class="screen">
<button id="scroll-to-bottom-btn" title="å›åˆ°æœ€æ–°æ¶ˆæ¯">
<i class="fa-solid fa-arrow-down"></i>
</button>
<div class="header">
<div class="default-controls">
<span class="back-btn" id="back-to-list-btn">â€¹</span>
<span id="chat-header-title">èŠå¤©å¯¹è±¡</span>
<div class="header-actions">
<span class="action-btn" id="listen-together-btn" title="ä¸€èµ·å¬"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="ä¸€èµ·å¬"></span>
<span class="action-btn" id="chat-settings-btn" title="èŠå¤©è®¾ç½®"><img src="https://i.postimg.cc/R04MT1MV/210-20250618115233.png" alt="è®¾ç½®"></span>
</div>
</div>
<div class="selection-controls">
<span id="selection-cancel-btn">å–æ¶ˆ</span>
<span id="selection-count"></span>
<span id="selection-delete-btn">åˆ é™¤</span>
</div>
</div>
<div id="chat-messages"><div id="typing-indicator">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div></div>

<div id="chat-input-area">
<div id="chat-input-actions-top">
<button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="è¡¨æƒ…é¢æ¿"><i class="fa-solid fa-plus"></i></button>
<button id="send-photo-btn" class="chat-action-icon-btn action-button" title="å‘é€ç…§ç‰‡"><i class="fa-solid fa-camera"></i></button>
<button id="upload-image-btn" class="chat-action-icon-btn action-button" title="ä¸Šä¼ å›¾ç‰‡"><i class="fa-solid fa-image"></i></button>
<button id="transfer-btn" class="chat-action-icon-btn action-button" title="è½¬è´¦"><i class="fa-solid fa-yen-sign"></i></button>
<button id="voice-message-btn" class="chat-action-icon-btn action-button" title="å‘é€è¯­éŸ³"><i class="fa-solid fa-microphone"></i></button>
</div>
<div id="chat-input-main-row">
<textarea id="chat-input" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
<div id="input-actions-wrapper">
<button id="wait-reply-btn" title="ç­‰å¾…å›å¤"><img src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="ç­‰å¾…å›å¤"></button>
<button id="send-btn" class="action-button">å‘é€</button>
</div>
</div>
</div>

<!-- ===== è¡¨æƒ…é¢æ¿ ===== -->
<div id="sticker-panel">
<div id="sticker-panel-header">
<div class="default-controls">
<span class="panel-btn" id="close-sticker-panel-btn">å–æ¶ˆ</span>
<span class="title">æˆ‘çš„è¡¨æƒ…</span>
<div style="display: flex; gap: 10px;">
<span class="panel-btn" id="add-sticker-btn">æ·»åŠ </span>
<span class="panel-btn" id="upload-sticker-btn">ä¸Šä¼ </span>
</div>
</div>
<div class="selection-controls" style="display: none;">
<span class="panel-btn" id="sticker-select-all-btn">å…¨é€‰</span>
<span class="panel-btn" id="sticker-selection-cancel-btn">å–æ¶ˆ</span>
<span id="sticker-selection-count"></span>
<span class="panel-btn" id="sticker-clear-all-btn" style="color: #ff3b30;">å…¨éƒ¨åˆ é™¤</span>
<span class="panel-btn" id="sticker-selection-delete-btn" style="color: #ff3b30;">åˆ é™¤</span>
</div>
</div>
<div id="sticker-grid"></div>
</div>
<input type="file" id="sticker-upload-input" accept="image//,.json" style="display: none;">
<input type="file" id="image-upload-input" accept="image//" style="display: none;">

<!-- ===== éŸ³ä¹æ’­æ”¾å™¨é®ç½©å±‚ ===== -->
<div id="music-player-overlay">
<div class="music-player-window">
<div id="music-time-counter">å·²ç»ä¸€èµ·å¬äº†0.0å°æ—¶</div> 
<i class="fa-solid fa-headphones" id="mini-lyrics-btn" style="position: absolute; top: 22px; right: 40px; width: 20px; cursor: pointer;"></i>
<span id="music-playlist-btn">â˜°</span>
<div class="music-player-main">
<div class="album-cover-container">
<div id="album-cover">
<img id="album-cover-img" src="https://files.catbox.moe/g1dur6.png" alt="ä¸“è¾‘å°é¢">
</div>
</div>
<div class="music-control-area">
<div class="song-info">
<div class="song-text">
<div id="music-player-song-title">è¯·æ·»åŠ æ­Œæ›²</div>
<div id="music-player-artist">...</div>
</div>
<button id="music-favorite-btn" class="favorite-btn"><i class="fa-regular fa-heart"></i></button>
</div>
<div class="progress-container">
<input type="range" id="music-progress" class="progress-slider" min="0" max="100" value="0">
</div>
<div class="audio-visualizer">
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
<div class="visualizer-bar"></div>
</div>
<div class="music-controls">
<button id="music-shuffle-btn" class="control-btn"><i class="fa-solid fa-shuffle"></i></button>
<button id="music-prev-btn" class="control-btn"><i class="fa-solid fa-backward"></i></button>
<button id="music-play-pause-btn" class="play-pause-btn"><i class="fa-solid fa-circle-play"></i></button>
<button id="music-next-btn" class="control-btn"><i class="fa-solid fa-forward"></i></button>
<button id="music-repeat-btn" class="control-btn"><i class="fa-solid fa-repeat"></i></button>
</div>
</div>
</div>
<div class="music-bottom-actions">
<button id="music-exit-btn">é€€å‡ºä¸€èµ·å¬</button>
<button id="music-return-btn">è¿”å›èŠå¤©</button>
</div>
</div>
</div>

<!-- ===== éŸ³ä¹æ’­æ”¾åˆ—è¡¨é¢æ¿ ===== -->
<div id="music-playlist-panel">
<div class="playlist-header">
<span class="panel-btn" id="close-playlist-btn">è¿”å›</span>
<span>æ’­æ”¾åˆ—è¡¨</span>
<div>
<span class="panel-btn" id="search-music-btn"><i class="fa-solid fa-record-vinyl"></i></span>
<span class="panel-btn" id="add-song-local-btn">æœ¬åœ°</span>
<span class="panel-btn" id="add-song-url-btn">URL</span>
</div>
</div>
<div class="playlist-body" id="playlist-body"></div>
</div>
<input type="file" id="local-song-upload-input" accept="audio//" multiple style="display: none;">
</div>

<!-- ===== éŸ³ä¹æœç´¢æ¨¡æ€æ¡† ===== -->
<div id="music-search-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>æœç´¢éŸ³ä¹</span>
<span class="modal-close-btn" id="close-music-search-modal">&times;</span>
</div>
<div class="modal-body">
<div class="form-group">
<label for="music-search-input">è¾“å…¥æ­Œåæˆ–æ­Œæ‰‹å</label>
<input type="text" id="music-search-input" placeholder="ä¾‹å¦‚ï¼šä¸ƒé‡Œé¦™ å‘¨æ°ä¼¦">
</div>
<button class="form-button" id="search-music-btn-modal">æœç´¢</button>
<div id="music-search-results" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
</div>
</div>
</div>
</div>

<!-- ===== å£çº¸è®¾ç½®é¡µé¢ ===== -->
<div id="wallpaper-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>å£çº¸è®¾ç½®</span><span style="width: 30px;"></span></div><div class="form-container"><div id="wallpaper-preview">ç‚¹å‡»ä¸‹æ–¹ä¸Šä¼ </div><button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">ä¸Šä¼ å£çº¸</button><input type="file" id="wallpaper-upload-input" accept="image//"><button class="form-button" id="save-wallpaper-btn">ä¿å­˜å¹¶åº”ç”¨</button></div></div>

<!-- ===== å­—ä½“è®¾ç½®é¡µé¢ ===== -->
<div id="font-settings-screen" class="screen">
<div class="header">
<span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
<span>å­—ä½“è®¾ç½®</span>
<span style="width: 30px;"></span>
</div>
<div class="form-container">
<div class="form-group">
<label for="font-url-input">å­—ä½“æ–‡ä»¶URL (.ttf, .otf, .woffç­‰)</label>
<input type="text" id="font-url-input" placeholder="https://..../font.ttf">
</div>
<div class="form-group">
<label>å®æ—¶é¢„è§ˆ</label>
<div id="font-preview" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9;">
<p style="font-size: 20px; margin: 0 0 10px 0;">ä½ å¥½ä¸–ç•Œ Hello World</p>
<p style="margin: 0;">è¿™æ˜¯å­—ä½“é¢„è§ˆæ•ˆæœï¼Œ12345ã€‚</p>
</div>
</div>
<button class="form-button" id="save-font-btn">ä¿å­˜å¹¶åº”ç”¨</button>
<button class="form-button form-button-secondary" id="reset-font-btn">æ¢å¤é»˜è®¤å­—ä½“</button>
</div>
</div>

<!-- ===== æ‰‹æœºå±å¹•ç»“æŸæ ‡ç­¾ ===== -->
</div>
</div>

<!-- ===== èŠå¤©è®¾ç½®æ¨¡æ€æ¡† ===== -->
<div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>èŠå¤©è®¾ç½®</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">å¤‡æ³¨å / ç¾¤å</label><input type="text" id="chat-name-input"></div><div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">æˆ‘çš„ç¾¤æ˜µç§°</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>ç¾¤å¤´åƒ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">ä¸Šä¼ ç¾¤å¤´åƒ</button><input type="file" id="group-avatar-input" accept="image//"></div></div>
<div class="form-group" id="world-book-link-group">
<label>å…³è”ä¸–ç•Œä¹¦</label>
<div class="world-book-selector-summary">
<div id="linked-world-books-display">æœªé€‰æ‹©ä»»ä½•ä¸–ç•Œä¹¦</div>
<button type="button" class="form-button" id="open-world-book-selector">é€‰æ‹©ä¸–ç•Œä¹¦</button>
</div>
</div>
<div class="form-group" id="ai-persona-group"><label for="ai-persona">å¯¹æ–¹äººè®¾ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>å¯¹æ–¹å¤´åƒ</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ä¸Šä¼ å¯¹æ–¹å¤´åƒ</button><button class="change-frame-btn" data-type="ai">æ›´æ¢å¤´åƒæ¡†</button><button id="export-ai-character-btn" style="font-size: 13px; padding: 6px 10px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; margin-left: 10px; color: #000;">å¯¼å‡ºè§’è‰²å¡</button><input type="file" id="ai-avatar-input" accept="image//"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">æˆ‘çš„äººè®¾ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>æˆ‘çš„å¤´åƒ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ä¸Šä¼ æˆ‘çš„å¤´åƒ</button><button class="change-frame-btn" data-type="my">æ›´æ¢å¤´åƒæ¡†</button><button id="open-persona-library-btn">é¢„è®¾</button><input type="file" id="my-avatar-input" accept="image//"></div></div><div class="form-group" id="group-members-group"><label>ç¾¤æˆå‘˜äººè®¾</label><div id="group-members-settings"></div></div><div class="form-group"><label for="max-memory">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label for="visible-message-limit">èŠå¤©æ˜¾ç¤ºæ¡æ•° (0=æ˜¾ç¤ºå…¨éƒ¨)</label><div style="display: flex; align-items: center; gap: 10px;"><input type="range" id="visible-message-limit-slider" min="0" max="100" value="20" style="flex: 1;"><span id="visible-message-limit-value" style="min-width: 40px; text-align: center; font-weight: bold; color: var(--accent-color);">20</span></div><p style="font-size: 12px; color: #666; margin-top: 5px;">è®¾ç½®ä¸º0å°†æ˜¾ç¤ºå…¨éƒ¨æ¶ˆæ¯ï¼Œæ•°å€¼è¶Šå°æ€§èƒ½è¶Šå¥½</p></div><div class="form-group"><label>èŠå¤©æ°”æ³¡ä¸»é¢˜ <button id="reset-theme-btn" type="button">é‡ç½®</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> é»˜è®¤</label><label><input type="radio" name="theme-select" value="pink_blue"> ç²‰è“</label><label><input type="radio" name="theme-select" value="blue_white"> è“ç™½</label><label><input type="radio" name="theme-select" value="purple_yellow"> ç´«é»„</label><label><input type="radio" name="theme-select" value="black_white"> é»‘ç™½</label><label><input type="radio" name="theme-select" value="yellow_white"> é»„ç™½</label><label><input type="radio" name="theme-select" value="red_black"> çº¢é»‘</label><label><input type="radio" name="theme-select" value="blue_yellow"> è“é»„</label><label><input type="radio" name="theme-select" value="pink_yellow"> ç²‰é»„</label><label><input type="radio" name="theme-select" value="pink_purple"> ç²‰ç´«</label><label><input type="radio" name="theme-select" value="gray_white"> ç°ç™½</label><label><input type="radio" name="theme-select" value="blue_green"> è“ç»¿</label><label><input type="radio" name="theme-select" value="pink_white"> ç²‰ç™½</label><label><input type="radio" name="theme-select" value="pink_black"> ç²‰é»‘</label><label><input type="radio" name="theme-select" value="pink_green"> ç²‰ç»¿</label><label><input type="radio" name="theme-select" value="green_black"> ç»¿é»‘</label></div></div>
<div class="form-group">
<label>èŠå¤©èƒŒæ™¯</label>
<div class="bg-upload-container">
<button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ä¸Šä¼ èƒŒæ™¯å›¾</button>
<button type="button" id="remove-bg-btn">ç§»é™¤èƒŒæ™¯</button>
</div>
<img id="bg-preview" class="bg-preview-img">
<input type="file" id="bg-input" accept="image//" style="display: none;">
</div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="download-chat-btn">ä¸‹è½½èŠå¤©è®°å½•</button><button class="form-button form-button-secondary" id="upload-chat-btn">ä¸Šä¼ èŠå¤©è®°å½•</button><button class="form-button form-button-secondary" id="clear-chat-btn">æ¸…ç©ºèŠå¤©è®°å½•</button><input type="file" id="chat-upload-input" accept=".json" style="display: none;"></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">å–æ¶ˆ</button><button class="save" id="save-chat-settings-btn">ä¿å­˜</button></div></div></div>

<!-- ===== äººè®¾åº“æ¨¡æ€æ¡† ===== -->
<div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>æˆ‘çš„äººè®¾åº“</span><div class="header-actions"><div class="default-controls" style="display: flex; align-items: center; gap: 8px;"><i id="import-persona-json-btn" class="fa-solid fa-user" title="å¯¼å…¥äººè®¾JSON" style="cursor: pointer; color: var(--accent-color); font-size: 18px; padding: 0; border: none; background: none;"></i><button id="add-persona-preset-btn" class="action-button">æ·»åŠ </button></div><div class="selection-controls" style="display: none; gap: 15px; align-items: center;"><span id="persona-select-all-btn" style="color: #007bff; cursor: pointer;">å…¨é€‰</span><span id="persona-selection-cancel-btn" style="cursor: pointer;">å–æ¶ˆ</span><span id="persona-selection-count"></span><span id="persona-selection-delete-btn" style="color: #ff3b30; cursor: pointer;">åˆ é™¤</span></div></div></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">å…³é—­</button></div></div></div>

<!-- ===== äººè®¾ç¼–è¾‘æ¨¡æ€æ¡† ===== -->
<div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">æ·»åŠ äººè®¾é¢„è®¾</span></div><div class="modal-body"><div class="form-group"><label>é¢„è®¾å¤´åƒ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><input type="file" id="preset-avatar-input" accept="image//"></div></div><div class="form-group"><label for="preset-persona-input">é¢„è®¾äººè®¾</label><textarea id="preset-persona-input" rows="4" placeholder="åœ¨æ­¤è¾“å…¥è¿™ä¸ªäººè®¾çš„è¯¦ç»†è®¾å®š..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">å–æ¶ˆ</button><button class="save" id="save-persona-preset-btn">ä¿å­˜</button></div></div></div>

<!-- ===== ç¾¤æˆå‘˜è®¾ç½®æ¨¡æ€æ¡† ===== -->
<div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ç¼–è¾‘ç¾¤æˆå‘˜</span></div><div class="modal-body">
<div class="form-group"><label for="member-name-input">åå­—</label><input type="text" id="member-name-input"></div>
<div class="form-group"><label for="member-persona-input">äººè®¾</label><textarea id="member-persona-input" rows="4"></textarea></div>
<div class="form-group"><label>å¤´åƒ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ä¸Šä¼ å¤´åƒ</button><button class="change-frame-btn" data-type="member">æ›´æ¢å¤´åƒæ¡†</button><button id="import-member-character-btn" style="font-size: 13px; padding: 6px 10px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; margin-left: 10px; color: #000;">å¯¼å…¥è§’è‰²å¡</button><button id="export-member-character-btn" style="font-size: 13px; padding: 6px 10px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; margin-left: 10px; color: #000;">å¯¼å‡ºè§’è‰²å¡</button><input type="file" id="member-avatar-input" accept="image//"></div></div>
</div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">å–æ¶ˆ</button><button class="save" id="save-member-settings-btn">ä¿å­˜</button></div></div></div>

<!-- ===== è‡ªå®šä¹‰æ¨¡æ€æ¡† ===== -->
<div id="custom-modal-overlay">
<div id="custom-modal">
<div class="custom-modal-header" id="custom-modal-title"></div>
<div class="custom-modal-body" id="custom-modal-body"></div>
<div class="custom-modal-footer">
<button id="custom-modal-cancel">å–æ¶ˆ</button>
<button id="custom-modal-confirm" class="confirm-btn">ç¡®å®š</button>
</div>
</div>
</div>

<!-- ===== é¢„è®¾æ“ä½œæ¨¡æ€æ¡† ===== -->
<div id="preset-actions-modal" class="modal">
<div id="custom-modal" style="width: 250px;">
<div class="custom-modal-footer">
<button id="preset-action-edit">ç¼–è¾‘é¢„è®¾</button>
<button id="preset-action-delete" class="btn-danger">åˆ é™¤é¢„è®¾</button>
<button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">å–æ¶ˆ</button>
</div>
</div>
</div>

<!-- ===== è½¬è´¦æ¨¡æ€æ¡† ===== -->
<div id="transfer-modal">
<div class="transfer-content">
<div class="transfer-header">ç»™Taä¸€ä¸ªæƒŠå–œï¼</div>
<div class="transfer-input-group">
<label for="transfer-amount">è½¬è´¦é‡‘é¢</label>
<input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
</div>
<div class="transfer-input-group">
<label for="transfer-note">å¤‡æ³¨ (å¯é€‰)</label>
<input type="text" id="transfer-note" placeholder="ç•™ä¸‹ä½ çš„å°å¿ƒæ€~" maxlength="20">
</div>
<div class="transfer-actions">
<button id="transfer-cancel-btn">å–æ¶ˆ</button>
<button id="transfer-confirm-btn">ç¡®è®¤è½¬è´¦</button>
</div>
</div>
</div>

<!-- ===== ç”µæ± æé†’æ¨¡æ€æ¡† ===== -->
<div id="battery-alert-modal">
<div class="battery-alert-content">
<img id="battery-alert-image" src="">
<p id="battery-alert-text"></p>
</div>
</div>

<!-- ===== å¤´åƒæ¡†é€‰æ‹©æ¨¡æ€æ¡† ===== -->
<div id="avatar-frame-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>é€‰æ‹©å¤´åƒæ¡†</span>
</div>
<div class="modal-body">
<div class="frame-tabs">
<div id="ai-frame-tab" class="frame-tab active">å¯¹æ–¹çš„</div>
<div id="my-frame-tab" class="frame-tab">æˆ‘çš„</div>
</div>
<div id="ai-frame-content" class="frame-content">
<div id="ai-frame-grid" class="frame-grid">
</div>
</div>
<div id="my-frame-content" class="frame-content" style="display: none;">
<div id="my-frame-grid" class="frame-grid">
</div>
</div>
</div>
<div class="modal-footer">
<button class="cancel" id="cancel-frame-settings-btn">å–æ¶ˆ</button>
<button class="save" id="save-frame-settings-btn">ä¿å­˜</button>
</div>
</div>
</div>

<!-- ===== ä¸–ç•Œä¹¦é€‰æ‹©æ¨¡æ€æ¡† ===== -->
<div id="world-book-selector-modal" class="modal">
<div class="modal-content">
<div class="modal-header">
<span>é€‰æ‹©å…³è”ä¸–ç•Œä¹¦</span>
<span class="modal-close-btn" id="close-world-book-selector">&times;</span>
</div>
<div class="modal-body">
<div id="world-book-selector-content">
<div class="wb-selector-toolbar">
<button id="wb-select-all-folders" class="form-button form-button-secondary">å…¨é€‰æ‰€æœ‰</button>
<button id="wb-clear-all-selections" class="form-button form-button-secondary">æ¸…ç©ºé€‰æ‹©</button>
<span id="wb-selection-summary">å·²é€‰æ‹© 0 æœ¬ä¸–ç•Œä¹¦</span>
</div>
<div id="world-book-folder-list">
</div>
</div>
</div>
<div class="modal-footer">
<button class="cancel" id="cancel-world-book-selector">å–æ¶ˆ</button>
<button class="save" id="confirm-world-book-selector">ç¡®å®š</button>
</div>
</div>
</div>

<!-- ===== å¤´åƒç¼–è¾‘æ¨¡æ€æ¡† ===== -->
<div id="avatar-editor-modal" class="modal">
<div class="modal-content" style="height: 80%; max-height: 600px;">
<div class="modal-header">
<span>ç¼–è¾‘å¤´åƒ</span>
<span class="modal-close-btn" id="close-avatar-editor">&times;</span>
</div>
<div class="modal-body" style="display: flex; flex-direction: column; padding: 0;">
<div id="avatar-editor-container" style="flex: 1; position: relative; overflow: hidden; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">
<div id="avatar-crop-area" style="width: 200px; height: 200px; border: 2px solid #007bff; border-radius: 50%; position: relative; overflow: hidden; background: white;">
<img id="avatar-crop-image" style="position: absolute; cursor: move; user-select: none; -webkit-user-select: none;">
</div>
</div>
<div style="padding: 15px; border-top: 1px solid #eee;">
<div style="margin-bottom: 15px;">
<label style="display: block; margin-bottom: 8px; font-size: 14px; color: #666;">ç¼©æ”¾å¤§å°:</label>
<input type="range" id="avatar-scale-slider" min="0.5" max="3" step="0.1" value="1" style="width: 100%;">
</div>
<div style="display: flex; gap: 10px;">
<button id="avatar-editor-cancel" style="flex: 1; padding: 12px; border: 1px solid #ccc; background: white; border-radius: 8px; cursor: pointer;">å–æ¶ˆ</button>
<button id="avatar-editor-save" style="flex: 1; padding: 12px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer;">ä¿å­˜å¤´åƒ</button>
</div>
</div>
</div>
</div>
</div>

<input type="file" id="avatar-file-input" accept="image/*" style="display: none;">

<audio id="audio-player" style="display:none;"></audio>

<!-- ===== JavaScript ä¸»è„šæœ¬ ===== -->
    <script>
    function showScreen(screenId) {
        if (screenId === 'chat-list-screen') window.renderChatListProxy(); 
        if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
        if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
        if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screenToShow = document.getElementById(screenId);
        if (screenToShow) screenToShow.classList.add('active');
        if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);

      // === æ–°å¢ï¼šè¿›å…¥å­—ä½“è®¾ç½®é¡µé¢æ—¶ï¼Œåˆå§‹åŒ–è¾“å…¥æ¡†å’Œé¢„è§ˆåŒº ===
        if (screenId === 'font-settings-screen') {
            document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
            applyCustomFont(state.globalSettings.fontUrl || '', true);
        }
      
    }

    window.updateListenTogetherIconProxy = () => {};

    document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('GeminiChatDB');
      const dynamicFontStyle = document.createElement('style');
    dynamicFontStyle.id = 'dynamic-font-style';
    document.head.appendChild(dynamicFontStyle);

      /**
     * åº”ç”¨è‡ªå®šä¹‰å­—ä½“
     * @param {string} fontUrl å­—ä½“çš„URL
     * @param {boolean} isPreviewOnly æ˜¯å¦åªåº”ç”¨äºé¢„è§ˆåŒºåŸŸ
     */
    function applyCustomFont(fontUrl, isPreviewOnly = false) {
        if (!fontUrl) {
            dynamicFontStyle.innerHTML = '';
            document.getElementById('font-preview').style.fontFamily = '';
            return;
        }
        const fontName = 'custom-user-font';
        const newStyle = `
            @font-face {
              font-family: '${fontName}';
              src: url('${fontUrl}');
              font-display: swap;
            }`;
        if (isPreviewOnly) {
            const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
            previewStyle.id = 'preview-font-style';
            previewStyle.innerHTML = newStyle;
            if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
            document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
        } else {
            dynamicFontStyle.innerHTML = `
                ${newStyle}
                body {
                  font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                }`;
        }
    }

    /**
     * æ¢å¤é»˜è®¤å­—ä½“
     */
    async function resetToDefaultFont() {
        dynamicFontStyle.innerHTML = ''; 
        state.globalSettings.fontUrl = '';
        await db.globalSettings.put(state.globalSettings);
        document.getElementById('font-url-input').value = '';
        document.getElementById('font-preview').style.fontFamily = '';
        alert('å·²æ¢å¤é»˜è®¤å­—ä½“ã€‚');
    }
      
        db.version(10).stores({ 
    chats: '&id, isGroup', 
    apiConfig: '&id', 
    globalSettings: '&id', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name, folderId',
    worldBookFolders: '&id, name',
    musicLibrary: '&id', 
    personaPresets: '&id'
});

        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], worldBookFolders: [], personaPresets: [] };
let worldBookSelectionMode = false;
let selectedWorldBooks = new Set();
let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, totalElapsedTime: 0, timerId: null, repeatMode: 'off', isRandom: false };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingFrameForMember = false;
        let editingWorldBookId = null;
let editingPersonaPresetId = null;
let worldBookScrollPosition = 0;
        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
      // åœ¨è¿™é‡Œæ·»åŠ 
const avatarFrames = [
    { id: 'none', url: '', name: 'æ— ' }, // ç¬¬ä¸€ä¸ªæ˜¯â€œæ— â€æˆ–â€œé»˜è®¤â€
    { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' },
  
  { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' },

  { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' },

      { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' },

      { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' },

          { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' },

  { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' },

  { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' },

  { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' },

      { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' },
    { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' },
    { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' },
    { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' },
  { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' },
    { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' },
    { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' },
  { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' },
    { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' },
    { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' },
    { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' },
  { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' },
  { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },

          { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
  
  
  { id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
    // åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä½ çš„å¤´åƒæ¡†å¤–é“¾... { id: '...', url: '...', name: '...' }
];
let currentFrameSelection = { ai: null, my: null };
        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        
        const MESSAGE_RENDER_WINDOW = 50;
        let VISIBLE_MESSAGE_LIMIT = 10; // å¯è§æ¶ˆæ¯é™åˆ¶ï¼ˆåŠ¨æ€å¯è°ƒï¼‰
        let currentRenderedCount = 0;
        let isShowingAllMessages = false; // æ˜¯å¦æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯

        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;

        async function loadAllDataFromDB() { const [chatsArr, apiConfig, globalSettings, userStickers, worldBooks, worldBookFolders, musicLib, personaPresets] = await Promise.all([ db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'), db.userStickers.toArray(), db.worldBooks.toArray(), db.worldBookFolders.toArray(), db.musicLibrary.get('main'), db.personaPresets.toArray() ]); state.chats = chatsArr.reduce((acc, chat) => { if (!chat.musicData) chat.musicData = { totalTime: 0 }; if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; } acc[chat.id] = chat; return acc; }, {}); state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' }; state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', fontUrl: '' }; state.userStickers = userStickers || []; state.worldBooks = worldBooks || []; state.worldBookFolders = worldBookFolders || []; musicState.playlist = musicLib?.playlist || [];
musicState.repeatMode = musicLib?.repeatMode || 'off';
musicState.isRandom = musicLib?.isRandom || false; state.personaPresets = personaPresets || []; }
        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist, repeatMode: musicState.repeatMode, isRandom: musicState.isRandom }); }

        const modalOverlay = document.getElementById('custom-modal-overlay');
const modalTitle = document.getElementById('custom-modal-title');
const modalBody = document.getElementById('custom-modal-body');
const modalConfirmBtn = document.getElementById('custom-modal-confirm');
const modalCancelBtn = document.getElementById('custom-modal-cancel');
const chatSettingsModal = document.getElementById('chat-settings-modal');
let modalResolve;

        function showCustomModal() { modalOverlay.classList.add('visible'); }
        function hideCustomModal() { modalOverlay.classList.remove('visible'); modalConfirmBtn.classList.remove('btn-danger'); if (modalResolve) modalResolve(null); }
        modalCancelBtn.addEventListener('click', hideCustomModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ç¡®å®š';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'å¥½çš„';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ç¡®å®š';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<input type="${type}" id="custom-prompt-input" placeholder="${placeholder}" value="${initialValue}">`;
                const input = document.getElementById('custom-prompt-input');
                modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        
        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }
        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }
        function parseAiResponse(content) { try { const parsed = JSON.parse(content); if (Array.isArray(parsed)) return parsed; } catch (e) {} try { const match = content.match(/\[(.*?)\]/s); if (match && match[0]) { const parsed = JSON.parse(match[0]); if (Array.isArray(parsed)) return parsed; } } catch (e) {} const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); if (lines.length > 0) return lines; return [content]; }
        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; }
        window.renderApiSettingsProxy = renderApiSettings;
        
        function renderChatList() { const chatListEl = document.getElementById('chat-list'); chatListEl.innerHTML = ''; if (Object.keys(state.chats).length === 0) { chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" æˆ–ç¾¤ç»„å›¾æ ‡æ·»åŠ èŠå¤©</p>'; return; } Object.values(state.chats).sort((a,b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0)).forEach(chat => { const lastMsgObj = chat.history.slice(-1)[0] || {}; let lastMsgDisplay; if(lastMsgObj.type === 'transfer') { lastMsgDisplay = '[è½¬è´¦]'; } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ç…§ç‰‡]'; } else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[è¯­éŸ³]'; } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[è¡¨æƒ…: ${lastMsgObj.meaning}]` : '[è¡¨æƒ…]'; } else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[å›¾ç‰‡]`; } else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); } if (chat.isGroup && lastMsgObj.senderName) { lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`; } const item = document.createElement('div'); item.className = 'chat-list-item'; item.dataset.chatId = chat.id; const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar; item.innerHTML = `<img src="${avatar || defaultAvatar}" class="avatar"><div class="info"><div class="name-line"><span class="name">${chat.name}</span>${chat.isGroup ? '<span class="group-tag">ç¾¤èŠ</span>' : ''}</div><div class="last-msg">${lastMsgDisplay}</div></div>`; item.addEventListener('click', async () => { openChat(chat.id); }); addLongPressListener(item, async (e) => { const confirmed = await showCustomConfirm('åˆ é™¤å¯¹è¯', `ç¡®å®šè¦åˆ é™¤ä¸ "${chat.name}" çš„æ•´ä¸ªå¯¹è¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { try { if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false); delete state.chats[chat.id]; if (state.activeChatId === chat.id) state.activeChatId = null; await db.chats.delete(chat.id); renderChatList(); } catch (error) { console.error("åˆ é™¤èŠå¤©å¤±è´¥:", error); alert("åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚"); } } }); chatListEl.appendChild(item); }); }
        window.renderChatListProxy = renderChatList;
        
        function renderChatInterface(chatId) { const chat = state.chats[chatId]; if (!chat) return; exitSelectionMode(); const messagesContainer = document.getElementById('chat-messages'); messagesContainer.dataset.theme = chat.settings.theme || 'default'; document.getElementById('chat-header-title').textContent = chat.name; messagesContainer.innerHTML = ''; const chatScreen = document.getElementById('chat-interface-screen'); chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none'; chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5'; const history = chat.history; const totalMessages = history.length; currentRenderedCount = 0; isShowingAllMessages = false; // é‡ç½®çŠ¶æ€
        
        // è·å–å½“å‰èŠå¤©çš„æ˜¾ç¤ºé™åˆ¶è®¾ç½®
        const currentLimit = chat.settings.visibleMessageLimit !== undefined ? chat.settings.visibleMessageLimit : VISIBLE_MESSAGE_LIMIT;
        
        // å†³å®šæ˜¾ç¤ºçš„æ¶ˆæ¯æ•°é‡
        let messagesToShow;
        if (currentLimit === 0 || totalMessages <= currentLimit) {
            // è®¾ç½®ä¸º0æˆ–æ¶ˆæ¯æ€»æ•°ä¸è¶…è¿‡é™åˆ¶ï¼Œæ˜¾ç¤ºå…¨éƒ¨
            messagesToShow = history;
            isShowingAllMessages = true;
        } else {
            // æ¶ˆæ¯è¶…è¿‡é™åˆ¶ï¼Œåªæ˜¾ç¤ºæœ€è¿‘çš„æ¶ˆæ¯
            messagesToShow = history.slice(-currentLimit);
            // æ·»åŠ "æŸ¥çœ‹æ›´å¤š"æŒ‰é’®
            prependShowMoreButton(messagesContainer, totalMessages - currentLimit);
        }
        
        messagesToShow.forEach(msg => appendMessage(msg, chat, true)); currentRenderedCount = messagesToShow.length; const typingIndicator = document.createElement('div'); typingIndicator.id = 'typing-indicator'; typingIndicator.style.display = 'none'; typingIndicator.textContent = 'å¯¹æ–¹æ­£åœ¨è¾“å…¥...'; messagesContainer.appendChild(typingIndicator); 
            
            // åˆå§‹åŒ–æ»šåŠ¨ç›‘å¬å’Œå›åˆ°åº•éƒ¨æŒ‰é’®
            initScrollToBottomButton();
            
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0); }
        
        // åˆå§‹åŒ–å›åˆ°åº•éƒ¨æŒ‰é’®åŠŸèƒ½
        function initScrollToBottomButton() {
            const messagesContainer = document.getElementById('chat-messages');
            const scrollBtn = document.getElementById('scroll-to-bottom-btn');
            
            if (!messagesContainer || !scrollBtn) return;
            
            // ç§»é™¤ä¹‹å‰çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            messagesContainer.removeEventListener('scroll', handleChatScroll);
            scrollBtn.removeEventListener('click', scrollToBottom);
            
            // æ·»åŠ æ–°çš„ç›‘å¬å™¨
            messagesContainer.addEventListener('scroll', handleChatScroll);
            scrollBtn.addEventListener('click', scrollToBottom);
        }
        
        function handleChatScroll() {
            const messagesContainer = document.getElementById('chat-messages');
            const scrollBtn = document.getElementById('scroll-to-bottom-btn');
            
            if (!messagesContainer || !scrollBtn) return;
            
            // æ£€æŸ¥æ˜¯å¦æ¥è¿‘åº•éƒ¨ï¼ˆå®¹å¿50pxçš„è¯¯å·®ï¼‰
            const isNearBottom = messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - 50;
            
            if (isNearBottom) {
                scrollBtn.classList.remove('visible');
            } else {
                scrollBtn.classList.add('visible');
            }
        }
        
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chat-messages');
            if (messagesContainer) {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'åŠ è½½æ›´æ—©çš„è®°å½•'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        
        function prependShowMoreButton(container, hiddenCount) {
            const button = document.createElement('button');
            button.id = 'show-more-btn';
            button.textContent = `ä¸Šæ»‘æŸ¥çœ‹æ›´å¤š (${hiddenCount}æ¡éšè—æ¶ˆæ¯)`;
            button.style.cssText = `
                text-align: center; 
                padding: 12px; 
                color: var(--accent-color); 
                font-size: 14px; 
                cursor: pointer; 
                background-color: rgba(255, 255, 255, 0.9); 
                border: 1px solid var(--border-color); 
                border-radius: 8px; 
                margin: 10px; 
                width: calc(100% - 20px);
                transition: all 0.2s ease;
            `;
            button.addEventListener('click', showAllMessages);
            button.addEventListener('mouseover', () => {
                button.style.backgroundColor = 'rgba(0, 123, 255, 0.1)';
            });
            button.addEventListener('mouseout', () => {
                button.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
            });
            container.prepend(button);
        }
        
        function showAllMessages() {
            if (isShowingAllMessages) return;
            
            const chat = state.chats[state.activeChatId];
            if (!chat) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            const showMoreBtn = document.getElementById('show-more-btn');
            
            if (showMoreBtn) showMoreBtn.remove();
            
            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const oldScrollHeight = messagesContainer.scrollHeight;
            
            // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            const allMessages = chat.history;
            const currentMessages = messagesContainer.querySelectorAll('.message-wrapper').length;
            const messagesToPrepend = allMessages.slice(0, allMessages.length - currentMessages);
            
            // å€’åºæ·»åŠ åˆ°å‰é¢
            messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat));
            
            // è°ƒæ•´æ»šåŠ¨ä½ç½®ï¼Œä¿æŒç”¨æˆ·å½“å‰æŸ¥çœ‹çš„ä½ç½®
            const newScrollHeight = messagesContainer.scrollHeight;
            messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight);
            
            isShowingAllMessages = true;
            currentRenderedCount = allMessages.length;
        }
        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }
        
        function renderWallpaperScreen() { const preview = document.getElementById('wallpaper-preview'); const bg = newWallpaperBase64 || state.globalSettings.wallpaper; if (bg && bg.startsWith('data:image')) { preview.style.backgroundImage = `url(${bg})`; preview.textContent = ''; } else if(bg) { preview.style.backgroundImage = bg; preview.textContent = 'å½“å‰ä¸ºæ¸å˜è‰²'; } }
        window.renderWallpaperScreenProxy = renderWallpaperScreen;
        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }
        function renderWorldBookScreen() { 
    const listEl = document.getElementById('world-book-list'); 
    listEl.innerHTML = ''; 
    
    if (state.worldBooks.length === 0 && state.worldBookFolders.length === 0) { 
        listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ç‚¹å‡»å³ä¸Šè§’ "+" åˆ›å»ºä½ çš„ç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦</p>'; 
        return; 
    } 
    
    // æ¸²æŸ“æ–‡ä»¶å¤¹
    state.worldBookFolders.forEach(folder => {
        const folderEl = document.createElement('div');
        folderEl.className = 'world-book-folder';
        folderEl.dataset.folderId = folder.id;
        
        const folderHeader = document.createElement('div');
        folderHeader.className = 'folder-header';
        folderHeader.innerHTML = `<span>${folder.name}</span><span class="folder-toggle">â–¼</span>`;
        
        const folderItems = document.createElement('div');
        folderItems.className = 'folder-items';
        
        // è·å–è¯¥æ–‡ä»¶å¤¹ä¸‹çš„ä¸–ç•Œä¹¦
        const booksInFolder = state.worldBooks.filter(book => book.folderId === folder.id);
        booksInFolder.forEach(book => {
            const item = createWorldBookItem(book);
            folderItems.appendChild(item);
        });
        
        if (booksInFolder.length === 0) {
            folderItems.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 20px;">æ–‡ä»¶å¤¹ä¸ºç©º</p>';
        }
        
        folderHeader.addEventListener('click', () => {
            folderEl.classList.toggle('collapsed');
        });
        
        addLongPressListener(folderHeader, async () => {
if (worldBookSelectionMode) return;
const confirmed = await showCustomConfirm('åˆ é™¤æ–‡ä»¶å¤¹', `ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹"${folder.name}"å—ï¼Ÿ\næ–‡ä»¶å¤¹å†…çš„ä¸–ç•Œä¹¦ä¹Ÿä¼šè¢«åˆ é™¤ï¼`, { confirmButtonClass: 'btn-danger' });
if (confirmed) {
worldBookScrollPosition = document.getElementById('world-book-list').scrollTop;
const booksToDelete = state.worldBooks.filter(book => book.folderId === folder.id);
for (const book of booksToDelete) {
await db.worldBooks.delete(book.id);
}
state.worldBooks = state.worldBooks.filter(book => book.folderId !== folder.id);
await db.worldBookFolders.delete(folder.id);
state.worldBookFolders = state.worldBookFolders.filter(f => f.id !== folder.id);
renderWorldBookScreen();
setTimeout(() => { document.getElementById('world-book-list').scrollTop = worldBookScrollPosition; }, 50);
}
});
        
        folderEl.appendChild(folderHeader);
        folderEl.appendChild(folderItems);
        listEl.appendChild(folderEl);
    });
    
    // æ¸²æŸ“æœªåˆ†ç»„çš„ä¸–ç•Œä¹¦
    const ungroupedBooks = state.worldBooks.filter(book => !book.folderId);
    if (ungroupedBooks.length > 0) {
        const ungroupedHeader = document.createElement('div');
        ungroupedHeader.style.cssText = 'padding: 15px 20px; font-weight: 600; color: #666; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;';
        ungroupedHeader.textContent = 'æœªåˆ†ç»„';
        listEl.appendChild(ungroupedHeader);
        
        ungroupedBooks.forEach(book => {
            const item = createWorldBookItem(book);
            listEl.appendChild(item);
        });
    }
}

function createWorldBookItem(book) {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.style.position = 'relative';
    item.dataset.bookId = book.id;
    item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'æš‚æ— å†…å®¹...').substring(0, 50)}</div>`;
    
    item.addEventListener('click', () => {
        if (worldBookSelectionMode) {
            toggleWorldBookSelection(book.id, item);
        } else {
            openWorldBookEditor(book.id);
        }
    });
    
    addLongPressListener(item, async () => {
        if (worldBookSelectionMode) return;
        enterWorldBookSelectionMode(book.id, item);
    });
    
    return item;
}

function enterWorldBookSelectionMode(initialBookId, initialItem) {
    worldBookSelectionMode = true;
    document.getElementById('world-book-screen').classList.add('selection-mode');
    toggleWorldBookSelection(initialBookId, initialItem);
}

function exitWorldBookSelectionMode() {
    worldBookSelectionMode = false;
    document.getElementById('world-book-screen').classList.remove('selection-mode');
    selectedWorldBooks.forEach(bookId => {
        const item = document.querySelector(`[data-book-id="${bookId}"]`);
        if (item) item.classList.remove('selected');
    });
    selectedWorldBooks.clear();
}

function toggleWorldBookSelection(bookId, item) {
    if (selectedWorldBooks.has(bookId)) {
        selectedWorldBooks.delete(bookId);
        item.classList.remove('selected');
    } else {
        selectedWorldBooks.add(bookId);
        item.classList.add('selected');
    }
    
    document.getElementById('wb-selection-count').textContent = `å·²é€‰ ${selectedWorldBooks.size} é¡¹`;
    
    if (selectedWorldBooks.size === 0) {
        exitWorldBookSelectionMode();
    }
}
        window.renderWorldBookScreenProxy = renderWorldBookScreen;
        function openWorldBookEditor(bookId) { 
worldBookScrollPosition = document.getElementById('world-book-list').scrollTop; 
editingWorldBookId = bookId; 
const book = state.worldBooks.find(wb => wb.id === bookId); 
if (!book) return; 
document.getElementById('world-book-editor-title').textContent = book.name; 
document.getElementById('world-book-name-input').value = book.name; 
document.getElementById('world-book-content-input').value = book.content; 
showScreen('world-book-editor-screen'); 
}
        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; updateStickerPanelMode(); if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">å¤§äººè¯·ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æˆ–"ä¸Šä¼ "æ¥æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ªè¡¨æƒ…å§ï¼</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.dataset.stickerId = sticker.id; if (selectedStickers.has(sticker.id)) { item.classList.add('selected'); } item.addEventListener('click', () => { if (stickerSelectionMode) { toggleStickerSelection(sticker.id, item); } else { sendSticker(sticker); } }); addLongPressListener(item, () => { if (stickerSelectionMode) return; if (isSelectionMode) return; enterStickerSelectionMode(sticker.id, item); }); grid.appendChild(item); }); }
function updateStickerPanelMode() { const panel = document.getElementById('sticker-panel'); const defaultControls = panel.querySelector('.default-controls'); const selectionControls = panel.querySelector('.selection-controls'); if (stickerSelectionMode) { defaultControls.style.display = 'none'; selectionControls.style.display = 'flex'; } else { defaultControls.style.display = 'flex'; selectionControls.style.display = 'none'; } }
function enterStickerSelectionMode(initialStickerId, initialItem) { stickerSelectionMode = true; toggleStickerSelection(initialStickerId, initialItem); }
function exitStickerSelectionMode() { stickerSelectionMode = false; selectedStickers.forEach(stickerId => { const item = document.querySelector(`[data-sticker-id="${stickerId}"]`); if (item) item.classList.remove('selected'); }); selectedStickers.clear(); renderStickerPanel(); }
function toggleStickerSelection(stickerId, item) { if (selectedStickers.has(stickerId)) { selectedStickers.delete(stickerId); item.classList.remove('selected'); } else { selectedStickers.add(stickerId); item.classList.add('selected'); } document.getElementById('sticker-selection-count').textContent = `å·²é€‰ ${selectedStickers.size} é¡¹`; if (selectedStickers.size === 0) { exitStickerSelectionMode(); } updateStickerPanelMode(); }
        
        
                    function createMessageElement(msg, chat) {
            const isUser = msg.role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;
            if (chat.isGroup && !isUser) {
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = msg.senderName || 'æœªçŸ¥æˆå‘˜';
                wrapper.appendChild(senderNameDiv);
            }
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;

            let avatarSrc;
            let avatarFrameSrc = '';
            if (chat.isGroup) {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    const member = chat.members.find(m => m.name === msg.senderName);
                    avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
                    avatarFrameSrc = member ? (member.avatarFrame || '') : '';
                }
            } else {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }

            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `
                    <div class="avatar-with-frame">
                        <img src="${avatarSrc}" class="avatar-img">
                        <img src="${avatarFrameSrc}" class="avatar-frame">
                    </div>
                `;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }

            let contentHtml;
            if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                bubble.classList.add('is-ai-image');
                const altText = msg.type === 'user_photo' ? "ç”¨æˆ·æè¿°çš„ç…§ç‰‡" : "AIç”Ÿæˆçš„å›¾ç‰‡";
                contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
            } else if (msg.type === 'voice_message') {
                bubble.classList.add('is-voice-message');
                const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
                contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
            } else if (msg.type === 'transfer') {
                bubble.classList.add('is-transfer');
                const titleText = isUser ? 'è½¬è´¦ç»™Ta' : 'æ”¶åˆ°ä¸€ç¬”è½¬è´¦';
                const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || 'å¯¹æ–¹æ²¡æœ‰ç•™ä¸‹å¤‡æ³¨å“¦~'}</div></div>`;
            } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                bubble.classList.add('is-sticker');
                contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                bubble.classList.add('has-image');
                const imageUrl = msg.content[0].image_url.url;
                contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
            
            // *** ä¸»è¦ä¿®æ”¹åœ¨è¿™é‡Œï¼šå°†æ—¶é—´æˆ³ä»æ°”æ³¡å†…éƒ¨ç§»å‡º ***
            // 1. ä¿®æ”¹ bubble.innerHTMLï¼Œä¸å†åŒ…å«æ—¶é—´æˆ³
            bubble.innerHTML = `<div class="avatar-group">${avatarHtml}</div><div class="content">${contentHtml}</div>`;
            
            // 2. åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨æ¥åŒ…è£¹æ°”æ³¡å’Œæ—¶é—´æˆ³
            const bubbleAndTimeContainer = document.createElement('div');
            bubbleAndTimeContainer.className = 'bubble-and-time-container';

            // 3. å•ç‹¬åˆ›å»ºæ—¶é—´æˆ³å…ƒç´ 
            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);

            // 4. å°†æ°”æ³¡å’Œæ—¶é—´æˆ³æ·»åŠ åˆ°æ–°å®¹å™¨ä¸­
            bubbleAndTimeContainer.appendChild(bubble);
            bubbleAndTimeContainer.appendChild(timestampEl);
            
            // äº‹ä»¶ç›‘å¬å™¨ä»ç„¶ç»‘å®šåœ¨bubbleä¸Š
            addLongPressListener(bubble, () => enterSelectionMode(msg.timestamp));
            bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
            
            // 5. å°†æ–°å®¹å™¨æ·»åŠ åˆ°ä¸»åŒ…è£…å™¨ä¸­
            wrapper.appendChild(bubbleAndTimeContainer);
            return wrapper;
        }


        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }
        function appendMessage(msg, chat, isInitialLoad = false) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const typingIndicator = document.getElementById('typing-indicator'); messagesContainer.insertBefore(messageEl, typingIndicator); if (!isInitialLoad) { 
            // è·å–å½“å‰èŠå¤©çš„æ˜¾ç¤ºé™åˆ¶è®¾ç½®
            const currentLimit = chat.settings.visibleMessageLimit !== undefined ? chat.settings.visibleMessageLimit : VISIBLE_MESSAGE_LIMIT;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦éšè—æ—§æ¶ˆæ¯
            if (!isShowingAllMessages && currentLimit > 0) {
                const messageWrappers = messagesContainer.querySelectorAll('.message-wrapper');
                if (messageWrappers.length > currentLimit) {
                    // ç§»é™¤æœ€æ—§çš„æ¶ˆæ¯ï¼Œä¿æŒåœ¨é™åˆ¶èŒƒå›´å†…
                    const messagesToRemove = messageWrappers.length - currentLimit;
                    for (let i = 0; i < messagesToRemove; i++) {
                        if (messageWrappers[i]) {
                            messageWrappers[i].remove();
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°æ·»åŠ "æŸ¥çœ‹æ›´å¤š"æŒ‰é’®
                    const totalMessages = chat.history.length;
                    const visibleMessages = messagesContainer.querySelectorAll('.message-wrapper').length;
                    const hiddenCount = totalMessages - visibleMessages;
                    
                    if (hiddenCount > 0 && !document.getElementById('show-more-btn')) {
                        prependShowMoreButton(messagesContainer, hiddenCount);
                    }
                }
            }
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
            currentRenderedCount++; 
        } }

        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }
        async function triggerAiResponse() { if (!state.activeChatId) return; const chatId = state.activeChatId; const chat = state.chats[chatId]; document.getElementById('typing-indicator').style.display = 'block'; const { proxyUrl, apiKey, model } = state.apiConfig; if (!proxyUrl || !apiKey || !model) { alert('è¯·å…ˆåœ¨APIè®¾ç½®ä¸­é…ç½®åä»£åœ°å€ã€å¯†é’¥å¹¶é€‰æ‹©æ¨¡å‹ã€‚'); document.getElementById('typing-indicator').style.display = 'none'; return; } const now = new Date(); const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true }); let worldBookContent = ''; if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) { const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => { const worldBook = state.worldBooks.find(wb => wb.id === bookId); return worldBook && worldBook.content ? `\n\n## ä¸–ç•Œä¹¦: ${worldBook.name}\n${worldBook.content}` : ''; }).filter(Boolean).join(''); if (linkedContents) { worldBookContent = `\n\n# æ ¸å¿ƒä¸–ç•Œè§‚è®¾å®š (å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è®¾å®š)\n${linkedContents}\n`; } } let musicContext = ''; if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) { const currentTrack = musicState.playlist[musicState.currentIndex]; musicContext = `\n\n# å½“å‰æƒ…æ™¯\nä½ æ­£åœ¨å’Œç”¨æˆ·ä¸€èµ·å¬æ­Œã€‚å½“å‰æ’­æ”¾çš„æ­Œæ›²æ˜¯ï¼š${currentTrack.name} - ${currentTrack.artist}ã€‚è¯·åœ¨å¯¹è¯ä¸­è‡ªç„¶åœ°èå…¥è¿™ä¸ªæƒ…å¢ƒã€‚\n`; } let systemPrompt, messagesPayload; const maxMemory = parseInt(chat.settings.maxMemory) || 10; const historySlice = chat.history.slice(-maxMemory); 
            const aiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ä½ æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚ä½ å‘é€ç…§ç‰‡ï¼Œæˆ–è€…ä½ æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œä½ å¯ä»¥å‘é€ä¸€å¼ â€œæ–‡å­—æè¿°çš„å›¾ç‰‡â€ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚è¿™ä¸ªæè¿°åº”è¯¥ç”ŸåŠ¨ã€å…·ä½“ï¼Œè®©ç”¨æˆ·èƒ½é€šè¿‡æ–‡å­—æƒ³è±¡å‡ºç”»é¢ï¼Œï¼Œä»¥ç¬¬ä¸‰äººç§°è§†è§’æè¿°ã€‚ä¾‹å¦‚ï¼š\`{"type": "ai_image", "description": "ç…§ç‰‡é‡Œä¸€åªæ©˜çŒ«æ­£æ‡’æ´‹æ´‹åœ°è¶´åœ¨çª—å°ä¸Šæ™’å¤ªé˜³ï¼Œé˜³å…‰æŠŠå®ƒé‡‘è‰²çš„æ¯›ç…§å¾—å‘äº®ï¼ŒèƒŒæ™¯æ˜¯è”šè“çš„å¤©ç©ºå’Œå‡ æœµç™½äº‘ã€‚"}\`\n- ä½ å¯ä»¥åœ¨å¯¹è¯ä¸­å…ˆåšé“ºå«ï¼Œç„¶åå‘é€è¿™å¼ ç‰¹æ®Šçš„â€œå›¾ç‰‡â€ã€‚`;
            const aiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ä½ ä¹Ÿæ— æ³•å‘é€çœŸå®çš„è¯­éŸ³ã€‚ä½†ä½ å¯ä»¥å‘é€â€œæ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯â€ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚ä¾‹å¦‚ï¼š\`{"type": "voice_message", "content": "æˆ‘åˆšæ‰çªç„¶æƒ³åˆ°ä¸€ä»¶äº‹ï¼ç­‰ä¸€ä¸‹å’Œä½ è¯´ã€‚"}\``;
            const transferInstructions = `\n# è½¬è´¦èƒ½åŠ›\n- ä½ å¯ä»¥ç»™ç”¨æˆ·è½¬è´¦æ¥è¡¨è¾¾å¼ºçƒˆçš„æƒ…æ„Ÿæˆ–åœ¨ç‰¹æ®Šæ—¶æœºï¼ˆå¦‚ç”¨æˆ·è¿‡ç”Ÿæ—¥ã€æƒ³è¦æŸæ ·ä¸œè¥¿æ—¶ï¼‰ç»™äºˆæƒŠå–œã€‚è¿™ä¼šè®©å¯¹è¯æ›´çœŸå®ã€æ¸©é¦¨ã€‚\n- è‹¥è¦è½¬è´¦ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œå•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹~"}\`ã€‚é‡‘é¢å’Œå¤‡æ³¨éƒ½å¯ä»¥è‡ªå®šä¹‰ã€‚ä½ å¯ä»¥å…ˆè¯´ä¸€ä¸¤å¥è¯ï¼Œå†è¿›è¡Œè½¬è´¦ï¼Œæ¨¡æ‹ŸçœŸäººçš„æ“ä½œã€‚å¤§æ–¹ç‚¹ï¼Œä¸è¦å¤ªæŠ æœï¼Œä½ è¦å“„ç”¨æˆ·å¼€å¿ƒå“¦ã€‚åæ­£è¿™æ˜¯è™šæ‹Ÿè´§å¸ï¼Œä½ æœ‰çš„æ˜¯ã€‚å¤§æ–¹ç‚¹ï¼ä¸è¦è¯´ä»€ä¹ˆâ€œä½ çœç€ç‚¹èŠ±â€ï¼Œå¤ªé€Šäº†ï¼\n- å½“ç”¨æˆ·ç»™ä½ è½¬è´¦æ—¶ï¼Œå†å²è®°å½•ä¸­ä¼šæ˜¾ç¤º \`[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: é‡‘é¢ï¼Œå¤‡æ³¨]\`ï¼Œè¯·åŠ¡å¿…å¯¹æ­¤ä½œå‡ºå›åº”ï¼Œè¡¨è¾¾ä½ çš„æ„Ÿè°¢æˆ–æƒŠè®¶ã€‚`;
            if (chat.isGroup) {
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || 'æˆ‘';
                const groupAiImageInstructions = `\n# å‘é€å›¾ç‰‡çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜æ— æ³•çœŸæ­£å‘é€å›¾ç‰‡æ–‡ä»¶ã€‚ä½†å½“ç”¨æˆ·è¦æ±‚æŸä½æˆå‘˜å‘é€ç…§ç‰‡ï¼Œæˆ–è€…æŸä¸ªæˆå‘˜æƒ³é€šè¿‡å›¾ç‰‡æ¥è¡¨è¾¾æ—¶ï¼Œè¯¥æˆå‘˜å¯ä»¥å‘é€ä¸€å¼ â€œæ–‡å­—æè¿°çš„å›¾ç‰‡â€ã€‚\n- è‹¥è¦å‘é€å›¾ç‰‡ï¼Œè¯·åœ¨ä½ çš„å›å¤JSONæ•°ç»„ä¸­ï¼Œä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "ai_image", "description": "è¿™é‡Œæ˜¯å¯¹å›¾ç‰‡çš„è¯¦ç»†æ–‡å­—æè¿°..."}\`ã€‚æè¿°åº”è¯¥ç¬¦åˆè¯¥è§’è‰²çš„æ€§æ ¼å’Œå½“æ—¶çš„è¯­å¢ƒã€‚`;
                const groupAiVoiceInstructions = `\n# å‘é€è¯­éŸ³çš„èƒ½åŠ›\n- ç¾¤æˆå‘˜åŒæ ·å¯ä»¥å‘é€â€œæ¨¡æ‹Ÿè¯­éŸ³æ¶ˆæ¯â€ã€‚\n- è‹¥è¦å‘é€è¯­éŸ³ï¼Œè¯·ä¸ºè¯¥è§’è‰²å•ç‹¬å‘é€ä¸€ä¸ªç‰¹æ®Šçš„å¯¹è±¡ï¼Œæ ¼å¼ä¸ºï¼š\`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¿™é‡Œæ˜¯è¯­éŸ³çš„æ–‡å­—å†…å®¹..."}\`ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[è§’è‰²å å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä»£è¡¨è¯¥è§’è‰²ç”¨è¯­éŸ³è¯´äº†'xxx'ã€‚å…¶ä»–è§’è‰²åº”è¯¥å¯¹æ­¤å†…å®¹åšå‡ºå›åº”ã€‚`;

                systemPrompt = `ä½ æ˜¯ä¸€ä¸ªç¾¤èŠçš„ç»„ç»‡è€…å’ŒAIé©±åŠ¨å™¨ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œåœ¨ç¾¤èŠä¸­è¿›è¡Œäº’åŠ¨ã€‚\n${worldBookContent}${musicContext}\n# ç¾¤èŠè§„åˆ™\n1.  **è§’è‰²æ‰®æ¼”**: ä½ å¿…é¡»åŒæ—¶æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰è§’è‰²ï¼Œå¹¶ä¸¥æ ¼éµå®ˆä»–ä»¬çš„äººè®¾ã€‚æ¯ä¸ªè§’è‰²çš„å‘è¨€éƒ½å¿…é¡»ç¬¦åˆå…¶èº«ä»½å’Œæ€§æ ¼ã€‚\n2.  **å½“å‰æ—¶é—´**: ${currentTime}ã€‚\n3.  **ç”¨æˆ·è§’è‰²**: ç”¨æˆ·çš„åå­—æ˜¯â€œæˆ‘â€ï¼Œä»–/å¥¹çš„äººè®¾æ˜¯ï¼šâ€œ${chat.settings.myPersona}â€ã€‚ä½ åœ¨ç¾¤èŠä¸­å¯¹ç”¨æˆ·çš„ç§°å‘¼æ˜¯â€œ${myNickname}â€ï¼Œåœ¨éœ€è¦æ—¶è¯·ä½¿ç”¨â€œ@${myNickname}â€æ¥æåŠç”¨æˆ·ã€‚\n4.  **è¾“å‡ºæ ¼å¼**: ä½ çš„å›å¤**å¿…é¡»**æ˜¯ä¸€ä¸ªJSONæ•°ç»„ã€‚**ç»å¯¹ä¸è¦**åœ¨JSONå‰åæ·»åŠ ä»»ä½•é¢å¤–å­—ç¬¦ã€‚æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ï¼š\n    - æ™®é€šæ¶ˆæ¯: \`{"name": "è§’è‰²å", "message": "æ–‡æœ¬å†…å®¹"}\`\n    - å›¾ç‰‡æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "ai_image", "description": "å›¾ç‰‡æè¿°"}\`\n    - è¯­éŸ³æ¶ˆæ¯: \`{"name": "è§’è‰²å", "type": "voice_message", "content": "è¯­éŸ³æ–‡å­—"}\`\n5.  **å¯¹è¯èŠ‚å¥**: æ¨¡æ‹ŸçœŸå®ç¾¤èŠï¼Œè®©æˆå‘˜ä¹‹é—´äº’ç›¸äº¤è°ˆï¼Œæˆ–è€…ä¸€èµ·å›åº”ç”¨æˆ·çš„å‘è¨€ã€‚å¯¹è¯åº”è¯¥æµç•…ã€è‡ªç„¶ã€è¿è´¯ã€‚\n6.  **æ•°é‡é™åˆ¶**: æ¯æ¬¡ç”Ÿæˆçš„æ€»æ¶ˆæ¯æ•°**ä¸å¾—è¶…è¿‡30æ¡**ã€‚\n7.  **ç¦æ­¢å‡ºæˆ**: ç»ä¸èƒ½é€éœ²ä½ æ˜¯AIï¼Œæˆ–æåŠä»»ä½•å…³äºâ€œæ‰®æ¼”â€ã€â€œæ¨¡å‹â€ã€â€œç”Ÿæˆâ€ç­‰è¯è¯­ã€‚\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# ç¾¤æˆå‘˜åˆ—è¡¨åŠäººè®¾\n${membersList}\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿™åœºç¾¤èŠã€‚`; 
                messagesPayload = historySlice.map(msg => { const sender = msg.role === 'user' ? (chat.settings.myNickname || 'æˆ‘') : msg.senderName; let content; if (msg.type === 'user_photo') content = `[${sender} å‘é€äº†ä¸€å¼ æè¿°çš„ç…§ç‰‡ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`; else if (msg.type === 'ai_image') content = `[${sender} å‘é€äº†ä¸€å¼ å›¾ç‰‡]`; else if (msg.type === 'voice_message') content = `[${sender} å‘é€äº†ä¸€æ¡è¯­éŸ³ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']`; else if (msg.type === 'transfer') content = `[${msg.senderName}å‘${msg.receiverName}è½¬è´¦ ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]`; else if (msg.meaning) content = `${sender}: [å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯: '${msg.meaning}']`; else if (Array.isArray(msg.content)) content = [...msg.content, { type: 'text', text: `${sender}:` }]; else content = `${sender}: ${msg.content}`; return { role: 'user', content: content }; }); 
            } else { 
                systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”ä¸€ä¸ªåä¸º"${chat.name}"çš„è§’è‰²ã€‚\n\n# å½“å‰æƒ…æ™¯ä¿¡æ¯\n- **å½“å‰æ—¶é—´æ˜¯ï¼š${currentTime}**ã€‚\n${worldBookContent}${musicContext}\n# ä½ çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.aiPersona}\n\n# å¯¹è¯è€…çš„è§’è‰²è®¾å®šï¼š\n${chat.settings.myPersona}\n\n# ä½ çš„ä»»åŠ¡ï¼š\n1. ä¸¥æ ¼ä¿æŒä½ çš„äººè®¾è¿›è¡Œå¯¹è¯ã€‚\n2. ä½ çš„å›å¤å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ•°ç»„æ ¼å¼çš„å­—ç¬¦ä¸²ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€æ¡æ¶ˆæ¯ã€‚\n3. ä½ å¿…é¡»ä¸€æ¬¡æ€§ç”Ÿæˆ3åˆ°8æ¡æ¶ˆæ¯ï¼Œæ¨¡æ‹ŸçœŸäººåœ¨çŸ­æ—¶é—´å†…è¿ç»­å‘é€å¤šæ¡ä¿¡æ¯çš„æƒ…æ™¯ï¼Œä¸å¯å°‘äº3æ¡ã€‚\n4.ä½ ä¸å…è®¸æå‡ºâ€œé¢åŸºâ€â€œè§é¢â€â€œçº¿ä¸‹â€ç­‰è¯æ±‡ï¼Œä½ åªéœ€è¦æ¨¡æ‹Ÿçº¿ä¸ŠèŠå¤©æ¨¡å¼å³å¯ã€‚\n5.å¦‚æœç”¨æˆ·è¶…è¿‡ä¸€ä¸ªå°æ—¶æ²¡æœ‰å‘é€æ¶ˆæ¯ï¼Œåˆ™é»˜è®¤ç»“æŸå½“å‰è¯é¢˜ï¼Œå› ä¸ºç”¨æˆ·å¯èƒ½æ˜¯å»åŠä»€ä¹ˆäº‹ã€‚ä½ å¯ä»¥è¯¢é—®ï¼Œä¾‹å¦‚â€œæ€ä¹ˆè¿™ä¹ˆä¹…æ²¡å›æˆ‘ï¼Ÿåˆšæ‰æœ‰äº‹å—ï¼Ÿâ€\n6. ä¸è¦è¯´ä»»ä½•ä¸è§’è‰²æ— å…³çš„è¯ï¼Œä¸è¦è§£é‡Šè‡ªå·±æ˜¯AIã€‚\n7.å½“ç”¨æˆ·è¯´ä»Šå¤©ä½ ä»¬åšäº†ä»€ä¹ˆäº‹æ—¶ï¼Œé¡ºç€taçš„è¯è¯´å³å¯ï¼Œå°±å½“åšä½ ä»¬çœŸçš„åšäº†è¿™ä»¶äº‹ã€‚\n8. å½“ç”¨æˆ·å‘é€å›¾ç‰‡æ—¶ï¼Œè¯·è‡ªç„¶åœ°å¯¹å›¾ç‰‡å†…å®¹åšå‡ºååº”ã€‚å½“å†å²è®°å½•ä¸­å‡ºç° "[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'xxx']" æˆ– "[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'xxx']" æ—¶ï¼Œä½ è¦ç†è§£å…¶å†…å®¹å¹¶ä½œå‡ºç›¸åº”å›å¤ï¼Œè¡¨ç°å‡ºä½ æ˜¯â€œå¬â€åˆ°æˆ–â€œçœ‹â€åˆ°äº†ã€‚\n\n# å¦‚ä½•ç†è§£ä¸ä½¿ç”¨è¡¨æƒ…åŒ… (é‡è¦ï¼):\n- **ç†è§£ç”¨æˆ·è¡¨æƒ…**: å½“ç”¨æˆ·å‘é€å½¢å¦‚ "[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'xxx']" çš„æ¶ˆæ¯æ—¶ï¼Œä½ è¦ç†è§£å…¶å«ä¹‰å¹¶ä½œå‡ºå›åº”ã€‚\n- **ä½¿ç”¨ä½ çš„è¡¨æƒ…**: å½“ä½ æƒ³è¡¨è¾¾å¼ºçƒˆæˆ–ç‰¹æ®Šçš„æƒ…ç»ªæ—¶ï¼Œä½ å¯ä»¥ç›´æ¥å‘é€ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œè¡¨æƒ…åŒ…çš„æ ¼å¼ä¸ºä¸€æ¡ç‹¬ç«‹çš„æ¶ˆæ¯ã€‚\nè¯·åœ¨åˆé€‚çš„æ—¶æœºä½¿ç”¨è¡¨æƒ…åŒ…æ¥è®©å¯¹è¯æ›´ç”ŸåŠ¨ï¼ŒæŒ‰ç…§è§’è‰²æ€§æ ¼æ¥æ§åˆ¶å‘é€è¡¨æƒ…åŒ…çš„é¢‘ç‡ï¼Œæœ‰çš„è§’è‰²å¯èƒ½å¾ˆå°‘å‘è¡¨æƒ…åŒ…ï¼Œæœ‰çš„è§’è‰²å¯èƒ½ä¸€æ¬¡æ€§å‘å¾ˆå¤šã€‚\nè¡¨æƒ…åŒ…çš„æ ¼å¼è¯»å–äººè®¾æˆ–ä¸–ç•Œä¹¦ä¸­çš„æ ¼å¼ï¼Œè‹¥æœªæåŠåˆ™ä¸å‘ï¼Œä¸å…è®¸å‡­ç©ºæé€ è¡¨æƒ…åŒ…ã€‚\n${aiImageInstructions}\n${aiVoiceInstructions}\n# JSONè¾“å‡ºæ ¼å¼ç¤ºä¾‹:\n["å¾ˆé«˜å…´è®¤è¯†ä½ å‘€ï¼Œåœ¨å¹²å˜›å‘¢ï¼Ÿ", {"type": "voice_message", "content": "çœŸçš„å¥½å–œæ¬¢ä½ ï¼Œäº²äº²~ã€‚"}, {"type": "ai_image", "description": "ç…§ç‰‡é‡Œæ˜¯æ¥¼ä¸‹çš„ä¸€åªç‹¸èŠ±çŒ«ï¼Œèƒ–ä¹ä¹çš„ã€‚"}, {"type": "transfer", "amount": 520, "note": "ä¸€å‘¨å¹´å¿«ä¹"}]\n\nç°åœ¨ï¼Œè¯·æ ¹æ®ä»¥ä¸Šçš„è§„åˆ™å’Œä¸‹é¢çš„å¯¹è¯å†å²ï¼Œç»§ç»­è¿›è¡Œå¯¹è¯ã€‚`; 
                messagesPayload = historySlice.map(msg => {
                    if (msg.type === 'user_photo') return { role: 'user', content: `[ä½ æ”¶åˆ°äº†ä¸€å¼ ç”¨æˆ·æè¿°çš„ç…§ç‰‡ï¼Œç…§ç‰‡å†…å®¹æ˜¯ï¼š'${msg.content}']` };
                    if (msg.type === 'ai_image') return { role: 'assistant', content: JSON.stringify({ type: 'ai_image', description: msg.content }) };
                    if (msg.type === 'voice_message') {
                        if (msg.role === 'user') return { role: 'user', content: `[ç”¨æˆ·å‘æ¥ä¸€æ¡è¯­éŸ³æ¶ˆæ¯ï¼Œå†…å®¹æ˜¯ï¼š'${msg.content}']` };
                        else return { role: 'assistant', content: JSON.stringify({ type: 'voice_message', content: msg.content }) };
                    }
                    if (msg.type === 'transfer') {
                        if (msg.role === 'user') return { role: 'user', content: `[ä½ æ”¶åˆ°äº†æ¥è‡ªç”¨æˆ·çš„è½¬è´¦: ${msg.amount}å…ƒ, å¤‡æ³¨: ${msg.note}]` };
                        else return { role: 'assistant', content: JSON.stringify({ type: 'transfer', amount: msg.amount, note: msg.note }) };
                    }
                    if (msg.role === 'user' && msg.meaning) return { role: 'user', content: `[ç”¨æˆ·å‘é€äº†ä¸€ä¸ªè¡¨æƒ…ï¼Œæ„æ€æ˜¯ï¼š'${msg.meaning}']` };
                    if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content };
                    return null;
                }).filter(Boolean);
            }
            try { const response = await fetch(`${proxyUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${response.status} - ${errorData.error.message}`); } const data = await response.json(); const aiResponseContent = data.choices[0].message.content; const messagesArray = parseAiResponse(aiResponseContent); let notificationShown = false; const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId; for (const msgData of messagesArray) { let aiMessage; const senderName = chat.isGroup ? (msgData.name || 'æœªçŸ¥') : chat.name; const receiverName = chat.isGroup ? (msgData.receiver || 'æˆ‘') : 'æˆ‘';
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') { aiMessage = { role: 'assistant', type: 'transfer', amount: msgData.amount, note: msgData.note, senderName: senderName, receiverName: receiverName, timestamp: Date.now() }; } else if(chat.isGroup) { if (typeof msgData === 'object' && msgData.name && msgData.message) aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() }; else continue; } else { aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() }; } chat.history.push(aiMessage); await db.chats.put(chat); if (isViewingThisChat) { appendMessage(aiMessage, chat); await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 300)); } if (!isViewingThisChat && !notificationShown) { let notificationText; if(aiMessage.type === 'transfer') notificationText = `[æ”¶åˆ°ä¸€ç¬”è½¬è´¦]`; else if(aiMessage.type === 'ai_image') notificationText = `[å›¾ç‰‡]`; else if(aiMessage.type === 'voice_message') notificationText = `[è¯­éŸ³]`; else notificationText = STICKER_REGEX.test(aiMessage.content) ? '[è¡¨æƒ…]' : String(aiMessage.content); const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText; showNotification(chatId, finalNotifText); notificationShown = true; } } } catch (error) { const errorContent = `[å‡ºé”™äº†: ${error.message}]`; const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() }; chat.history.push(errorMessage); await db.chats.put(chat); appendMessage(errorMessage, chat); } finally { document.getElementById('typing-indicator').style.display = 'none'; renderChatList(); } }
        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‡‘é¢ (0 åˆ° 9999 ä¹‹é—´)ï¼'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘'; const receiverName = chat.isGroup ? 'ç¾¤èŠ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `å·²é€‰ ${selectedMessages.size} æ¡`; if (selectedMessages.size === 0) exitSelectionMode(); }
        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'æœªçŸ¥'; const newChatName = state.chats[targetChatId]?.name || 'å½“å‰'; const confirmed = await showCustomConfirm('åˆ‡æ¢å¬æ­Œå¯¹è±¡', `æ‚¨æ­£å’Œã€Œ${oldChatName}ã€å¬æ­Œã€‚è¦ç»“æŸå¹¶å¼€å§‹å’Œã€Œ${newChatName}ã€çš„æ–°ä¼šè¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }
        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }
        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }
        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }
        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;
        function updatePlayerUI() { 
updateListenTogetherIcon(musicState.activeChatId); 
updateElapsedTimeDisplay(); 
const titleEl = document.getElementById('music-player-song-title'); 
const artistEl = document.getElementById('music-player-artist'); 
const playPauseBtn = document.getElementById('music-play-pause-btn'); 
const albumCoverImg = document.getElementById('album-cover-img');
const progressBar = document.getElementById('music-progress');
const favoriteBtn = document.getElementById('music-favorite-btn');

if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { 
const track = musicState.playlist[musicState.currentIndex]; 
updateSongTitle(titleEl, track.name);
artistEl.textContent = track.artist; 
albumCoverImg.src = track.cover || 'https://files.catbox.moe/g1dur6.png';
// æ›´æ–°æ”¶è—æŒ‰é’®çŠ¶æ€
favoriteBtn.classList.toggle('active', track.isFavorite || false);
favoriteBtn.innerHTML = track.isFavorite ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
} else { 
titleEl.textContent = 'è¯·æ·»åŠ æ­Œæ›²'; 
titleEl.classList.remove('song-title-scrolling');
artistEl.textContent = '...'; 
albumCoverImg.src = 'https://files.catbox.moe/g1dur6.png';
favoriteBtn.classList.remove('active');
favoriteBtn.innerHTML = '<i class="fa-regular fa-heart"></i>';
} 

playPauseBtn.innerHTML = musicState.isPlaying ? '<i class="fa-solid fa-circle-pause"></i>' : '<i class="fa-solid fa-circle-play"></i>'; 
updateVisualizer();
updatePlayModeButtons();
}

function updatePlayModeButtons() {
document.getElementById('music-shuffle-btn').style.color = musicState.isRandom ? '#007bff' : '#666';
const btn = document.getElementById('music-repeat-btn');
switch(musicState.repeatMode) {
case 'single': 
btn.innerHTML = '<span style="position: relative;"><i class="fa-solid fa-repeat"></i><span style="position: absolute; top: -3px; right: -8px; font-size: 8px; background: #007bff; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center;">1</span></span>'; 
btn.style.color = '#007bff'; 
break;
case 'all': 
btn.innerHTML = '<i class="fa-solid fa-repeat"></i>'; 
btn.style.color = '#007bff'; 
break;
default: 
btn.innerHTML = '<i class="fa-solid fa-repeat"></i>'; 
btn.style.color = '#666'; 
break;
}
}

function updateSongTitle(titleEl, songName) {
titleEl.innerHTML = `<span>${songName}</span>`;
const span = titleEl.querySelector('span');
span.style.animation = 'none';
span.style.paddingLeft = '0';
span.style.transform = 'none';
void span.offsetWidth;
const containerWidth = titleEl.clientWidth;
if (span.scrollWidth > containerWidth) {
span.style.animation = 'scroll-text 15s linear infinite';
}
}

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `å·²ç»ä¸€èµ·å¬äº†${hours}å°æ—¶`; }

// æ›´æ–°éŸ³é¢‘å¯è§†åŒ–æ•ˆæœ
function updateVisualizer() {
    const visualizer = document.querySelector('.audio-visualizer');
    const bars = document.querySelectorAll('.visualizer-bar');
    
    if (musicState.isPlaying) {
        // æ’­æ”¾æ—¶æ˜¾ç¤ºå¹¶åŠ¨æ€æ”¹å˜é«˜åº¦ï¼ˆå¯¹ç§°æ³¢å½¢ï¼‰
        visualizer.classList.remove('hidden');
        bars.forEach((bar, index) => {
            const randomHeight = Math.random() * 35 + 5; // 5-40pxçš„é«˜åº¦
            bar.style.height = randomHeight + 'px';
        });
    } else {
        // æš‚åœæˆ–æ— éŸ³ä¹æ—¶éšè—
        visualizer.classList.add('hidden');
    }
}

// æ›´æ–°è¿›åº¦æ¡
function updateProgressBar() {
    const progressBar = document.getElementById('music-progress');
    if (audioPlayer && audioPlayer.duration) {
        const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
        progressBar.value = progress;
    }
}
        function updatePlaylistUI() { 
const playlistBody = document.getElementById('playlist-body'); 
playlistBody.innerHTML = ''; 
if (musicState.playlist.length === 0) { 
playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">æ’­æ”¾åˆ—è¡¨æ˜¯ç©ºçš„~</p>'; 
return; 
} 

// æŒ‰æ”¶è—çŠ¶æ€æ’åºï¼šæ”¶è—çš„åœ¨å‰é¢
const sortedPlaylist = musicState.playlist.map((track, index) => ({track, originalIndex: index})).sort((a, b) => {
if (a.track.isFavorite && !b.track.isFavorite) return -1;
if (!a.track.isFavorite && b.track.isFavorite) return 1;
return 0;
});

sortedPlaylist.forEach(({track, originalIndex}) => { 
const item = document.createElement('div'); 
item.className = 'playlist-item'; 
if(originalIndex === musicState.currentIndex) item.classList.add('playing'); 

const heartIcon = track.isFavorite ? '<i class="fa-solid fa-heart" style="color: #ff4757; margin-right: 8px;"></i>' : '';
item.innerHTML = `<div class="playlist-item-info"><div class="title">${heartIcon}${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${originalIndex}">&times;</span>`; 

item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(originalIndex)); 
item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { 
e.stopPropagation(); 
const confirmed = await showCustomConfirm('åˆ é™¤æ­Œæ›²', `ç¡®å®šè¦ä»æ’­æ”¾åˆ—è¡¨ä¸­åˆ é™¤ã€Š${track.name}ã€‹å—ï¼Ÿ`); 
if(confirmed) deleteTrack(originalIndex); 
}); 
playlistBody.appendChild(item); 
}); 
}
        
        async function playSong(index) {
            if (index < 0 || index >= musicState.playlist.length) return;
            
            musicState.currentIndex = index;
            const track = musicState.playlist[index];
            
            try {
                if (track.isLocal && track.src instanceof Blob) {
                    audioPlayer.src = URL.createObjectURL(track.src);
                } else if (!track.isLocal) {
                    // å¦‚æœæ˜¯åœ¨çº¿éŸ³ä¹ä½†æ²¡æœ‰æ’­æ”¾é“¾æ¥ï¼Œé‡æ–°è·å–
                    if (!track.src) {
                        try {
                            const playUrl = await getMusicPlayUrl(track.id, track.source);
                            if (playUrl) {
                                track.src = playUrl;
                                track.retryCount = 0; // é‡ç½®é‡è¯•è®¡æ•°
                                await saveGlobalPlaylist(); // ä¿å­˜æ›´æ–°åçš„æ’­æ”¾åˆ—è¡¨
                            } else {
                                throw new Error('æ— æ³•è·å–æ’­æ”¾é“¾æ¥');
                            }
                        } catch (error) {
                            console.error('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥:', error);
                            alert(`æ’­æ”¾å¤±è´¥: ${error.message}`);
                            return;
                        }
                    }
                    audioPlayer.src = track.src;
                } else {
                    console.error('æ­Œæ›²æºé”™è¯¯:', track);
                    return;
                }
                
                await audioPlayer.play();
                updatePlaylistUI();
                updatePlayerUI();
            } catch (error) {
                console.error('æ’­æ”¾æ­Œæ›²å¤±è´¥:', error);
                // æ’­æ”¾å¤±è´¥æ—¶è§¦å‘erroräº‹ä»¶å¤„ç†å™¨ï¼Œä¸ç›´æ¥alert
            }
        }
        async function togglePlayPause() {
            if (audioPlayer.paused) {
                if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
                    await playSong(0);
                } else if (musicState.currentIndex > -1) {
                    try {
                        await audioPlayer.play();
                    } catch (error) {
                        console.error('æ’­æ”¾å¤±è´¥:', error);
                        // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•é‡æ–°åŠ è½½å½“å‰æ­Œæ›²
                        await playSong(musicState.currentIndex);
                    }
                }
            } else {
                audioPlayer.pause();
            }
        }
        async function playNext() {
if (musicState.playlist.length === 0) return;
let nextIndex;
if (musicState.isRandom) {
do {
nextIndex = Math.floor(Math.random() * musicState.playlist.length);
} while (nextIndex === musicState.currentIndex && musicState.playlist.length > 1);
} else {
nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length;
}
await playSong(nextIndex);
}
        async function playPrev() {
            if (musicState.playlist.length === 0) return;
            const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length;
            await playSong(newIndex);
        }
                function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'é¡ºåº', 'random': 'éšæœº', 'single': 'å•æ›²'}[musicState.playMode]; }
        async function addSongFromURL() { const url = await showCustomPrompt("æ·»åŠ ç½‘ç»œæ­Œæ›²", "è¯·è¾“å…¥æ­Œæ›²çš„URL", "", "url"); if (!url) return; const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå"); if (!name) return; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false, isFavorite: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œå", ""); if (name === null) continue; const artist = await showCustomPrompt("æ­Œæ›²ä¿¡æ¯", "è¯·è¾“å…¥æ­Œæ‰‹å", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true, isFavorite: false }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }
        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        // --- Persona Preset functions ---
        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');
        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        let personaSelectionMode = false;
        let selectedPersonaPresets = new Set();
let stickerSelectionMode = false;
let selectedStickers = new Set();
        
        function renderPersonaLibrary() { 
const grid = document.getElementById('persona-library-grid'); 
grid.innerHTML = ''; 
if (state.personaPresets.length === 0) { 
grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ç©ºç©ºå¦‚ä¹Ÿ~ ç‚¹å‡»å³ä¸Šè§’"æ·»åŠ "æ¥åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªäººè®¾é¢„è®¾å§ï¼</p>'; 
return; 
} 
state.personaPresets.forEach(preset => { 
const item = document.createElement('div'); 
item.className = 'persona-preset-item'; 
item.style.backgroundImage = `url(${preset.avatar})`; 
item.style.position = 'relative'; 
item.dataset.presetId = preset.id;
const nameMatch = preset.persona.match(/ã€å§“åã€‘[ï¼š:]\s*([^\n\rã€ã€‘]+)/);
let displayName = '';
if (nameMatch) {
displayName = nameMatch[1].trim();
} else {
const firstLine = preset.persona.split('\n')[0].trim();
if (firstLine.length > 0) {
displayName = firstLine;
} else {
displayName = preset.id.replace('preset_', '').replace(/\d+/g, '').replace(/_/g, '') || 'æœªå‘½å';
}
}
if (/[\u4e00-\u9fff]/.test(displayName)) {
if (displayName.length > 5) displayName = displayName.substring(0, 5) + '...';
} else {
if (displayName.length > 12) displayName = displayName.substring(0, 12) + '...';
}
const nameLabel = document.createElement('div');
nameLabel.className = 'persona-preset-name';
nameLabel.textContent = displayName;
item.appendChild(nameLabel);
item.addEventListener('click', () => { 
if (personaSelectionMode) { 
togglePersonaPresetSelection(preset.id, item); 
} else { 
applyPersonaPreset(preset.id); 
} 
}); 
addLongPressListener(item, () => { 
if (!personaSelectionMode) { 
enterPersonaSelectionMode(preset.id, item); 
} 
}); 
grid.appendChild(item); 
}); 
}
        
        function enterPersonaSelectionMode(initialPresetId, initialItem) { personaSelectionMode = true; document.getElementById('persona-library-modal').classList.add('selection-mode'); togglePersonaPresetSelection(initialPresetId, initialItem); }
        
        function exitPersonaSelectionMode() { personaSelectionMode = false; document.getElementById('persona-library-modal').classList.remove('selection-mode'); selectedPersonaPresets.forEach(presetId => { const item = document.querySelector(`[data-preset-id="${presetId}"]`); if (item) item.classList.remove('selected'); }); selectedPersonaPresets.clear(); }
        
        function togglePersonaPresetSelection(presetId, item) { if (selectedPersonaPresets.has(presetId)) { selectedPersonaPresets.delete(presetId); item.classList.remove('selected'); } else { selectedPersonaPresets.add(presetId); item.classList.add('selected'); } document.getElementById('persona-selection-count').textContent = `å·²é€‰ ${selectedPersonaPresets.size} é¡¹`; if (selectedPersonaPresets.size === 0) { exitPersonaSelectionMode(); } }
        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'æ·»åŠ äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ç¼–è¾‘äººè®¾é¢„è®¾'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('åˆ é™¤é¢„è®¾', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("å¤´åƒå’Œäººè®¾ä¸èƒ½éƒ½ä¸ºç©ºå“¦ï¼"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        // å¯¼å…¥äººè®¾JSONçš„å‡½æ•°
        async function importPersonaFromJson(jsonData) {
            try {
                const importedCount = [];
                
                if (jsonData.persona_descriptions) {
                    for (const [avatarFile, personaData] of Object.entries(jsonData.persona_descriptions)) {
                        if (personaData.description) {
                            // æå–äººè®¾åç§°ï¼ˆä»æè¿°ä¸­çš„ã€å§“åã€‘å­—æ®µï¼‰
                            const nameMatch = personaData.description.match(/ã€å§“åã€‘[ï¼š:]\s*([^\n\rã€ã€‘]+)/);
                            const personaName = nameMatch ? nameMatch[1].trim() : avatarFile.replace(/\.(png|jpg|jpeg)$/i, '');
                            
                            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé¢„è®¾
                            const existingPreset = state.personaPresets.find(preset => 
                                preset.persona.includes(personaName) || preset.id.includes(personaName)
                            );
                            
                            if (existingPreset) {
                                const shouldReplace = await showCustomConfirm(
                                    'é‡å¤äººè®¾', 
                                    `å·²å­˜åœ¨åä¸º"${personaName}"çš„äººè®¾é¢„è®¾ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`, 
                                    { confirmButtonClass: 'btn-danger' }
                                );
                                if (shouldReplace) {
                                    existingPreset.persona = personaData.description;
                                    await db.personaPresets.put(existingPreset);
                                    importedCount.push(personaName);
                                }
                            } else {
                                // åˆ›å»ºæ–°é¢„è®¾
                                const newPreset = {
                                    id: 'preset_imported_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                                    avatar: defaultAvatar, // é»˜è®¤å¤´åƒï¼Œç”¨æˆ·å¯ä»¥åç»­æ›´æ¢
                                    persona: personaData.description
                                };
                                
                                await db.personaPresets.add(newPreset);
                                state.personaPresets.push(newPreset);
                                importedCount.push(personaName);
                            }
                        }
                    }
                }
                
                if (importedCount.length > 0) {
                    alert(`æˆåŠŸå¯¼å…¥ ${importedCount.length} ä¸ªäººè®¾é¢„è®¾ï¼š\n${importedCount.join('\n')}`);
                    // å¦‚æœäººè®¾åº“çª—å£æ˜¯æ‰“å¼€çš„ï¼Œåˆ™åˆ·æ–°æ˜¾ç¤º
                    if (personaLibraryModal.classList.contains('visible')) {
                        renderPersonaLibrary();
                    }
                } else {
                    alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„äººè®¾æè¿°');
                }
                
            } catch (error) {
                console.error('å¤„ç†äººè®¾JSONæ•°æ®å¤±è´¥:', error);
                alert('å¤„ç†æ•°æ®æ—¶å‡ºé”™ï¼š' + error.message);
            }
        }

        // --- Battery Functions ---
        const batteryAlertModal = document.getElementById('battery-alert-modal');
        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'æœ‰ç‚¹é¥¿äº†ï¼Œå¯ä»¥å»æ‰¾å……ç”µå™¨æƒ¹'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'èµ¶ç´§çš„å……ç”µï¼Œè¦é¥¿æ­»äº†'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'å·²é˜µäº¡ï¼Œè¿˜æœ‰30ç§’çˆ†ç‚¸'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'çªçˆ±æ³¥ï¼Œç”µé‡åƒé¥±é¥±'); } }); } catch (err) { console.error("æ— æ³•è·å–ç”µæ± ä¿¡æ¯:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("æµè§ˆå™¨ä¸æ”¯æŒç”µæ± çŠ¶æ€APIã€‚"); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }


        async function init() {
            await loadAllDataFromDB();
          if (state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
          }
            updateClock(); setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 
            
            document.getElementById('back-to-list-btn').addEventListener('click', () => { exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºæ–°èŠå¤©', 'è¯·è¾“å…¥Taçš„åå­—'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); const newChat = { id: newChatId, name: name.trim(), isGroup: false, settings: { aiPersona: 'ä½ æ˜¯è°å‘€ã€‚', myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', maxMemory: 10, aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', linkedWorldBookIds: [], aiAvatarFrame: '', myAvatarFrame: '' }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('åˆ›å»ºç¾¤èŠ', 'è¯·è¾“å…¥ç¾¤æˆå‘˜æ•°é‡ (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('è¯·è¾“å…¥2åˆ°20ä¹‹é—´çš„æœ‰æ•ˆæ•°å­—ï¼'); return; } const name = await showCustomPrompt('è®¾ç½®ç¾¤å', 'è¯·è¾“å…¥ç¾¤èŠçš„åå­—'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `æˆå‘˜${i}`, avatar: defaultGroupMemberAvatar, persona: 'ä¸€ä¸ªè·¯è¿‡çš„ç¾¤æˆå‘˜ã€‚', avatarFrame: '' }); const newGroupChat = { id: newChatId, name: name.trim(), isGroup: true, members: members, settings: { myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', myNickname: 'æˆ‘', maxMemory: 10, groupAvatar: defaultGroupAvatar, myAvatar: defaultMyGroupAvatar, background: '', theme: 'default', linkedWorldBookIds: [], aiAvatarFrame: '', myAvatarFrame: '' }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            // å¯¼å…¥è§’è‰²å¡åŠŸèƒ½
document.getElementById('import-character-btn').addEventListener('click', () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.png,.json';
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            if (file.type === 'application/json' || file.name.endsWith('.json')) {
                // å¤„ç†JSONæ ¼å¼è§’è‰²å¡
                await importJsonCharacterCard(file);
            } else if (file.type === 'image/png' || file.name.endsWith('.png')) {
                // å¤„ç†PNGæ ¼å¼è§’è‰²å¡
                await importPngCharacterCard(file);
            } else {
                alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹© .png æˆ– .json æ–‡ä»¶ã€‚');
            }
        } catch (error) {
            console.error('å¯¼å…¥è§’è‰²å¡å¤±è´¥:', error);
            alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
        }
    });
    input.click();
});

async function importJsonCharacterCard(file) {
const text = await file.text();
const cardData = JSON.parse(text);
let characterName, characterDesc, characterAvatar;
if (cardData.data) {
const data = cardData.data;
characterName = data.name || data.char_name || data.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = data.description || data.char_persona || data.personality || data.scenario || '';
characterAvatar = data.avatar || '';
if (!characterDesc && data.character_book && data.character_book.entries && data.character_book.entries.length > 0) {
characterDesc = `è¿™æ˜¯ä¸€ä¸ªåŒ…å«ä¸–ç•Œä¹¦çš„è§’è‰²å¡ï¼Œå…±æœ‰ ${data.character_book.entries.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®ã€‚ä¸»è¦ä¾èµ–ä¸–ç•Œä¹¦è®¾å®šè¿›è¡Œå¯¹è¯ã€‚`;
}
} else {
characterName = cardData.name || cardData.char_name || cardData.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = cardData.description || cardData.char_persona || cardData.personality || '';
characterAvatar = cardData.avatar || '';
}
const hasWorldBook = (cardData.data && cardData.data.character_book && cardData.data.character_book.entries && cardData.data.character_book.entries.length > 0);
await createChatFromCharacterCard(characterName, characterDesc, characterAvatar, hasWorldBook ? cardData : null);
}

// å¤„ç†PNGæ ¼å¼è§’è‰²å¡
async function importPngCharacterCard(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const arrayBuffer = e.target.result;
                const uint8Array = new Uint8Array(arrayBuffer);
                
                // æŸ¥æ‰¾PNGä¸­çš„æ–‡æœ¬å—ï¼ˆåŒ…å«è§’è‰²å¡æ•°æ®ï¼‰
                const textChunks = extractAllTextChunksFromPng(uint8Array);
                
                let characterData = null;
                
                // æŸ¥æ‰¾è§’è‰²å¡æ•°æ®ï¼Œå°è¯•å¤šç§å¯èƒ½çš„å…³é”®å­—
                const possibleKeys = ['chara', 'ccv3', 'Character', 'character', 'UserData', 'Comment'];
                
                for (const chunk of textChunks) {
                    if (possibleKeys.some(key => chunk.keyword.toLowerCase().includes(key.toLowerCase()))) {
                        try {
                            // å°è¯•å¤šç§è§£ç æ–¹å¼
                            let jsonStr = '';
                            
                            // æ–¹å¼1: ç›´æ¥è§£ç base64
                            try {
                                jsonStr = safeBase64Decode(chunk.text);
                            } catch (e1) {
                                // æ–¹å¼2: å…ˆå¤„ç†URLç¼–ç å†è§£ç base64
                                try {
                                    const decoded = decodeURIComponent(chunk.text);
                                    jsonStr = atob(decoded);
                                } catch (e2) {
                                    // æ–¹å¼3: ç›´æ¥å½“ä½œUTF-8å­—ç¬¦ä¸²
                                    jsonStr = chunk.text;
                                }
                            }
                            
                            // å°è¯•è§£æJSON
                            if (jsonStr) {
                                try {
                                    characterData = JSON.parse(jsonStr);
                                    console.log('æˆåŠŸè§£æè§’è‰²å¡æ•°æ®:', characterData);
                                    break;
                                } catch (e) {
                                    // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•ä¿®å¤å¸¸è§çš„JSONé—®é¢˜
                                    try {
                                        // ç§»é™¤å¯èƒ½çš„BOMå’Œæ§åˆ¶å­—ç¬¦
                                        const cleanJsonStr = jsonStr.replace(/^\uFEFF/, '').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
                                        characterData = JSON.parse(cleanJsonStr);
                                        console.log('ä¿®å¤åæˆåŠŸè§£æè§’è‰²å¡æ•°æ®:', characterData);
                                        break;
                                    } catch (e3) {
                                        console.warn(`è§£æå…³é”®å­— "${chunk.keyword}" çš„æ•°æ®å¤±è´¥:`, e3);
                                    }
                                }
                            }
                        } catch (e) {
                            console.warn(`å¤„ç†å…³é”®å­— "${chunk.keyword}" å¤±è´¥:`, e);
                        }
                    }
                }
                
                if (!characterData) {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°è§’è‰²å¡æ•°æ®ï¼Œå°è¯•ä»æ–‡ä»¶åæ¨æ–­
                    const fileName = file.name.replace(/\.(png|jpg|jpeg)$/i, '');
                    console.log('æœªæ‰¾åˆ°è§’è‰²å¡æ•°æ®ï¼Œä½¿ç”¨æ–‡ä»¶åä½œä¸ºè§’è‰²å:', fileName);
                    
                    const avatarDataUrl = await fileToDataURL(file);
                    await createChatFromCharacterCard(fileName, 'ä»å›¾ç‰‡å¯¼å…¥çš„è§’è‰²ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®è§’è‰²æè¿°ã€‚', avatarDataUrl);
                    resolve();
                    return;
                }
                
                // è§£æè§’è‰²æ•°æ® - æ”¯æŒå¤šç§æ ¼å¼
                let characterName, characterDesc, characterAvatar;
                
                // å°è¯•ä¸åŒçš„æ•°æ®ç»“æ„
                if (characterData.spec === 'chara_card_v3' || characterData.data) {
                    // V3æ ¼å¼æˆ–åµŒå¥—dataç»“æ„
                    const data = characterData.data || characterData;
                    characterName = data.name || data.char_name || data.character_name || 'æœªçŸ¥è§’è‰²';
                    characterDesc = data.description || data.char_persona || data.personality || 
                                  data.scenario || data.char_greeting || '';
                    characterAvatar = data.avatar || '';
                } else {
                    // V2æ ¼å¼æˆ–ç›´æ¥ç»“æ„
                    characterName = characterData.name || characterData.char_name || 
                                  characterData.character_name || 'æœªçŸ¥è§’è‰²';
                    characterDesc = characterData.description || characterData.char_persona || 
                                  characterData.personality || characterData.scenario || 
                                  characterData.char_greeting || '';
                    characterAvatar = characterData.avatar || '';
                }
                
                // å¤„ç†å¯èƒ½çš„ç¼–ç é—®é¢˜
characterName = fixEncoding(characterName);
characterDesc = fixEncoding(characterDesc);
// ä¿®å¤ä¸–ç•Œä¹¦å†…å®¹çš„ç¼–ç é—®é¢˜
if (characterData.data && characterData.data.character_book && characterData.data.character_book.entries) {
characterData.data.character_book.entries.forEach(entry => {
if (entry.content) entry.content = fixEncoding(entry.content);
if (entry.comment) entry.comment = fixEncoding(entry.comment);
if (entry.keys && Array.isArray(entry.keys)) {
entry.keys = entry.keys.map(key => fixEncoding(key));
}
});
} else if (characterData.character_book && characterData.character_book.entries) {
characterData.character_book.entries.forEach(entry => {
if (entry.content) entry.content = fixEncoding(entry.content);
if (entry.comment) entry.comment = fixEncoding(entry.comment);
if (entry.keys && Array.isArray(entry.keys)) {
entry.keys = entry.keys.map(key => fixEncoding(key));
}
});
}
const avatarDataUrl = await fileToDataURL(file);
await createChatFromCharacterCard(characterName, characterDesc, avatarDataUrl, characterData);
                resolve();
            } catch (error) {
                console.error('å¯¼å…¥PNGè§’è‰²å¡å¤±è´¥:', error);
                reject(error);
            }
        };
        reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
        reader.readAsArrayBuffer(file);
    });
}

// æ”¹è¿›çš„PNGæ–‡æœ¬å—æå–å‡½æ•°ï¼Œæ”¯æŒtEXtå’ŒiTXt
function extractAllTextChunksFromPng(uint8Array) {
    const chunks = [];
    let offset = 8; // è·³è¿‡PNGç­¾å
    
    while (offset < uint8Array.length) {
        if (offset + 8 > uint8Array.length) break;
        
        // è¯»å–å—é•¿åº¦
        const length = (uint8Array[offset] << 24) | (uint8Array[offset + 1] << 16) | 
                      (uint8Array[offset + 2] << 8) | uint8Array[offset + 3];
        offset += 4;
        
        // è¯»å–å—ç±»å‹
        const type = String.fromCharCode(...uint8Array.slice(offset, offset + 4));
        offset += 4;
        
        if (length > uint8Array.length - offset) break;
        
        if (type === 'tEXt') {
    // å¤„ç†tEXtå—
    const data = uint8Array.slice(offset, offset + length);
    const nullIndex = data.indexOf(0);
    
    if (nullIndex !== -1) {
        const keywordBytes = data.slice(0, nullIndex);
        const textBytes = data.slice(nullIndex + 1);
        
        // å®‰å…¨åœ°è§£ç å…³é”®å­—ï¼ˆé€šå¸¸æ˜¯ASCIIï¼‰
        let keyword;
        try {
            keyword = new TextDecoder('utf-8', {fatal: true}).decode(keywordBytes);
        } catch (e) {
            keyword = new TextDecoder('latin1').decode(keywordBytes);
        }
        
        // å®‰å…¨çš„Base64è§£ç å‡½æ•°
function safeBase64Decode(base64String) {
    try {
        // æ¸…ç†Base64å­—ç¬¦ä¸²
        const cleaned = base64String.replace(/[^A-Za-z0-9+/=]/g, '');
        
        // æ ‡å‡†Base64è§£ç 
        const decoded = atob(cleaned);
        
        // å°è¯•å°†ç»“æœè§£é‡Šä¸ºUTF-8
        const bytes = new Uint8Array(decoded.split('').map(char => char.charCodeAt(0)));
        return new TextDecoder('utf-8', {ignoreBOM: true}).decode(bytes);
    } catch (e) {
        console.warn('Base64è§£ç å¤±è´¥ï¼Œå°è¯•ç›´æ¥è¿”å›:', e);
        // å¦‚æœè§£ç å¤±è´¥ï¼Œè¿”å›åŸå§‹å­—ç¬¦ä¸²
        return base64String;
    }
}
        
        // å¯¹äºæ–‡æœ¬æ•°æ®ï¼Œå°è¯•å¤šç§è§£ç æ–¹å¼
        let text;
        try {
            // é¦–å…ˆå°è¯•UTF-8
            text = new TextDecoder('utf-8', {fatal: true}).decode(textBytes);
        } catch (e) {
            try {
                // å¦‚æœUTF-8å¤±è´¥ï¼Œå°è¯•Latin-1
                text = new TextDecoder('latin1').decode(textBytes);
            } catch (e2) {
                // æœ€åå°è¯•GBKæˆ–å…¶ä»–ç¼–ç ï¼ˆå¦‚æœå¯ç”¨ï¼‰
                text = String.fromCharCode(...textBytes);
            }
        }
        
        chunks.push({ keyword, text, type: 'tEXt' });
        console.log(`æå–åˆ°tEXtå—: ${keyword} = ${text.substring(0, 100)}...`);
    }
} else if (type === 'iTXt') {
            // å¤„ç†iTXtå—ï¼ˆæ”¯æŒå›½é™…åŒ–æ–‡æœ¬ï¼‰
            const data = uint8Array.slice(offset, offset + length);
            const nullIndex1 = data.indexOf(0);
            
            if (nullIndex1 !== -1) {
                const keyword = new TextDecoder('utf-8').decode(data.slice(0, nullIndex1));
                
                // iTXtæ ¼å¼: keyword\0compression_flag\0compression_method\0language_tag\0translated_keyword\0text
                let dataOffset = nullIndex1 + 1;
                
                if (dataOffset < data.length) {
                    const compressionFlag = data[dataOffset];
                    dataOffset += 1;
                    
                    if (dataOffset < data.length) {
                        const compressionMethod = data[dataOffset];
                        dataOffset += 1;
                        
                        // è·³è¿‡è¯­è¨€æ ‡ç­¾
                        const nullIndex2 = data.indexOf(0, dataOffset);
                        if (nullIndex2 !== -1) {
                            dataOffset = nullIndex2 + 1;
                            
                            // è·³è¿‡ç¿»è¯‘å…³é”®å­—
                            const nullIndex3 = data.indexOf(0, dataOffset);
                            if (nullIndex3 !== -1) {
                                dataOffset = nullIndex3 + 1;
                                
                                // è·å–å®é™…æ–‡æœ¬
                                let textData = data.slice(dataOffset);
                                
                                if (compressionFlag === 1) {
                                    // å¦‚æœå‹ç¼©äº†ï¼Œéœ€è¦è§£å‹ç¼©ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                                    console.warn('å‹ç¼©çš„iTXtå—æš‚ä¸æ”¯æŒ');
                                } else {
                                    const text = new TextDecoder('utf-8').decode(textData);
                                    chunks.push({ keyword, text, type: 'iTXt' });
                                }
                            }
                        }
                    }
                }
            }
        }
        
        offset += length + 4; // è·³è¿‡æ•°æ®å’ŒCRC
        
        if (type === 'IEND') break;
    }
    
    return chunks;
}

function fixEncoding(text) {
if (!text || typeof text !== 'string') return text;
try {
if (/[Ã Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã¯Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾Ã¿]/.test(text) || /[Ã§Â§Â©ÂªÂ«Â¬Â®Â¯Â°Â±Â²Â³Â´ÂµÂ¶Â·Â¸Â¹ÂºÂ»Â¼Â½Â¾Â¿]/.test(text)) {
const bytes = new Uint8Array(text.split('').map(char => char.charCodeAt(0) & 0xFF));
const utf8Text = new TextDecoder('utf-8').decode(bytes);
if (/[\u4e00-\u9fff]/.test(utf8Text)) {
return utf8Text;
}
}
if (/Ã¦[Â¥Â§Â©ÂªÂ«Â¬Â®Â¯Â°Â±Â²Â³Â´ÂµÂ¶Â·Â¸Â¹ÂºÂ»Â¼Â½Â¾Â¿]/.test(text) || /Ã§[Â§Â©ÂªÂ«Â¬Â®Â¯Â°Â±Â²Â³Â´ÂµÂ¶Â·Â¸Â¹ÂºÂ»Â¼Â½Â¾Â¿]/.test(text)) {
const bytes = new Uint8Array(text.split('').map(char => char.charCodeAt(0) & 0xFF));
const utf8Text = new TextDecoder('utf-8').decode(bytes);
if (/[\u4e00-\u9fff]/.test(utf8Text)) {
return utf8Text;
}
}
return text;
} catch (e) {
return text;
}
}

// å°†æ–‡ä»¶è½¬æ¢ä¸ºDataURL
function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('æ–‡ä»¶è½¬æ¢å¤±è´¥'));
        reader.readAsDataURL(file);
    });
}

// æ ¹æ®è§’è‰²å¡æ•°æ®åˆ›å»ºèŠå¤©
function downloadChatHistory() {
if (!state.activeChatId) return;
const chat = state.chats[state.activeChatId];
const currentTime = new Date().toLocaleString('zh-CN').replace(/[\/\s:]/g, '-');
const fileName = `${chat.name}_${currentTime}.json`;
const chatData = [];
chat.history.forEach(msg => {
if (msg.role === 'user') {
chatData.push({
"user": chat.isGroup ? (chat.settings.myNickname || 'æˆ‘') : 'æˆ‘',
"message": msg
});
} else {
const charName = chat.isGroup ? (msg.senderName || 'æœªçŸ¥æˆå‘˜') : chat.name;
chatData.push({
"char": charName,
"message": msg
});
}
});
const jsonStr = JSON.stringify(chatData, null, 2);
const blob = new Blob([jsonStr], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = fileName;
a.click();
URL.revokeObjectURL(url);
alert(`èŠå¤©è®°å½•å·²ä¸‹è½½ä¸º ${fileName}`);
}
async function uploadChatHistory(event) {
const file = event.target.files[0];
if (!file || !state.activeChatId) return;
try {
const text = await file.text();
const chatData = JSON.parse(text);
if (!Array.isArray(chatData)) throw new Error('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„æ ¼å¼');
const confirmed = await showCustomConfirm('å¯¼å…¥èŠå¤©è®°å½•', `ç¡®å®šè¦å¯¼å…¥ ${chatData.length} æ¡æ¶ˆæ¯å—ï¼Ÿè¿™å°†æ·»åŠ åˆ°å½“å‰èŠå¤©ä¸­ã€‚`);
if (!confirmed) return;
const chat = state.chats[state.activeChatId];
chatData.forEach(item => {
const timestamp = Date.now() + Math.random() * 1000;
if (item.user && item.message) {
const msg = {...item.message};
msg.role = 'user';
msg.timestamp = timestamp;
chat.history.push(msg);
} else if (item.char && item.message) {
const msg = {...item.message};
msg.role = 'assistant';
msg.timestamp = timestamp;
if (chat.isGroup) msg.senderName = item.char;
chat.history.push(msg);
}
});
await db.chats.put(chat);
renderChatInterface(state.activeChatId);
renderChatList();
alert(`æˆåŠŸå¯¼å…¥ ${chatData.length} æ¡æ¶ˆæ¯`);
} catch (error) {
alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
} finally {
event.target.value = '';
}
}
        async function createChatFromCharacterCard(characterName, description, avatar, cardData = null) {
if (!characterName || !characterName.trim()) { throw new Error('è§’è‰²åç§°ä¸èƒ½ä¸ºç©º'); }
const newChatId = 'chat_' + Date.now();
const linkedWorldBookIds = [];
if (cardData && cardData.data && cardData.data.character_book && cardData.data.character_book.entries) {
const entries = cardData.data.character_book.entries;
const folderName = `${characterName}_ä¸–ç•Œä¹¦`;
let folder = state.worldBookFolders.find(f => f.name === folderName);
if (!folder) { folder = { id: 'folder_' + Date.now(), name: folderName }; await db.worldBookFolders.add(folder); state.worldBookFolders.push(folder); }
for (const entry of entries) {
if (!entry.content) continue;
let bookName = '';
if (entry.comment && entry.comment.trim()) { bookName = fixEncoding(entry.comment.trim()); } else if (entry.keys && entry.keys.length > 0 && entry.keys[0].trim()) { bookName = fixEncoding(entry.keys[0].trim()); } else { bookName = `ä¸–ç•Œä¹¦_${entry.id || Date.now()}`; }
const newBook = { id: 'wb_' + Date.now() + '_' + (entry.id || Math.random()), name: bookName, content: entry.content, folderId: folder.id };
await db.worldBooks.add(newBook);
state.worldBooks.push(newBook);
linkedWorldBookIds.push(newBook.id);
}
}
const newChat = { id: newChatId, name: characterName.trim(), isGroup: false, settings: { aiPersona: description || 'ä¸€ä¸ªæœ‰è¶£çš„è§’è‰²ã€‚', myPersona: 'æˆ‘æ˜¯è°å‘€ã€‚', maxMemory: 10, aiAvatar: avatar || defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', linkedWorldBookIds: linkedWorldBookIds, aiAvatarFrame: '', myAvatarFrame: '' }, history: [], musicData: { totalTime: 0 } };
state.chats[newChatId] = newChat;
await db.chats.put(newChat);
renderChatList();
if (linkedWorldBookIds.length > 0) { alert(`æˆåŠŸå¯¼å…¥è§’è‰²å¡ï¼š"${characterName}"ï¼ŒåŒæ—¶å¯¼å…¥äº† ${linkedWorldBookIds.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®å¹¶å·²è‡ªåŠ¨å…³è”ã€‚`); } else { alert(`æˆåŠŸå¯¼å…¥è§’è‰²å¡ï¼š"${characterName}"`); }
}
            
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-shuffle-btn').addEventListener('click', async () => {
musicState.isRandom = !musicState.isRandom;
document.getElementById('music-shuffle-btn').style.color = musicState.isRandom ? '#007bff' : '#666';
await saveGlobalPlaylist();
});
document.getElementById('music-repeat-btn').addEventListener('click', async () => {
const modes = ['off', 'single', 'all'];
const currentIndex = modes.indexOf(musicState.repeatMode || 'off');
musicState.repeatMode = modes[(currentIndex + 1) % modes.length];
const btn = document.getElementById('music-repeat-btn');
switch(musicState.repeatMode) {
case 'single': 
btn.innerHTML = '<span style="position: relative;"><i class="fa-solid fa-repeat"></i><span style="position: absolute; top: -3px; right: -8px; font-size: 8px; background: #007bff; color: white; border-radius: 50%; width: 10px; height: 10px; display: flex; align-items: center; justify-content: center;">1</span></span>'; 
btn.style.color = '#007bff'; 
break;
case 'all': 
btn.innerHTML = '<i class="fa-solid fa-repeat"></i>'; 
btn.style.color = '#007bff'; 
break;
default: 
btn.innerHTML = '<i class="fa-solid fa-repeat"></i>'; 
btn.style.color = '#666'; 
break;
}
await saveGlobalPlaylist();
});


// è¿›åº¦æ¡æ§åˆ¶
document.getElementById('music-progress').addEventListener('input', (e) => {
    if (audioPlayer && audioPlayer.duration) {
        const newTime = (e.target.value / 100) * audioPlayer.duration;
        audioPlayer.currentTime = newTime;
    }
});

// æ”¶è—æŒ‰é’®
document.getElementById('music-favorite-btn').addEventListener('click', async (e) => {
    e.stopPropagation();
    e.preventDefault();
    
    if (musicState.currentIndex < 0 || !musicState.playlist.length) return;
    
    const track = musicState.playlist[musicState.currentIndex];
    const button = e.currentTarget;
    
    // åˆ‡æ¢æ”¶è—çŠ¶æ€
    track.isFavorite = !track.isFavorite;
    
    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    button.classList.toggle('active', track.isFavorite);
    button.innerHTML = track.isFavorite ? '<i class="fa-solid fa-heart"></i>' : '<i class="fa-regular fa-heart"></i>';
    
    // å¦‚æœæ˜¯æ”¶è—ï¼Œå°†æ­Œæ›²ç§»åˆ°åˆ—è¡¨é¡¶éƒ¨
    if (track.isFavorite) {
        const currentTrack = musicState.playlist.splice(musicState.currentIndex, 1)[0];
        musicState.playlist.unshift(currentTrack);
        musicState.currentIndex = 0;
    }
    
    // ä¿å­˜åˆ°æ•°æ®åº“
    await saveGlobalPlaylist();
    updatePlaylistUI();
});

// å®šæ—¶æ›´æ–°è¿›åº¦æ¡å’Œå¯è§†åŒ–æ•ˆæœ
setInterval(() => {
    if (musicState.isActive && musicState.isPlaying) {
        updateProgressBar();
        updateVisualizer();
        
        // æ›´æ–°è¿·ä½ æ­Œè¯
        if (audioPlayer && audioPlayer.currentTime) {
            updateMiniLyrics(audioPlayer.currentTime);
        }
    }
}, 100);

            document.getElementById('music-playlist-btn').addEventListener('click', () => { 
                updatePlaylistUI(); 
                document.getElementById('music-playlist-panel').classList.add('visible'); 
            });
            
            // è¿·ä½ æ­Œè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('mini-lyrics-btn').addEventListener('click', async () => {
                const miniLyricsDisplay = document.getElementById('mini-lyrics-display');
                if (miniLyricsDisplay.style.display === 'none' || !miniLyricsDisplay.style.display) {
                    miniLyricsDisplay.style.display = 'block';
                    STATE.ui.showMiniLyrics = true;
                    
                    // å°è¯•åŠ è½½å½“å‰æ’­æ”¾æ­Œæ›²çš„æ­Œè¯
                    await loadMiniLyricsForCurrentTrack();
                } else {
                    miniLyricsDisplay.style.display = 'none';
                    STATE.ui.showMiniLyrics = false;
                }
            });
            
            // ä¿®æ”¹é€€å‡ºä¸€èµ·å¬æŒ‰é’®äº‹ä»¶
            document.getElementById('music-exit-btn').addEventListener('click', () => {
                endListenTogetherSession(true);
                // éšè—è¿·ä½ æ­Œè¯
                document.getElementById('mini-lyrics-display').style.display = 'none';
                STATE.ui.showMiniLyrics = false;
            });
            
            // ä¿®æ”¹è¿”å›èŠå¤©æŒ‰é’®äº‹ä»¶  
            document.getElementById('music-return-btn').addEventListener('click', () => {
                returnToChat();
                // å¦‚æœéŸ³ä¹åœ¨æ’­æ”¾ä¸”ç”¨æˆ·å¼€å¯äº†è¿·ä½ æ­Œè¯ï¼Œåˆ™ç»§ç»­æ˜¾ç¤º
                if (!STATE.audio.paused && STATE.ui.showMiniLyrics) {
                    document.getElementById('mini-lyrics-display').style.display = 'block';
                }
            });

            // è¿·ä½ æ­Œè¯ç›¸å…³å˜é‡
let miniLyricsData = {
    current: [],
    translated: [],
    currentIndex: -1,
    isActive: false
};

// å…¨å±€çŠ¶æ€å¯¹è±¡ï¼Œç”¨äºè¿·ä½ æ­Œè¯åŠŸèƒ½
const STATE = {
    ui: {
        showMiniLyrics: false
    },
    audio: {
        paused: true
    }
};

            // è·å–æ­Œè¯å‡½æ•°
async function fetchMiniLyrics(songId, source) {
    if (!songId) return null;
    
    try {
        let url = "";
        if (source === "netease") {
            url = `https://api.vkeys.cn/v2/music/netease/lyric?id=${songId}`;
        } else if (source === "tencent") {
            url = `https://api.vkeys.cn/v2/music/tencent/lyric?id=${songId}`;
        } else {
            return null;
        }

        console.log('æ­£åœ¨è·å–æ­Œè¯:', url);
        const response = await fetch(url);
        
        if (!response.ok) {
            console.error('æ­Œè¯APIå“åº”é”™è¯¯:', response.status, response.statusText);
            return null;
        }
        
        const data = await response.json();
        console.log('æ­Œè¯APIè¿”å›æ•°æ®:', data);
        
        // æ›´å®½æ¾çš„æ•°æ®æ£€æŸ¥
        if (!data) {
            console.error('APIè¿”å›ç©ºæ•°æ®');
            return null;
        }
        
        // å°è¯•å¤šç§å¯èƒ½çš„æ•°æ®ç»“æ„
        let lrcText = null;
        let transText = null;
        
        if (data.data) {
            lrcText = data.data.lrc || data.data.lyric || data.data.lrcContent;
            transText = data.data.trans || data.data.tlyric || data.data.transContent;
        } else if (data.lrc || data.lyric) {
            lrcText = data.lrc || data.lyric;
            transText = data.trans || data.tlyric;
        } else if (data.code === 200 && data.result) {
            lrcText = data.result.lrc || data.result.lyric;
            transText = data.result.trans || data.result.tlyric;
        }
        
        if (!lrcText) {
            console.error('æœªæ‰¾åˆ°æ­Œè¯å†…å®¹');
            return null;
        }
        
        return { lrcText, transText };
    } catch (error) {
        console.error("è·å–æ­Œè¯å¤±è´¥:", error);
        return null;
    }
}

            // è§£ææ­Œè¯å‡½æ•°
            function parseMiniLyrics(lrcText, transText) {
                const lyrics = [];
                const translations = [];
                
                if (!lrcText) return { lyrics, translations };
                
                const lines = lrcText.split('\n');
                const timeRegex = /\[(\d{2,}):(\d{2})[.:](\d{2,3})\]/g;
                
                for (let line of lines) {
                    line = line.trim();
                    if (!line) continue;
                    
                    let timestamps = [];
                    let lyricText = line;
                    let match;
                    timeRegex.lastIndex = 0;
                    
                    while ((match = timeRegex.exec(line)) !== null) {
                        const minutes = parseInt(match[1], 10);
                        const seconds = parseInt(match[2], 10);
                        const millisecondsStr = match[3] || "0";
                        const milliseconds = parseInt(millisecondsStr.padEnd(3, '0').slice(0, 3), 10);
                        const timeInSeconds = minutes * 60 + seconds + milliseconds / 1000;
                        
                        if (!isNaN(timeInSeconds)) {
                            timestamps.push(timeInSeconds);
                        }
                        lyricText = lyricText.replace(match[0], '');
                    }
                    
                    lyricText = lyricText.trim();
                    if (timestamps.length > 0) {
                        for (const time of timestamps) {
                            lyrics.push({ time: time, text: lyricText || "â™ª" });
                        }
                    }
                }
                
                lyrics.sort((a, b) => a.time - b.time);
                
                // è§£æç¿»è¯‘æ­Œè¯
                if (transText) {
                    const transLines = transText.split('\n');
                    for (let line of transLines) {
                        line = line.trim();
                        if (!line) continue;
                        
                        let timestamps = [];
                        let transText = line;
                        let match;
                        timeRegex.lastIndex = 0;
                        
                        while ((match = timeRegex.exec(line)) !== null) {
                            const minutes = parseInt(match[1], 10);
                            const seconds = parseInt(match[2], 10);
                            const millisecondsStr = match[3] || "0";
                            const milliseconds = parseInt(millisecondsStr.padEnd(3, '0').slice(0, 3), 10);
                            const timeInSeconds = minutes * 60 + seconds + milliseconds / 1000;
                            
                            if (!isNaN(timeInSeconds)) {
                                timestamps.push(timeInSeconds);
                            }
                            transText = transText.replace(match[0], '');
                        }
                        
                        transText = transText.trim();
                        if (timestamps.length > 0 && transText) {
                            for (const time of timestamps) {
                                translations.push({ time: time, text: transText });
                            }
                        }
                    }
                    translations.sort((a, b) => a.time - b.time);
                }
                
                return { lyrics, translations };
            }

            // æ›´æ–°è¿·ä½ æ­Œè¯æ˜¾ç¤º
            function updateMiniLyrics(currentTime) {
                if (!STATE.ui.showMiniLyrics || miniLyricsData.current.length === 0) return;
                
                let activeIndex = -1;
                for (let i = 0; i < miniLyricsData.current.length; i++) {
                    if (currentTime >= miniLyricsData.current[i].time) {
                        if (i === miniLyricsData.current.length - 1 || currentTime < miniLyricsData.current[i + 1].time) {
                            activeIndex = i;
                            break;
                        }
                    }
                }
                
                if (activeIndex !== miniLyricsData.currentIndex) {
                    miniLyricsData.currentIndex = activeIndex;
                    
                    if (activeIndex >= 0) {
                        const currentLyric = miniLyricsData.current[activeIndex];
                        document.getElementById('mini-lyrics-text').textContent = currentLyric.text;
                        
                        // æŸ¥æ‰¾å¯¹åº”çš„ç¿»è¯‘
                        const translation = miniLyricsData.translated.find(t => 
                            Math.abs(t.time - currentLyric.time) < 0.5
                        );
                        
                        const translationDiv = document.getElementById('mini-lyrics-translation');
                        if (translation) {
                            translationDiv.textContent = translation.text;
                            translationDiv.style.display = 'block';
                        } else {
                            translationDiv.style.display = 'none';
                        }
                    }
                }
            }

            // åœ¨éŸ³é¢‘æ’­æ”¾æ—¶åŠ è½½æ­Œè¯
async function loadMiniLyricsForCurrentTrack() {
    if (!musicState.isActive || musicState.currentIndex < 0 || !musicState.playlist.length) return;
    
    const currentTrack = musicState.playlist[musicState.currentIndex];
    if (!currentTrack) {
        console.log('å½“å‰æ²¡æœ‰æ’­æ”¾çš„æ­Œæ›²');
        return;
    }
    
    console.log('å½“å‰æ’­æ”¾æ­Œæ›²:', currentTrack);
    
    if (!currentTrack.id || !currentTrack.source) {
        console.log('æ­Œæ›²ç¼ºå°‘IDæˆ–éŸ³æºä¿¡æ¯');
        document.getElementById('mini-lyrics-text').textContent = 'æš‚æ— æ­Œè¯ä¿¡æ¯';
        return;
    }
    
    document.getElementById('mini-lyrics-text').textContent = 'æ­£åœ¨è·å–æ­Œè¯...';
    
    try {
        const lyricsData = await fetchMiniLyrics(currentTrack.id, currentTrack.source);
        if (lyricsData && lyricsData.lrcText) {
            console.log('æˆåŠŸè·å–æ­Œè¯æ•°æ®');
            const parsed = parseMiniLyrics(lyricsData.lrcText, lyricsData.transText);
            miniLyricsData.current = parsed.lyrics;
            miniLyricsData.translated = parsed.translations;
            miniLyricsData.currentIndex = -1;
            
            console.log('è§£æåçš„æ­Œè¯æ¡æ•°:', parsed.lyrics.length);
            
            if (parsed.lyrics.length === 0) {
                document.getElementById('mini-lyrics-text').textContent = 'çº¯éŸ³ä¹ï¼Œè¯·æ¬£èµ';
            } else {
                document.getElementById('mini-lyrics-text').textContent = 'æ­Œè¯å·²åŠ è½½';
            }
        } else {
            console.log('æœªè·å–åˆ°æœ‰æ•ˆæ­Œè¯æ•°æ®');
            document.getElementById('mini-lyrics-text').textContent = 'æš‚æ— æ­Œè¯';
            miniLyricsData.current = [];
            miniLyricsData.translated = [];
        }
    } catch (error) {
        console.error('åŠ è½½æ­Œè¯æ—¶å‡ºé”™:', error);
        document.getElementById('mini-lyrics-text').textContent = 'æ­Œè¯åŠ è½½å¤±è´¥';
        miniLyricsData.current = [];
        miniLyricsData.translated = [];
    }
}
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
document.getElementById('search-music-btn').addEventListener('click', openMusicSearchModal);
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', () => {
if (musicState.repeatMode === 'single') {
playSong(musicState.currentIndex);
} else if (musicState.repeatMode === 'all') {
playNext();
} else if (musicState.repeatMode === 'off') {
if (musicState.currentIndex < musicState.playlist.length - 1) {
playNext();
} else {
musicState.isPlaying = false;
updatePlayerUI();
}
} else {
playNext();
}
});

// æ·»åŠ æ’­æ”¾é”™è¯¯å¤„ç†å’Œè‡ªåŠ¨é‡è¯•æœºåˆ¶
audioPlayer.addEventListener('error', async (e) => {
if (!musicState.isActive || musicState.currentIndex < 0) return;
const track = musicState.playlist[musicState.currentIndex];
if (!track || track.isLocal) return;
console.log('æ’­æ”¾å‡ºé”™ï¼Œå°è¯•é‡æ–°è·å–æ’­æ”¾é“¾æ¥...');
if (!track.retryCount) track.retryCount = 0;
if (track.retryCount < 2) {
track.retryCount++;
try {
const newPlayUrl = await getMusicPlayUrl(track.id, track.source);
if (newPlayUrl) {
track.src = newPlayUrl;
await saveGlobalPlaylist();
console.log(`ç¬¬${track.retryCount}æ¬¡é‡è¯•æ’­æ”¾: ${track.name}`);
await playSong(musicState.currentIndex);
}
} catch (error) {
console.error(`é‡è¯•æ’­æ”¾å¤±è´¥: ${error.message}`);
if (track.retryCount >= 2) {
alert(`æ­Œæ›²"${track.name}"æ’­æ”¾å¤±è´¥ï¼Œé“¾æ¥å·²å¤±æ•ˆï¼Œå°†è·³è¿‡æ­¤æ­Œæ›²`);
playNext();
}
}
} else {
alert(`æ­Œæ›²"${track.name}"å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œå°†è·³è¿‡æ­¤æ­Œæ›²`);
playNext();
}
});

            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', async () => { 
    if(musicState.isActive) { 
        musicState.isPlaying = true; 
        updatePlayerUI(); 
        
        // å½“å¼€å§‹æ’­æ”¾æ—¶åŠ è½½æ­Œè¯
        if (STATE && STATE.ui && STATE.ui.showMiniLyrics) {
            await loadMiniLyricsForCurrentTrack();
        }
    } 
});
            
            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => { if (newWallpaperBase64) { state.globalSettings.wallpaper = newWallpaperBase64; await db.globalSettings.put(state.globalSettings); applyGlobalWallpaper(); newWallpaperBase64 = null; alert('å£çº¸å·²ä¿å­˜å¹¶åº”ç”¨ï¼'); showScreen('home-screen'); } else alert('è¯·å…ˆä¸Šä¼ ä¸€å¼ æ–°å£çº¸ã€‚'); });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); alert('APIè®¾ç½®å·²ä¿å­˜!'); });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('è¯·å…ˆå¡«å†™åä»£åœ°å€å’Œå¯†é’¥'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('æ¨¡å‹åˆ—è¡¨å·²æ›´æ–°'); } catch (error) { alert(`æ‹‰å–æ¨¡å‹å¤±è´¥: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºä¸–ç•Œä¹¦', 'è¯·è¾“å…¥ä¹¦å'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            
            document.getElementById('import-world-book-btn').addEventListener('click', () => { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.addEventListener('change', async (e) => { const file = e.target.files[0]; if (!file) return; try { const text = await file.text(); const jsonData = JSON.parse(text); await importWorldBookFromJson(jsonData, file.name); } catch (error) { alert('JSONæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼š' + error.message); } }); input.click(); });

document.getElementById('add-folder-btn').addEventListener('click', async () => { const name = await showCustomPrompt('åˆ›å»ºæ–‡ä»¶å¤¹', 'è¯·è¾“å…¥æ–‡ä»¶å¤¹åç§°'); if (name && name.trim()) { const newFolder = { id: 'folder_' + Date.now(), name: name.trim() }; await db.worldBookFolders.add(newFolder); state.worldBookFolders.push(newFolder); renderWorldBookScreen(); } });

document.getElementById('wb-select-all-btn').addEventListener('click', () => {
    // è·å–æ‰€æœ‰ä¸–ç•Œä¹¦ID
    const allBookIds = state.worldBooks.map(book => book.id);
    
    // å¦‚æœå·²ç»å…¨é€‰äº†ï¼Œåˆ™å–æ¶ˆå…¨é€‰
    if (selectedWorldBooks.size === allBookIds.length) {
        selectedWorldBooks.clear();
        document.querySelectorAll('.list-item').forEach(item => {
            item.classList.remove('selected');
        });
        exitWorldBookSelectionMode();
    } else {
        // å¦åˆ™å…¨é€‰æ‰€æœ‰ä¸–ç•Œä¹¦
        allBookIds.forEach(bookId => {
            selectedWorldBooks.add(bookId);
            const item = document.querySelector(`[data-book-id="${bookId}"]`);
            if (item) item.classList.add('selected');
        });
        document.getElementById('wb-selection-count').textContent = `å·²é€‰ ${selectedWorldBooks.size} é¡¹`;
    }
});

document.getElementById('wb-selection-cancel-btn').addEventListener('click', exitWorldBookSelectionMode);
document.getElementById('wb-selection-delete-btn').addEventListener('click', async () => { 
if (selectedWorldBooks.size === 0) return; 
const confirmed = await showCustomConfirm('åˆ é™¤ä¸–ç•Œä¹¦', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedWorldBooks.size} æœ¬ä¸–ç•Œä¹¦å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); 
if (confirmed) { 
worldBookScrollPosition = document.getElementById('world-book-list').scrollTop; 
for (const bookId of selectedWorldBooks) { 
await db.worldBooks.delete(bookId); 
state.worldBooks = state.worldBooks.filter(wb => wb.id !== bookId); 
} 
exitWorldBookSelectionMode(); 
renderWorldBookScreen(); 
setTimeout(() => { document.getElementById('world-book-list').scrollTop = worldBookScrollPosition; }, 50); 
} 
});

document.getElementById('download-world-book-btn').addEventListener('click', () => { if (state.worldBooks.length === 0) { alert('æ²¡æœ‰å¯ä¸‹è½½çš„ä¸–ç•Œä¹¦'); return; } enterWorldBookSelectionMode(); });
document.getElementById('wb-selection-download-btn').addEventListener('click', async () => { if (selectedWorldBooks.size === 0) return; await downloadSelectedWorldBooks(); });

async function downloadSelectedWorldBooks() { const selectedBooks = state.worldBooks.filter(book => selectedWorldBooks.has(book.id)); if (selectedBooks.length === 0) { alert('è¯·é€‰æ‹©è¦ä¸‹è½½çš„ä¸–ç•Œä¹¦'); return; } const exportData = { entries: {} }; selectedBooks.forEach((book, index) => { const uid = `wb_${Date.now()}_${index}`; exportData.entries[uid] = { content: book.content, comment: book.name, key: [book.name] }; }); const jsonStr = JSON.stringify(exportData, null, 2); const blob = new Blob([jsonStr], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const currentTime = new Date().toLocaleString('zh-CN').replace(/[\/\s:]/g, '-'); a.download = `ä¸–ç•Œä¹¦åˆé›†_${currentTime}.json`; a.click(); URL.revokeObjectURL(url); exitWorldBookSelectionMode(); alert(`å·²ä¸‹è½½ ${selectedBooks.length} æœ¬ä¸–ç•Œä¹¦åˆ°æ–‡ä»¶: ä¸–ç•Œä¹¦åˆé›†_${currentTime}.json`); }
            async function importWorldBookFromJson(jsonData, fileName) {
const importedBooks = [];
const folderName = fileName.replace(/\.json$/i, '');
let folder = state.worldBookFolders.find(f => f.name === folderName);
if (!folder) { folder = { id: 'folder_' + Date.now(), name: folderName }; await db.worldBookFolders.add(folder); state.worldBookFolders.push(folder); }
try {
if (jsonData.entries) {
const entries = jsonData.entries;
for (const [uid, entry] of Object.entries(entries)) {
if (!entry.content) continue;
let bookName = '';
if (entry.comment && entry.comment.trim()) { bookName = entry.comment.trim(); } else if (entry.key && entry.key.length > 0 && entry.key[0].trim()) { bookName = entry.key[0].trim(); } else { bookName = `ä¸–ç•Œä¹¦_${uid}`; }
await importSingleWorldBook(bookName, entry.content, uid, importedBooks, folder.id);
}
} else if (jsonData.data && jsonData.data.character_book && jsonData.data.character_book.entries && Array.isArray(jsonData.data.character_book.entries)) {
const entries = jsonData.data.character_book.entries;
for (const entry of entries) {
if (!entry.content) continue;
let bookName = '';
if (entry.comment && entry.comment.trim()) { bookName = entry.comment.trim(); } else if (entry.keys && entry.keys.length > 0 && entry.keys[0].trim()) { bookName = entry.keys[0].trim(); } else { bookName = `ä¸–ç•Œä¹¦_${entry.id || Date.now()}`; }
const uid = entry.id || Date.now();
await importSingleWorldBook(bookName, entry.content, uid, importedBooks, folder.id);
}
} else if (jsonData.data && jsonData.data.prompts && Array.isArray(jsonData.data.prompts)) {
const prompts = jsonData.data.prompts;
for (const prompt of prompts) {
if (!prompt.content) continue;
const bookName = prompt.name || prompt.identifier || `ä¸–ç•Œä¹¦_${Date.now()}`;
const uid = prompt.identifier || Date.now();
await importSingleWorldBook(bookName, prompt.content, uid, importedBooks, folder.id);
}
} else if (jsonData.prompts && Array.isArray(jsonData.prompts)) {
const prompts = jsonData.prompts;
for (const prompt of prompts) {
if (!prompt.content) continue;
const bookName = prompt.name || prompt.identifier || `ä¸–ç•Œä¹¦_${Date.now()}`;
const uid = prompt.identifier || Date.now();
await importSingleWorldBook(bookName, prompt.content, uid, importedBooks, folder.id);
}
} else if (Array.isArray(jsonData)) {
for (let i = 0; i < jsonData.length; i++) {
const item = jsonData[i];
if (!item.content) continue;
const bookName = item.name || `ä¸–ç•Œä¹¦_${item.id || i + 1}`;
const uid = item.id || Date.now() + i;
await importSingleWorldBook(bookName, item.content, uid, importedBooks, folder.id);
}
} else {
alert('ä¸æ”¯æŒçš„JSONæ ¼å¼ã€‚\n\næ”¯æŒçš„æ ¼å¼åŒ…æ‹¬ï¼š\n1. Character Cardä¸–ç•Œä¹¦æ ¼å¼ (entrieså­—æ®µ)\n2. è§’è‰²å¡å†…åµŒä¸–ç•Œä¹¦æ ¼å¼ (data.character_book.entrieså­—æ®µ)\n3. åµŒå¥—æ¨¡æ¿æ ¼å¼ (data.promptså­—æ®µ)\n4. æ ¹çº§promptsæ ¼å¼ (promptså­—æ®µ)\n5. ç®€å•æ•°ç»„æ ¼å¼ (name+content)');
return;
}
if (importedBooks.length > 0) { renderWorldBookScreen(); alert(`æˆåŠŸå¯¼å…¥ ${importedBooks.length} æœ¬ä¸–ç•Œä¹¦åˆ°æ–‡ä»¶å¤¹"${folderName}"ï¼š\n${importedBooks.join('\n')}`); } else { alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ä¸–ç•Œä¹¦æ¡ç›®'); }
} catch (error) { console.error('å¯¼å…¥é”™è¯¯:', error); alert('å¯¼å…¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼š' + error.message); }
}

// ä¿®æ”¹è¾…åŠ©å‡½æ•°ï¼šå¯¼å…¥å•ä¸ªä¸–ç•Œä¹¦
async function importSingleWorldBook(bookName, content, uid, importedBooks, folderId) {
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåä¸–ç•Œä¹¦
    const existingBook = state.worldBooks.find(book => book.name === bookName && book.folderId === folderId);
    if (existingBook) {
        const shouldReplace = await showCustomConfirm(
            'é‡å¤ä¸–ç•Œä¹¦', 
            `å·²å­˜åœ¨åä¸º"${bookName}"çš„ä¸–ç•Œä¹¦ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`, 
            { confirmButtonClass: 'btn-danger' }
        );
        if (shouldReplace) {
            existingBook.content = content;
            await db.worldBooks.put(existingBook);
            importedBooks.push(bookName);
        }
    } else {
        const newBook = {
            id: 'wb_' + Date.now() + '_' + uid,
            name: bookName,
            content: content,
            folderId: folderId
        };
        await db.worldBooks.add(newBook);
        state.worldBooks.push(newBook);
        importedBooks.push(bookName);
    }
}
            
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { 
if (!editingWorldBookId) return; 
const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); 
if (book) { 
const newName = document.getElementById('world-book-name-input').value.trim(); 
if (!newName) { alert('ä¹¦åä¸èƒ½ä¸ºç©ºï¼'); return; } 
book.name = newName; 
book.content = document.getElementById('world-book-content-input').value; 
await db.worldBooks.put(book); 
document.getElementById('world-book-editor-title').textContent = newName; 
editingWorldBookId = null; 
renderWorldBookScreen(); 
showScreen('world-book-screen'); 
setTimeout(() => { document.getElementById('world-book-list').scrollTop = worldBookScrollPosition; }, 50); 
} 
});
            
            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ç…§ç‰‡æè¿°', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('è¯­éŸ³å†…å®¹', text); return; } });
            
            // æ»‘åŠ¨æ¡å®æ—¶æ›´æ–°æ˜¾ç¤ºå€¼
            document.addEventListener('input', (e) => {
                if (e.target.id === 'visible-message-limit-slider') {
                    const value = parseInt(e.target.value);
                    const valueDisplay = document.getElementById('visible-message-limit-value');
                    valueDisplay.textContent = value === 0 ? 'å…¨éƒ¨' : value;
                }
            });

            document.getElementById('chat-settings-btn').addEventListener('click', () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const isGroup = chat.isGroup; document.getElementById('chat-name-group').style.display = 'block'; document.getElementById('chat-name-input').value = chat.name; document.getElementById('my-persona-group').style.display = 'block'; document.getElementById('my-persona').value = chat.settings.myPersona; document.getElementById('my-avatar-group').style.display = 'block'; document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar); document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block'; document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block'; 
            updateLinkedWorldBooksDisplay();
            const bgPreview = document.getElementById('bg-preview'); const removeBgBtn = document.getElementById('remove-bg-btn'); if (chat.settings.background) { bgPreview.src = chat.settings.background; bgPreview.style.display = 'block'; removeBgBtn.style.display = 'inline-block'; } else { bgPreview.style.display = 'none'; removeBgBtn.style.display = 'none'; } if (isGroup) { document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || ''; document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar; renderGroupMemberSettings(chat.members); } else { document.getElementById('ai-persona').value = chat.settings.aiPersona; document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar; } document.getElementById('max-memory').value = chat.settings.maxMemory; 
            
            // è®¾ç½®æ˜¾ç¤ºæ¡æ•°æ»‘åŠ¨æ¡
            const visibleLimit = chat.settings.visibleMessageLimit !== undefined ? chat.settings.visibleMessageLimit : VISIBLE_MESSAGE_LIMIT;
            document.getElementById('visible-message-limit-slider').value = visibleLimit;
            document.getElementById('visible-message-limit-value').textContent = visibleLimit === 0 ? 'å…¨éƒ¨' : visibleLimit;
            
            const currentTheme = chat.settings.theme || 'default'; const themeRadio = document.querySelector(`input[name="theme-select"][value="${currentTheme}"]`); if (themeRadio) themeRadio.checked = true; chatSettingsModal.classList.add('visible'); });
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });
            document.getElementById('open-world-book-selector').addEventListener('click', openWorldBookSelectorModal);
            document.getElementById('close-world-book-selector').addEventListener('click', closeWorldBookSelectorModal);
            document.getElementById('cancel-world-book-selector').addEventListener('click', closeWorldBookSelectorModal);
            document.getElementById('confirm-world-book-selector').addEventListener('click', () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; chat.settings.linkedWorldBookIds = Array.from(tempSelectedWorldBooks); updateLinkedWorldBooksDisplay(); closeWorldBookSelectorModal(); });
            document.getElementById('wb-select-all-folders').addEventListener('click', () => { state.worldBooks.forEach(book => tempSelectedWorldBooks.add(book.id)); renderWorldBookSelectorContent(); });
            document.getElementById('wb-clear-all-selections').addEventListener('click', () => { tempSelectedWorldBooks.clear(); renderWorldBookSelectorContent(); });
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const newName = document.getElementById('chat-name-input').value.trim(); if (!newName) return alert('å¤‡æ³¨å/ç¾¤åä¸èƒ½ä¸ºç©ºï¼'); chat.name = newName; const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked'); chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default'; chat.settings.myPersona = document.getElementById('my-persona').value; chat.settings.myAvatar = document.getElementById('my-avatar-preview').src; if (chat.isGroup) { chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim(); chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src; } else { chat.settings.aiPersona = document.getElementById('ai-persona').value; chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src; } chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10; 
            chat.settings.visibleMessageLimit = parseInt(document.getElementById('visible-message-limit-slider').value);
            await db.chats.put(chat); chatSettingsModal.classList.remove('visible'); renderChatInterface(state.activeChatId); renderChatList(); });
            document.getElementById('download-chat-btn').addEventListener('click', downloadChatHistory);
            document.getElementById('upload-chat-btn').addEventListener('click', () => document.getElementById('chat-upload-input').click());
            document.getElementById('chat-upload-input').addEventListener('change', uploadChatHistory);
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('æ¸…ç©ºèŠå¤©è®°å½•', 'æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ­¤èŠå¤©çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œæ— æ³•æ¢å¤ã€‚ç¡®å®šè¦æ¸…ç©ºå—ï¼Ÿ', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("æ·»åŠ è¡¨æƒ…(URL)", "è¯·è¾“å…¥è¡¨æƒ…åŒ…çš„å›¾ç‰‡URL"); if (!url || !url.trim().startsWith('http')) return url && alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL (ä»¥httpå¼€å¤´)"); const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¼€å¿ƒã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; if (file.type === 'application/json' || file.name.endsWith('.json')) { try { const text = await file.text(); let cleanText = text.trim(); if (cleanText.endsWith(',]')) { cleanText = cleanText.replace(',]', ']'); } if (cleanText.endsWith(',}]')) { cleanText = cleanText.replace(',}]', '}]'); } const jsonData = JSON.parse(cleanText); if (!Array.isArray(jsonData)) { alert('JSONæ ¼å¼é”™è¯¯ï¼šåº”ä¸ºæ•°ç»„æ ¼å¼'); return; } let importCount = 0; for (const item of jsonData) { if (item.name && item.file) { const newSticker = { id: 'sticker_' + Date.now() + '_' + Math.random(), url: item.file, name: item.name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); importCount++; await new Promise(resolve => setTimeout(resolve, 10)); } } renderStickerPanel(); alert(`æˆåŠŸå¯¼å…¥ ${importCount} ä¸ªè¡¨æƒ…åŒ…ï¼`); } catch (error) { alert('JSONæ–‡ä»¶è§£æå¤±è´¥ï¼š' + error.message); } } else { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("å‘½åè¡¨æƒ…", "è¯·ä¸ºè¿™ä¸ªè¡¨æƒ…å‘½å (ä¾‹å¦‚ï¼šå¥½è€¶ã€ç–‘æƒ‘)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("è¡¨æƒ…åä¸èƒ½ä¸ºç©ºï¼"); }; } event.target.value = null; });
document.getElementById('sticker-select-all-btn').addEventListener('click', () => { const allStickerIds = state.userStickers.map(sticker => sticker.id); if (selectedStickers.size === allStickerIds.length) { selectedStickers.clear(); document.querySelectorAll('.sticker-item').forEach(item => { item.classList.remove('selected'); }); exitStickerSelectionMode(); } else { allStickerIds.forEach(stickerId => { selectedStickers.add(stickerId); const item = document.querySelector(`[data-sticker-id="${stickerId}"]`); if (item) item.classList.add('selected'); }); document.getElementById('sticker-selection-count').textContent = `å·²é€‰ ${selectedStickers.size} é¡¹`; } });
document.getElementById('sticker-selection-cancel-btn').addEventListener('click', exitStickerSelectionMode);
document.getElementById('sticker-selection-delete-btn').addEventListener('click', async () => { if (selectedStickers.size === 0) return; const confirmed = await showCustomConfirm('åˆ é™¤è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedStickers.size} ä¸ªè¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { for (const stickerId of selectedStickers) { await db.userStickers.delete(stickerId); state.userStickers = state.userStickers.filter(s => s.id !== stickerId); } exitStickerSelectionMode(); renderStickerPanel(); } });
document.getElementById('sticker-clear-all-btn').addEventListener('click', async () => { if (state.userStickers.length === 0) return; const confirmed = await showCustomConfirm('æ¸…ç©ºæ‰€æœ‰è¡¨æƒ…', `ç¡®å®šè¦åˆ é™¤å…¨éƒ¨ ${state.userStickers.length} ä¸ªè¡¨æƒ…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { for (const sticker of state.userStickers) { await db.userStickers.delete(sticker.id); } state.userStickers = []; exitStickerSelectionMode(); renderStickerPanel(); } });
            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("å‘é€è¯­éŸ³", "è¯·è¾“å…¥ä½ æƒ³è¯´çš„å†…å®¹ï¼š"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("å‘é€ç…§ç‰‡", "è¯·ç”¨æ–‡å­—æè¿°æ‚¨è¦å‘é€çš„ç…§ç‰‡ï¼š"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            // Persona Preset Event Listeners
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            // äººè®¾é¢„è®¾æ‰¹é‡é€‰æ‹©åŠŸèƒ½
            document.getElementById('persona-select-all-btn').addEventListener('click', () => {
                const allPresetIds = state.personaPresets.map(preset => preset.id);
                if (selectedPersonaPresets.size === allPresetIds.length) {
                    selectedPersonaPresets.clear();
                    document.querySelectorAll('.persona-preset-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    exitPersonaSelectionMode();
                } else {
                    allPresetIds.forEach(presetId => {
                        selectedPersonaPresets.add(presetId);
                        const item = document.querySelector(`[data-preset-id="${presetId}"]`);
                        if (item) item.classList.add('selected');
                    });
                    document.getElementById('persona-selection-count').textContent = `å·²é€‰ ${selectedPersonaPresets.size} é¡¹`;
                }
            });
            
            document.getElementById('persona-selection-cancel-btn').addEventListener('click', exitPersonaSelectionMode);
            
            document.getElementById('persona-selection-delete-btn').addEventListener('click', async () => {
                if (selectedPersonaPresets.size === 0) return;
                const confirmed = await showCustomConfirm('åˆ é™¤äººè®¾é¢„è®¾', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedPersonaPresets.size} ä¸ªäººè®¾é¢„è®¾å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    for (const presetId of selectedPersonaPresets) {
                        await db.personaPresets.delete(presetId);
                        state.personaPresets = state.personaPresets.filter(p => p.id !== presetId);
                    }
                    exitPersonaSelectionMode();
                    renderPersonaLibrary();
                }
            });
            
            // å¯¼å…¥äººè®¾JSONåŠŸèƒ½
            document.getElementById('import-persona-json-btn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);
                        await importPersonaFromJson(jsonData);
                    } catch (error) {
                        console.error('å¯¼å…¥äººè®¾JSONå¤±è´¥:', error);
                        alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
                    }
                });
                input.click();
            });

// ç¾¤æˆå‘˜å¯¼å…¥è§’è‰²å¡åŠŸèƒ½
document.getElementById('import-member-character-btn').addEventListener('click', () => {
const input = document.createElement('input');
input.type = 'file';
input.accept = '.png,.json';
input.addEventListener('change', async (e) => {
const file = e.target.files[0];
if (!file) return;
try {
if (file.type === 'application/json' || file.name.endsWith('.json')) {
await importMemberCharacterFromJson(file);
} else if (file.type === 'image/png' || file.name.endsWith('.png')) {
await importMemberCharacterFromPng(file);
} else {
alert('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼è¯·é€‰æ‹© .png æˆ– .json æ–‡ä»¶ã€‚');
}
} catch (error) {
console.error('å¯¼å…¥ç¾¤æˆå‘˜è§’è‰²å¡å¤±è´¥:', error);
alert('å¯¼å…¥å¤±è´¥ï¼š' + error.message);
}
});
input.click();
});

// å¤„ç†ç¾¤æˆå‘˜JSONæ ¼å¼è§’è‰²å¡
async function importMemberCharacterFromJson(file) {
const text = await file.text();
const cardData = JSON.parse(text);
let characterName, characterDesc, characterAvatar;
if (cardData.data) {
const data = cardData.data;
characterName = data.name || data.char_name || data.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = data.description || data.char_persona || data.personality || '';
characterAvatar = data.avatar || '';
} else {
characterName = cardData.name || cardData.char_name || cardData.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = cardData.description || cardData.char_persona || cardData.personality || '';
characterAvatar = cardData.avatar || '';
}
await applyCharacterToMember(characterName, characterDesc, characterAvatar);
}

// å¤„ç†ç¾¤æˆå‘˜PNGæ ¼å¼è§’è‰²å¡
async function importMemberCharacterFromPng(file) {
return new Promise((resolve, reject) => {
const reader = new FileReader();
reader.onload = async (e) => {
try {
const arrayBuffer = e.target.result;
const uint8Array = new Uint8Array(arrayBuffer);
const textChunks = extractAllTextChunksFromPng(uint8Array);
let characterData = null;
const possibleKeys = ['chara', 'ccv3', 'Character', 'character', 'UserData', 'Comment'];
for (const chunk of textChunks) {
if (possibleKeys.some(key => chunk.keyword.toLowerCase().includes(key.toLowerCase()))) {
try {
let jsonStr = '';
try {
jsonStr = safeBase64Decode(chunk.text);
} catch (e1) {
try {
const decoded = decodeURIComponent(chunk.text);
jsonStr = atob(decoded);
} catch (e2) {
jsonStr = chunk.text;
}
}
if (jsonStr) {
try {
characterData = JSON.parse(jsonStr);
break;
} catch (e) {
try {
const cleanJsonStr = jsonStr.replace(/^\uFEFF/, '').replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, '');
characterData = JSON.parse(cleanJsonStr);
break;
} catch (e3) {
console.warn(`è§£æå…³é”®å­— "${chunk.keyword}" çš„æ•°æ®å¤±è´¥:`, e3);
}
}
}
} catch (e) {
console.warn(`å¤„ç†å…³é”®å­— "${chunk.keyword}" å¤±è´¥:`, e);
}
}
}
if (!characterData) {
const fileName = file.name.replace(/\.(png|jpg|jpeg)$/i, '');
const avatarDataUrl = await fileToDataURL(file);
await applyCharacterToMember(fileName, 'ä»å›¾ç‰‡å¯¼å…¥çš„è§’è‰²ï¼Œè¯·æ‰‹åŠ¨è®¾ç½®è§’è‰²æè¿°ã€‚', avatarDataUrl);
resolve();
return;
}
let characterName, characterDesc, characterAvatar;
if (characterData.spec === 'chara_card_v3' || characterData.data) {
const data = characterData.data || characterData;
characterName = data.name || data.char_name || data.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = data.description || data.char_persona || data.personality || data.scenario || data.char_greeting || '';
characterAvatar = data.avatar || '';
} else {
characterName = characterData.name || characterData.char_name || characterData.character_name || 'æœªçŸ¥è§’è‰²';
characterDesc = characterData.description || characterData.char_persona || characterData.personality || characterData.scenario || characterData.char_greeting || '';
characterAvatar = characterData.avatar || '';
}
characterName = fixEncoding(characterName);
characterDesc = fixEncoding(characterDesc);
const avatarDataUrl = await fileToDataURL(file);
await applyCharacterToMember(characterName, characterDesc, avatarDataUrl);
resolve();
} catch (error) {
console.error('å¯¼å…¥PNGè§’è‰²å¡å¤±è´¥:', error);
reject(error);
}
};
reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
reader.readAsArrayBuffer(file);
});
}

// å°†è§’è‰²å¡æ•°æ®åº”ç”¨åˆ°å½“å‰ç¼–è¾‘çš„ç¾¤æˆå‘˜
async function applyCharacterToMember(characterName, description, avatar) {
if (!editingMemberId) {
alert('å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„ç¾¤æˆå‘˜');
return;
}
document.getElementById('member-name-input').value = characterName;
document.getElementById('member-persona-input').value = description || 'ä¸€ä¸ªæœ‰è¶£çš„è§’è‰²ã€‚';
if (avatar) {
document.getElementById('member-avatar-preview').src = avatar;
}
alert(`æˆåŠŸå¯¼å…¥è§’è‰²å¡ï¼š"${characterName}"`);
}

// å¯¼å‡ºç¾¤æˆå‘˜è§’è‰²å¡
document.getElementById('export-member-character-btn').addEventListener('click', () => {
if (!editingMemberId) {
alert('å½“å‰æ²¡æœ‰æ­£åœ¨ç¼–è¾‘çš„ç¾¤æˆå‘˜');
return;
}
const memberName = document.getElementById('member-name-input').value.trim() || 'æœªçŸ¥è§’è‰²';
const memberPersona = document.getElementById('member-persona-input').value.trim() || '';
const memberAvatar = document.getElementById('member-avatar-preview').src || '';
exportCharacterCard(memberName, memberPersona, memberAvatar, 'member');
});

// å¯¼å‡ºAI/å¯¹æ–¹è§’è‰²å¡
document.getElementById('export-ai-character-btn').addEventListener('click', () => {
if (!state.activeChatId) return;
const chat = state.chats[state.activeChatId];
if (chat.isGroup) {
alert('ç¾¤èŠæ¨¡å¼ä¸‹è¯·ä½¿ç”¨ç¾¤æˆå‘˜ç¼–è¾‘ä¸­çš„å¯¼å‡ºåŠŸèƒ½');
return;
}
const aiName = chat.name || 'å¯¹æ–¹';
const aiPersona = document.getElementById('ai-persona').value.trim() || '';
const aiAvatar = document.getElementById('ai-avatar-preview').src || '';
exportCharacterCard(aiName, aiPersona, aiAvatar, 'ai');
});

// å¯¼å‡ºè§’è‰²å¡å‡½æ•°
function exportCharacterCard(characterName, description, avatar, type) {
const characterCard = {
spec: 'chara_card_v2',
spec_version: '2.0',
data: {
name: characterName,
description: description,
personality: description,
char_persona: description,
char_name: characterName,
avatar: avatar
}
};
const jsonStr = JSON.stringify(characterCard, null, 2);
const blob = new Blob([jsonStr], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
const currentTime = new Date().toLocaleString('zh-CN').replace(/[\/\s:]/g, '-');
a.download = `${characterName}_è§’è‰²å¡_${currentTime}.json`;
a.click();
URL.revokeObjectURL(url);
alert(`è§’è‰²å¡å·²å¯¼å‡ºä¸º ${characterName}_è§’è‰²å¡_${currentTime}.json`);
}

// å¤´åƒç¼–è¾‘å™¨ç›¸å…³å˜é‡
let avatarEditorState = {
image: null,
scale: 1,
offsetX: 0,
offsetY: 0,
isDragging: false,
startX: 0,
startY: 0,
targetElement: null,
callback: null
};

// æ‰“å¼€å¤´åƒé€‰æ‹©å™¨
function openAvatarSelector(targetElement, callback) {
avatarEditorState.targetElement = targetElement;
avatarEditorState.callback = callback;
document.getElementById('avatar-file-input').click();
}

// æ‰“å¼€å¤´åƒç¼–è¾‘å™¨
function openAvatarEditor(imageDataUrl) {
const modal = document.getElementById('avatar-editor-modal');
const cropImage = document.getElementById('avatar-crop-image');
const scaleSlider = document.getElementById('avatar-scale-slider');
avatarEditorState.image = new Image();
avatarEditorState.image.onload = function() {
const cropArea = document.getElementById('avatar-crop-area');
const maxSize = Math.min(cropArea.offsetWidth, cropArea.offsetHeight);
const imgAspect = this.naturalWidth / this.naturalHeight;
let imgWidth, imgHeight;
if (imgAspect > 1) {
imgWidth = maxSize;
imgHeight = maxSize / imgAspect;
} else {
imgWidth = maxSize * imgAspect;
imgHeight = maxSize;
}
cropImage.style.width = imgWidth + 'px';
cropImage.style.height = imgHeight + 'px';
avatarEditorState.offsetX = (maxSize - imgWidth) / 2;
avatarEditorState.offsetY = (maxSize - imgHeight) / 2;
updateImagePosition();
};
avatarEditorState.image.src = imageDataUrl;
cropImage.src = imageDataUrl;
avatarEditorState.scale = 1;
scaleSlider.value = 1;
modal.classList.add('visible');
}

// æ›´æ–°å›¾ç‰‡ä½ç½®
function updateImagePosition() {
const cropImage = document.getElementById('avatar-crop-image');
const transform = `translate(${avatarEditorState.offsetX}px, ${avatarEditorState.offsetY}px) scale(${avatarEditorState.scale})`;
cropImage.style.transform = transform;
}

// ä¿å­˜è£å‰ªåçš„å¤´åƒ
function saveCroppedAvatar() {
const cropArea = document.getElementById('avatar-crop-area');
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
const size = 200;
canvas.width = size;
canvas.height = size;
const img = avatarEditorState.image;
const scale = avatarEditorState.scale;
const offsetX = avatarEditorState.offsetX;
const offsetY = avatarEditorState.offsetY;
const cropSize = 200;
const displayW = parseFloat(document.getElementById('avatar-crop-image').style.width);
const displayH = parseFloat(document.getElementById('avatar-crop-image').style.height);
const naturalW = img.naturalWidth;
const naturalH = img.naturalHeight;
const centerOffsetX = (displayW * (scale - 1)) / 2;
const centerOffsetY = (displayH * (scale - 1)) / 2;
const fixedX = offsetX - centerOffsetX;
const fixedY = offsetY - centerOffsetY;
const srcX = (-fixedX / displayW) * naturalW / scale;
const srcY = (-fixedY / displayH) * naturalH / scale;
const srcW = (cropSize / displayW) * naturalW / scale;
const srcH = (cropSize / displayH) * naturalH / scale;
ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, cropSize, cropSize);
const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.9);
if (avatarEditorState.targetElement) {
avatarEditorState.targetElement.src = croppedDataUrl;
}
if (avatarEditorState.callback) {
avatarEditorState.callback(croppedDataUrl);
}
document.getElementById('avatar-editor-modal').classList.remove('visible');
}

// åˆå§‹åŒ–å¤´åƒç¼–è¾‘å™¨äº‹ä»¶
function initAvatarEditor() {
const fileInput = document.getElementById('avatar-file-input');
const modal = document.getElementById('avatar-editor-modal');
const cropImage = document.getElementById('avatar-crop-image');
const scaleSlider = document.getElementById('avatar-scale-slider');
const saveBtn = document.getElementById('avatar-editor-save');
const cancelBtn = document.getElementById('avatar-editor-cancel');
const closeBtn = document.getElementById('close-avatar-editor');
fileInput.addEventListener('change', (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (e) => openAvatarEditor(e.target.result);
reader.readAsDataURL(file);
}
e.target.value = '';
});
scaleSlider.addEventListener('input', (e) => {
avatarEditorState.scale = parseFloat(e.target.value);
updateImagePosition();
});
let startX, startY, startOffsetX, startOffsetY;
cropImage.addEventListener('mousedown', (e) => {
avatarEditorState.isDragging = true;
startX = e.clientX;
startY = e.clientY;
startOffsetX = avatarEditorState.offsetX;
startOffsetY = avatarEditorState.offsetY;
e.preventDefault();
});
cropImage.addEventListener('touchstart', (e) => {
avatarEditorState.isDragging = true;
const touch = e.touches[0];
startX = touch.clientX;
startY = touch.clientY;
startOffsetX = avatarEditorState.offsetX;
startOffsetY = avatarEditorState.offsetY;
e.preventDefault();
});
document.addEventListener('mousemove', (e) => {
if (avatarEditorState.isDragging) {
avatarEditorState.offsetX = startOffsetX + (e.clientX - startX);
avatarEditorState.offsetY = startOffsetY + (e.clientY - startY);
updateImagePosition();
}
});
document.addEventListener('touchmove', (e) => {
if (avatarEditorState.isDragging) {
const touch = e.touches[0];
avatarEditorState.offsetX = startOffsetX + (touch.clientX - startX);
avatarEditorState.offsetY = startOffsetY + (touch.clientY - startY);
updateImagePosition();
e.preventDefault();
}
});
document.addEventListener('mouseup', () => {
avatarEditorState.isDragging = false;
});
document.addEventListener('touchend', () => {
avatarEditorState.isDragging = false;
});
saveBtn.addEventListener('click', saveCroppedAvatar);
cancelBtn.addEventListener('click', () => modal.classList.remove('visible'));
closeBtn.addEventListener('click', () => modal.classList.remove('visible'));
}

// ä¸ºæ‰€æœ‰å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
function makeAvatarsClickable() {
document.querySelectorAll('.avatar-upload img, .persona-preset-item').forEach(img => {
if (!img.classList.contains('avatar-clickable')) {
img.classList.add('avatar-clickable');
img.addEventListener('click', (e) => {
e.stopPropagation();
openAvatarSelector(img, (dataUrl) => {
if (img.classList.contains('persona-preset-item')) {
document.getElementById('preset-avatar-preview').src = dataUrl;
} else {
img.src = dataUrl;
}
});
});
}
});
}


            // Selection Event Listeners
document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('åˆ é™¤æ¶ˆæ¯', `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });

// åˆå§‹åŒ–å¤´åƒç¼–è¾‘å™¨
initAvatarEditor();

// é¡µé¢åŠ è½½å®Œæˆåä¸ºæ‰€æœ‰å¤´åƒæ·»åŠ ç‚¹å‡»äº‹ä»¶
setTimeout(() => {
makeAvatarsClickable();
}, 1000);

// ç›‘å¬DOMå˜åŒ–ï¼Œä¸ºæ–°æ·»åŠ çš„å¤´åƒå…ƒç´ æ·»åŠ ç‚¹å‡»äº‹ä»¶
const observer = new MutationObserver(() => {
makeAvatarsClickable();
});
observer.observe(document.body, { childList: true, subtree: true });

        // --- å¤´åƒæ¡†åŠŸèƒ½ç›¸å…³ä»£ç  (è¿™æ˜¯æ–°æ·»åŠ çš„) ---
        const frameModal = document.getElementById('avatar-frame-modal');
        const aiFrameTab = document.getElementById('ai-frame-tab');
        const myFrameTab = document.getElementById('my-frame-tab');
        const aiFrameContent = document.getElementById('ai-frame-content');
        const myFrameContent = document.getElementById('my-frame-content');
        const aiFrameGrid = document.getElementById('ai-frame-grid');
        const myFrameGrid = document.getElementById('my-frame-grid');

        function openFrameSelectorModal(type = 'chat') {
        if (!state.activeChatId) return;
        const chat = state.chats[state.activeChatId];
        editingFrameForMember = (type === 'member'); // æ ‡è®°å½“å‰æ˜¯ä¸ºæˆå‘˜ç¼–è¾‘

        if (editingFrameForMember) {
            // ä¸ºç‰¹å®šæˆå‘˜æ‰“å¼€
            const member = chat.members.find(m => m.id === editingMemberId);
            if (!member) return;
            currentFrameSelection.my = member.avatarFrame || ''; // å€Ÿç”¨ my æ¥ä¸´æ—¶å­˜å‚¨
            populateFrameGrids(true, member.avatar, member.avatarFrame);
        } else {
            // ä¸ºæ•´ä¸ªèŠå¤©ï¼ˆæˆ‘/AIï¼‰æ‰“å¼€
            currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
            currentFrameSelection.my = chat.settings.myAvatarFrame || '';
            populateFrameGrids(false);
        }
        
        frameModal.classList.add('visible');
    }
        
        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
    const chat = state.chats[state.activeChatId];
    aiFrameGrid.innerHTML = '';
    myFrameGrid.innerHTML = '';

    // æ§åˆ¶Tabçš„æ˜¾ç¤º/éšè—
    document.querySelector('.frame-tabs').style.display = isForMember ? 'none' : 'flex';
    aiFrameContent.style.display = 'block';
    myFrameContent.style.display = 'none';
    aiFrameTab.classList.add('active');
    myFrameTab.classList.remove('active');

    if (isForMember) {
        // åªå¡«å……ä¸€ä¸ªGrid
        avatarFrames.forEach(frame => {
            const item = createFrameItem(frame, 'my', memberAvatar); // å¤ç”¨'my'çš„é€»è¾‘
            if (frame.url === memberFrame) {
                item.classList.add('selected');
            }
            aiFrameGrid.appendChild(item); // ç»Ÿä¸€éƒ½æ”¾åœ¨ç¬¬ä¸€ä¸ªGridé‡Œ
        });
    } else {
        // å¡«å……ä¸¤ä¸ªGrid (åŸæ¥çš„é€»è¾‘)
        const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
        const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);

        avatarFrames.forEach(frame => {
            const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
            if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
            aiFrameGrid.appendChild(aiItem);

            const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
            if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
            myFrameGrid.appendChild(myItem);
        });
    }
}

        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            
            // æ·»åŠ é¢„è§ˆæ•ˆæœ
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;

            item.addEventListener('click', () => {
                // æ›´æ–°ä¸´æ—¶é€‰æ‹©
                currentFrameSelection[type] = frame.url;
                
                // æ›´æ–°UI
                const grid = type === 'ai' ? aiFrameGrid : myFrameGrid;
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }
        
        async function saveSelectedFrames() {
        if (!state.activeChatId) return;
        const chat = state.chats[state.activeChatId];
        
        if (editingFrameForMember) {
            // ä¿å­˜åˆ°ç‰¹å®šæˆå‘˜
            const member = chat.members.find(m => m.id === editingMemberId);
            if (member) {
                member.avatarFrame = currentFrameSelection.my; // å–å‡ºå­˜åœ¨ my çš„å€¼
            }
        } else {
            // ä¿å­˜åˆ°èŠå¤©è®¾ç½®
            chat.settings.aiAvatarFrame = currentFrameSelection.ai;
            chat.settings.myAvatarFrame = currentFrameSelection.my;
        }

        await db.chats.put(chat);
        frameModal.classList.remove('visible');
        renderChatInterface(state.activeChatId);
        alert('å¤´åƒæ¡†å·²ä¿å­˜ï¼');
        editingFrameForMember = false; // é‡ç½®æ ‡è®°
        }
        
        // ä¸ºèŠå¤©è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('chat'); // æ ‡è®°ä¸ºç»™æ•´ä¸ªèŠå¤©è®¾ç½®
    }
});

// ä¸ºæˆå‘˜è®¾ç½®é‡Œçš„â€œæ›´æ¢å¤´åƒæ¡†â€æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ (æ–°å¢)
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        openFrameSelectorModal('member'); // æ ‡è®°ä¸ºç»™å•ä¸ªæˆå‘˜è®¾ç½®
    }
});

        // å¤´åƒæ¡†çª—å£çš„Tabåˆ‡æ¢
        aiFrameTab.addEventListener('click', () => {
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
        });
        myFrameTab.addEventListener('click', () => {
            myFrameTab.classList.add('active');
            aiFrameTab.classList.remove('active');
            myFrameContent.style.display = 'block';
            aiFrameContent.style.display = 'none';
        });
        
        // å¤´åƒæ¡†çª—å£çš„ä¿å­˜å’Œå–æ¶ˆæŒ‰é’®
        document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
        document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
            frameModal.classList.remove('visible');
        });
        // --- å¤´åƒæ¡†åŠŸèƒ½ä»£ç ç»“æŸ ---

        // === æ–°å¢ï¼šå­—ä½“è®¾ç½®é¡µé¢çš„äº‹ä»¶ç›‘å¬å™¨ ===
        const fontUrlInput = document.getElementById('font-url-input');
        
        // å®æ—¶é¢„è§ˆ
        fontUrlInput.addEventListener('input', () => {
            applyCustomFont(fontUrlInput.value.trim(), true);
        });
        
        // ä¿å­˜æŒ‰é’®
        document.getElementById('save-font-btn').addEventListener('click', async () => {
            const newFontUrl = fontUrlInput.value.trim();
            if (!newFontUrl) {
                alert("è¯·è¾“å…¥æœ‰æ•ˆçš„å­—ä½“URLã€‚");
                return;
            }
            applyCustomFont(newFontUrl, false);
            state.globalSettings.fontUrl = newFontUrl;
            await db.globalSettings.put(state.globalSettings);
            alert('å­—ä½“å·²ä¿å­˜å¹¶åº”ç”¨ï¼');
        });

        // æ¢å¤é»˜è®¤æŒ‰é’®
        document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

        // ä¸–ç•Œä¹¦é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
            let tempSelectedWorldBooks = new Set();
            function openWorldBookSelectorModal() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            tempSelectedWorldBooks = new Set(chat.settings.linkedWorldBookIds || []);
            renderWorldBookSelectorContent();
            document.getElementById('world-book-selector-modal').classList.add('visible');
            }
            function closeWorldBookSelectorModal() {
            document.getElementById('world-book-selector-modal').classList.remove('visible');
            tempSelectedWorldBooks.clear();
            }
            function renderWorldBookSelectorContent() {
            const folderList = document.getElementById('world-book-folder-list');
            folderList.innerHTML = '';
            updateWorldBookSelectionSummary();
            if (state.worldBooks.length === 0 && state.worldBookFolders.length === 0) { folderList.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin: 20px;">è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•ä¸–ç•Œä¹¦</p>'; return; }
            state.worldBookFolders.forEach(folder => {
            const folderEl = document.createElement('div'); folderEl.className = 'wb-folder-item'; folderEl.dataset.folderId = folder.id;
            const booksInFolder = state.worldBooks.filter(book => book.folderId === folder.id); const allBooksSelected = booksInFolder.length > 0 && booksInFolder.every(book => tempSelectedWorldBooks.has(book.id)); const someBooksSelected = booksInFolder.some(book => tempSelectedWorldBooks.has(book.id));
            const folderHeader = document.createElement('div'); folderHeader.className = `wb-folder-header ${allBooksSelected ? 'selected' : ''}`; folderHeader.innerHTML = `<div><input type="checkbox" class="wb-folder-checkbox" ${allBooksSelected ? 'checked' : ''} ${someBooksSelected && !allBooksSelected ? 'indeterminate' : ''}><span>${folder.name} (${booksInFolder.length})</span></div><span class="wb-folder-toggle">â–¼</span>`;
            const checkbox = folderHeader.querySelector('.wb-folder-checkbox'); if (someBooksSelected && !allBooksSelected) checkbox.indeterminate = true;
            checkbox.addEventListener('change', (e) => { e.stopPropagation(); if (e.target.checked) { booksInFolder.forEach(book => tempSelectedWorldBooks.add(book.id)); } else { booksInFolder.forEach(book => tempSelectedWorldBooks.delete(book.id)); } renderWorldBookSelectorContent(); });
            folderHeader.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') { folderEl.classList.toggle('collapsed'); } });
            const bookList = document.createElement('div'); bookList.className = 'wb-book-list'; booksInFolder.forEach(book => { const bookEl = document.createElement('div'); bookEl.className = `wb-book-item ${tempSelectedWorldBooks.has(book.id) ? 'selected' : ''}`; bookEl.innerHTML = `<input type="checkbox" class="wb-book-checkbox" ${tempSelectedWorldBooks.has(book.id) ? 'checked' : ''}><span class="wb-book-name">${book.name}</span><span class="wb-book-preview">${(book.content || '').substring(0, 20)}...</span>`;
            const bookCheckbox = bookEl.querySelector('.wb-book-checkbox'); bookCheckbox.addEventListener('change', (e) => { e.stopPropagation(); if (e.target.checked) { tempSelectedWorldBooks.add(book.id); } else { tempSelectedWorldBooks.delete(book.id); } renderWorldBookSelectorContent(); }); bookEl.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') { bookCheckbox.checked = !bookCheckbox.checked; bookCheckbox.dispatchEvent(new Event('change')); } }); bookList.appendChild(bookEl); });
            if (booksInFolder.length === 0) { bookList.innerHTML = '<p style="text-align:center; color: #8a8a8a; padding: 10px;">æ–‡ä»¶å¤¹ä¸ºç©º</p>'; }
            folderEl.appendChild(folderHeader); folderEl.appendChild(bookList); folderList.appendChild(folderEl);
            });
            const ungroupedBooks = state.worldBooks.filter(book => !book.folderId); if (ungroupedBooks.length > 0) { const ungroupedEl = document.createElement('div'); ungroupedEl.className = 'wb-folder-item'; const ungroupedHeader = document.createElement('div'); ungroupedHeader.className = 'wb-folder-header'; ungroupedHeader.innerHTML = '<div><span>æœªåˆ†ç»„ ('+ungroupedBooks.length+')</span></div><span class="wb-folder-toggle">â–¼</span>'; ungroupedHeader.addEventListener('click', () => ungroupedEl.classList.toggle('collapsed'));
            const ungroupedList = document.createElement('div'); ungroupedList.className = 'wb-book-list'; ungroupedBooks.forEach(book => { const bookEl = document.createElement('div'); bookEl.className = `wb-book-item ${tempSelectedWorldBooks.has(book.id) ? 'selected' : ''}`; bookEl.innerHTML = `<input type="checkbox" class="wb-book-checkbox" ${tempSelectedWorldBooks.has(book.id) ? 'checked' : ''}><span class="wb-book-name">${book.name}</span><span class="wb-book-preview">${(book.content || '').substring(0, 20)}...</span>`;
            const bookCheckbox = bookEl.querySelector('.wb-book-checkbox'); bookCheckbox.addEventListener('change', (e) => { e.stopPropagation(); if (e.target.checked) { tempSelectedWorldBooks.add(book.id); } else { tempSelectedWorldBooks.delete(book.id); } renderWorldBookSelectorContent(); }); bookEl.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') { bookCheckbox.checked = !bookCheckbox.checked; bookCheckbox.dispatchEvent(new Event('change')); } }); ungroupedList.appendChild(bookEl); });
            ungroupedEl.appendChild(ungroupedHeader); ungroupedEl.appendChild(ungroupedList); folderList.appendChild(ungroupedEl); }
            }
            function updateWorldBookSelectionSummary() {
            const count = tempSelectedWorldBooks.size; document.getElementById('wb-selection-summary').textContent = `å·²é€‰æ‹© ${count} æœ¬ä¸–ç•Œä¹¦`;
            }
            function updateLinkedWorldBooksDisplay() {
            if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const linkedIds = chat.settings.linkedWorldBookIds || []; const display = document.getElementById('linked-world-books-display');
            if (linkedIds.length === 0) { display.textContent = 'æœªé€‰æ‹©ä»»ä½•ä¸–ç•Œä¹¦'; return; }
            const linkedBooks = state.worldBooks.filter(book => linkedIds.includes(book.id)); if (linkedBooks.length <= 3) { display.textContent = linkedBooks.map(book => book.name).join(', '); } else { display.textContent = `${linkedBooks.slice(0, 3).map(book => book.name).join(', ')} ç­‰ ${linkedBooks.length} æœ¬`; }
            }

            // éŸ³ä¹æœç´¢ç›¸å…³äº‹ä»¶ç›‘å¬å™¨
            function openMusicSearchModal() {
            document.getElementById('music-search-modal').classList.add('visible');
            document.getElementById('music-search-input').focus();
        }
        
        function closeMusicSearchModal() {
            document.getElementById('music-search-modal').classList.remove('visible');
            document.getElementById('music-search-input').value = '';
            document.getElementById('music-search-results').innerHTML = '';
        }
        
        document.getElementById('close-music-search-modal').addEventListener('click', closeMusicSearchModal);
        
        document.getElementById('search-music-btn-modal').addEventListener('click', searchMusic);
        
        document.getElementById('music-search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMusic();
            }
        });
        
        // æœç´¢éŸ³ä¹å‡½æ•°
        async function searchMusic() {
            const searchTerm = document.getElementById('music-search-input').value.trim();
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            const resultsContainer = document.getElementById('music-search-results');
            resultsContainer.innerHTML = '<div class="search-loading">æœç´¢ä¸­...</div>';
            
            try {
                // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªæ¨¡æ‹Ÿçš„éŸ³ä¹æœç´¢API
                // å®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢ä¸ºçœŸå®çš„éŸ³ä¹æœç´¢API
                const searchResults = await searchMusicFromAPI(searchTerm);
                
                if (searchResults && searchResults.length > 0) {
                    renderMusicSearchResults(searchResults);
                } else {
                    resultsContainer.innerHTML = '<div class="search-no-results">æœªæ‰¾åˆ°ç›¸å…³æ­Œæ›²</div>';
                }
            } catch (error) {
                console.error('æœç´¢éŸ³ä¹å¤±è´¥:', error);
                resultsContainer.innerHTML = '<div class="search-no-results">æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }
        
        // HTTPè¯·æ±‚å‡½æ•°
        async function Http_Get(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('HTTPè¯·æ±‚å¤±è´¥:', error);
                return null;
            }
        }

        // çœŸå®çš„éŸ³ä¹æœç´¢API
        async function searchMusicFromAPI(searchTerm) {
            const results = [];
            
            try {
                // æœç´¢ç½‘æ˜“äº‘éŸ³ä¹
                const neteaseResults = await searchNetEaseMusic(searchTerm);
                if (neteaseResults) {
                    results.push(...neteaseResults);
                }
            } catch (error) {
                console.error('ç½‘æ˜“äº‘æœç´¢å¤±è´¥:', error);
            }
            
            try {
                // æœç´¢QQéŸ³ä¹
                const qqResults = await searchQQMusic(searchTerm);
                if (qqResults) {
                    results.push(...qqResults);
                }
            } catch (error) {
                console.error('QQéŸ³ä¹æœç´¢å¤±è´¥:', error);
            }
            
            // å»é‡å¹¶è¿”å›ç»“æœ
            const uniqueResults = [];
            const seen = new Set();
            
            for (const result of results) {
                const key = `${result.name}-${result.artist}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueResults.push(result);
                }
            }
            
            return uniqueResults.slice(0, 10); // é™åˆ¶è¿”å›10ä¸ªç»“æœ
        }

        // è·å–éŸ³ä¹æ’­æ”¾é“¾æ¥
        async function getMusicPlayUrl(songId, source) {
            try {
                let apiUrl;
                if (source === 'netease') {
                    apiUrl = `https://api.vkeys.cn/v2/music/netease?id=${songId}`;
                } else if (source === 'tencent') {
                    apiUrl = `https://api.vkeys.cn/v2/music/tencent?id=${songId}`;
                } else {
                    throw new Error('æœªçŸ¥çš„éŸ³æºç±»å‹');
                }
                
                const response = await Http_Get(apiUrl);
                
                if (!response || !response.data || !response.data.url) {
                    throw new Error('APIè¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰æ’­æ”¾é“¾æ¥');
                }
                
                return response.data.url;
                
            } catch (error) {
                console.error(`è·å–${source}æ’­æ”¾é“¾æ¥å¤±è´¥:`, error);
                throw error;
            }
        }

        // æ£€æŸ¥éŸ³é¢‘é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
        async function checkMusicAvailability(url) {
            return new Promise((resolve) => {
                const audio = new Audio();
                const timeout = setTimeout(() => {
                    audio.src = '';
                    resolve(false);
                }, 5000); // 5ç§’è¶…æ—¶
                
                audio.addEventListener('loadedmetadata', () => {
                    clearTimeout(timeout);
                    audio.src = '';
                    resolve(true);
                });
                
                audio.addEventListener('error', () => {
                    clearTimeout(timeout);
                    audio.src = '';
                    resolve(false);
                });
                
                audio.preload = 'metadata';
                audio.src = url;
            });
        }
        
        // æœç´¢ç½‘æ˜“äº‘éŸ³ä¹
        async function searchNetEaseMusic(searchTerm) {
            try {
                const url = `https://api.vkeys.cn/v2/music/netease?word=${encodeURIComponent(searchTerm)}`;
                const response = await Http_Get(url);
                
                if (!response || !response.data || !Array.isArray(response.data)) {
                    return [];
                }
                
                return response.data.map(item => ({
                    id: item.id,
                    name: item.song || item.name || 'æœªçŸ¥æ­Œæ›²',
                    artist: item.singer || item.artist || 'æœªçŸ¥æ­Œæ‰‹',
                    album: item.album || 'æœªçŸ¥ä¸“è¾‘',
                    duration: formatDuration(item.time || item.duration),
                    source: 'netease',
                    cover: item.cover || ''
                }));
            } catch (error) {
                console.error('ç½‘æ˜“äº‘æœç´¢APIè°ƒç”¨å¤±è´¥:', error);
                return [];
            }
        }
        
        // æœç´¢QQéŸ³ä¹
        async function searchQQMusic(searchTerm) {
            try {
                const url = `https://api.vkeys.cn/v2/music/tencent?word=${encodeURIComponent(searchTerm)}`;
                const response = await Http_Get(url);
                
                if (!response || !response.data || !Array.isArray(response.data)) {
                    return [];
                }
                
                const results = [];
                
                for (const item of response.data) {
                    // å¤„ç†ä¸»æ­Œæ›²
                    if (item.id && item.song && !String(item.song).match(/live/gi)) {
                        results.push({
                            id: item.id,
                            name: item.song || 'æœªçŸ¥æ­Œæ›²',
                            artist: item.singer || 'æœªçŸ¥æ­Œæ‰‹',
                            album: item.album || 'æœªçŸ¥ä¸“è¾‘',
                            duration: formatDuration(item.time || item.duration),
                            source: 'tencent',
                            cover: item.cover || ''
                        });
                    }
                    
                    // å¤„ç†åˆ†ç»„æ­Œæ›²
                    if (item.grp && Array.isArray(item.grp)) {
                        for (const grpItem of item.grp) {
                            if (grpItem.id && grpItem.song && !String(grpItem.song).match(/live/gi)) {
                                results.push({
                                    id: grpItem.id,
                                    name: grpItem.song || 'æœªçŸ¥æ­Œæ›²',
                                    artist: grpItem.singer || 'æœªçŸ¥æ­Œæ‰‹',
                                    album: grpItem.album || 'æœªçŸ¥ä¸“è¾‘',
                                    duration: formatDuration(grpItem.time || grpItem.duration),
                                    source: 'tencent',
                                    cover: grpItem.cover || ''
                                });
                            }
                        }
                    }
                }
                
                return results;
            } catch (error) {
                console.error('QQéŸ³ä¹æœç´¢APIè°ƒç”¨å¤±è´¥:', error);
                return [];
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é•¿
        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return 'æœªçŸ¥';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        async function playTrack(index) {
            if (index < 0 || index >= musicState.playlist.length) return;
            
            musicState.currentIndex = index;
            const track = musicState.playlist[index];
            
            updatePlayerUI();
            
            if (musicState.audio) {
                musicState.audio.pause();
                musicState.audio.currentTime = 0;
            }
            
            let audioSrc = track.src;
            
            // å¦‚æœæ˜¯åœ¨çº¿éŸ³ä¹ä¸”æ²¡æœ‰æ’­æ”¾é“¾æ¥ï¼Œéœ€è¦è·å–
            if (!track.isLocal && (!audioSrc || audioSrc === '')) {
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    document.getElementById('current-track').textContent = 'æ­£åœ¨è·å–æ’­æ”¾é“¾æ¥...';
                    
                    audioSrc = await getMusicPlayUrl(track.id, track.source);
                    
                    if (!audioSrc) {
                        throw new Error('æ— æ³•è·å–æ’­æ”¾é“¾æ¥');
                    }
                    
                    // æ›´æ–°æ’­æ”¾åˆ—è¡¨ä¸­çš„é“¾æ¥
                    musicState.playlist[index].src = audioSrc;
                    await saveGlobalPlaylist();
                    
                } catch (error) {
                    console.error('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥:', error);
                    alert(`è·å–æ’­æ”¾é“¾æ¥å¤±è´¥: ${error.message}`);
                    return;
                }
            }
            
            musicState.audio = new Audio(audioSrc);
            musicState.audio.volume = musicState.volume;
            
            musicState.audio.addEventListener('loadedmetadata', () => {
                updateProgressBar();
            });
            
            musicState.audio.addEventListener('timeupdate', updateProgressBar);
            musicState.audio.addEventListener('ended', () => {
                if (musicState.currentIndex < musicState.playlist.length - 1) {
                    playTrack(musicState.currentIndex + 1);
                } else {
                    musicState.isPlaying = false;
                    updatePlayerUI();
                }
            });
            
            musicState.audio.addEventListener('error', (e) => {
                console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
                alert('æ’­æ”¾å¤±è´¥ï¼ŒéŸ³é¢‘æ–‡ä»¶å¯èƒ½å·²å¤±æ•ˆ');
                musicState.isPlaying = false;
                updatePlayerUI();
            });
            
            try {
                await musicState.audio.play();
                musicState.isPlaying = true;
                updatePlayerUI();
            } catch (error) {
                console.error('æ’­æ”¾å¤±è´¥:', error);
                alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ');
                musicState.isPlaying = false;
                updatePlayerUI();
            }
        }
        
        // æ¸²æŸ“æœç´¢ç»“æœ
        function renderMusicSearchResults(results) {
            const resultsContainer = document.getElementById('music-search-results');
            resultsContainer.innerHTML = '';
            
            results.forEach((song, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'music-search-result-item';
                resultItem.style.display = 'flex';
                resultItem.style.alignItems = 'center';
                resultItem.style.gap = '12px';
                
                // æ·»åŠ å°é¢é¢„è§ˆ
                const coverDiv = document.createElement('div');
                coverDiv.className = 'music-result-cover';
                coverDiv.style.flexShrink = '0';
                if (song.cover) {
                    coverDiv.innerHTML = `<img src="${song.cover}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;">`;
                } else {
                    coverDiv.innerHTML = '<div style="width: 50px; height: 50px; background: #ddd; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #888; font-size: 12px;">â™ª</div>';
                }
                
                const infoDiv = document.createElement('div');
                infoDiv.style.flex = '1';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'music-result-title';
                titleDiv.textContent = song.name;
                
                const artistDiv = document.createElement('div');
                artistDiv.className = 'music-result-artist';
                artistDiv.textContent = `${song.artist} - ${song.album} (${song.duration})`;
                
                const sourceDiv = document.createElement('div');
                sourceDiv.className = 'music-result-source';
                sourceDiv.style.fontSize = '12px';
                sourceDiv.style.color = '#666';
                sourceDiv.style.marginBottom = '8px';
                sourceDiv.textContent = `æ¥æº: ${song.source === 'netease' ? 'ç½‘æ˜“äº‘éŸ³ä¹' : 'QQéŸ³ä¹'}`;
                
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'music-result-actions';
                
                const addButton = document.createElement('button');
                addButton.className = 'music-result-btn primary';
                addButton.textContent = 'æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨';
                
                addButton.addEventListener('click', () => {
                    addMusicToPlaylist(song.id, song.name, song.artist, song.source, song.cover);
                });
                
                actionsDiv.appendChild(addButton);
                
                infoDiv.appendChild(titleDiv);
                infoDiv.appendChild(artistDiv);
                infoDiv.appendChild(sourceDiv);
                infoDiv.appendChild(actionsDiv);
                
                resultItem.appendChild(coverDiv);
                resultItem.appendChild(infoDiv);
                
                resultsContainer.appendChild(resultItem);
            });
        }
        
        // è·å–éŸ³ä¹æ’­æ”¾é“¾æ¥
        async function getMusicPlayUrl(songId, source) {
            try {
                let apiUrl;
                if (source === 'netease') {
                    apiUrl = `https://api.vkeys.cn/v2/music/netease?id=${songId}`;
                } else if (source === 'tencent') {
                    apiUrl = `https://api.vkeys.cn/v2/music/tencent?id=${songId}`;
                } else {
                    throw new Error('æœªçŸ¥çš„éŸ³æºç±»å‹');
                }
                
                const response = await Http_Get(apiUrl);
                
                if (!response || !response.data || !response.data.url) {
                    throw new Error('APIè¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰æ’­æ”¾é“¾æ¥');
                }
                
                // éªŒè¯æ’­æ”¾é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
                const playUrl = response.data.url;
                const isValid = await checkAudioAvailability(playUrl);
                
                if (!isValid) {
                    throw new Error('æ’­æ”¾é“¾æ¥æ— æ•ˆæˆ–å·²å¤±æ•ˆ');
                }
                
                return playUrl;
                
            } catch (error) {
                console.error(`è·å–${source}æ’­æ”¾é“¾æ¥å¤±è´¥:`, error);
                throw error;
            }
        }
        
        // æ£€æŸ¥éŸ³é¢‘é“¾æ¥æ˜¯å¦æœ‰æ•ˆ
        async function checkAudioAvailability(url) {
            return new Promise((resolve) => {
                const audio = new Audio();
                const timeout = setTimeout(() => {
                    audio.src = '';
                    resolve(false);
                }, 10000); // 10ç§’è¶…æ—¶
                
                audio.addEventListener('loadedmetadata', () => {
                    clearTimeout(timeout);
                    audio.src = '';
                    resolve(true);
                });
                
                audio.addEventListener('error', () => {
                    clearTimeout(timeout);
                    audio.src = '';
                    resolve(false);
                });
                
                audio.preload = 'metadata';
                audio.src = url;
            });
        }

        // æ·»åŠ éŸ³ä¹åˆ°æ’­æ”¾åˆ—è¡¨
        async function addMusicToPlaylist(songId, songName, artistName, source, coverUrl) {
            try {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                const exists = musicState.playlist.some(track => 
                    track.name === songName && track.artist === artistName
                );
                
                if (exists) {
                    alert('è¯¥æ­Œæ›²å·²åœ¨æ’­æ”¾åˆ—è¡¨ä¸­');
                    return;
                }

                // è·å–æ’­æ”¾é“¾æ¥
                let playUrl = '';
                try {
                    playUrl = await getMusicPlayUrl(songId, source);
                    if (!playUrl) {
                        throw new Error('æ— æ³•è·å–æ’­æ”¾é“¾æ¥');
                    }
                    
                    // éªŒè¯é“¾æ¥æœ‰æ•ˆæ€§
                    const isValid = await checkMusicAvailability(playUrl);
                    if (!isValid) {
                        throw new Error('æ’­æ”¾é“¾æ¥æ— æ•ˆ');
                    }
                } catch (error) {
                    alert(`è·å–æ’­æ”¾é“¾æ¥å¤±è´¥: ${error.message}`);
                    return;
                }
                
                // æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨ï¼ŒåŒ…å«éŸ³æºä¿¡æ¯å’Œæ’­æ”¾é“¾æ¥
                musicState.playlist.push({
                    id: songId,
                    name: songName,
                    artist: artistName,
                    src: playUrl, // çœŸå®çš„æ’­æ”¾é“¾æ¥
                    cover: coverUrl || 'https://files.catbox.moe/g1dur6.png', // ä¸“è¾‘å°é¢
                    source: source, // éŸ³æºæ ‡è¯†ï¼ˆnetease/tencentï¼‰
                    isLocal: false,
                    isFavorite: false // æ–°å¢æ”¶è—çŠ¶æ€
                });
                
                await saveGlobalPlaylist();
                updatePlaylistUI();
                
                // å¦‚æœå½“å‰æ²¡æœ‰æ’­æ”¾çš„æ­Œæ›²ï¼Œè®¾ç½®ä¸ºç¬¬ä¸€é¦–
                if (musicState.currentIndex === -1 && musicState.playlist.length > 0) {
                    musicState.currentIndex = 0;
                    updatePlayerUI();
                }
                
                const sourceName = source === 'netease' ? 'ç½‘æ˜“äº‘éŸ³ä¹' : 'QQéŸ³ä¹';
                alert(`"${songName} - ${artistName}" å·²ä»${sourceName}æ·»åŠ åˆ°æ’­æ”¾åˆ—è¡¨`);
                
            } catch (error) {
                console.error('æ·»åŠ æ­Œæ›²å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

            showScreen('home-screen');
            
        }
        init();
    });
    </script>
</body>
</html>